<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Meu Guia de Viagens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none !important; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        @media (max-width: 768px) {
            .table-responsive-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .min-w-table { min-width: 800px; }
        }
        .action-cell { width: 1%; white-space: nowrap; }
        .user-trip-item { transition: background-color 0.2s; }
        .user-trip-item:hover { background-color: #f1f5f9; } /* slate-100 */
    </style>
</head>
<body class="bg-slate-200">

    <form id="login-form" class="max-w-sm mx-auto mt-10 sm:mt-20 p-6 sm:p-8 bg-white rounded-lg shadow-lg">
        <h2 class="text-xl sm:text-2xl font-bold mb-6 text-center">Painel Admin - Login</h2>
        <div class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-slate-600">Email</label>
                <input type="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-base" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-slate-600">Senha</label>
                <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-base" required>
            </div>
            <button id="login-btn" type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Entrar</button>
        </div>
    </form>

    <div id="admin-panel" class="hidden max-w-7xl mx-auto p-4 sm:p-8">
        <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 sm:mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-2 sm:mb-0">Painel de Admin</h1>
            <div class="flex items-center gap-3 sm:gap-4">
                <span id="admin-email" class="text-sm sm:text-base text-slate-600 truncate"></span>
                <button id="logout-btn" class="px-3 py-1.5 sm:px-4 sm:py-2 text-sm sm:text-base bg-red-600 text-white font-semibold rounded-md hover:bg-red-700">Sair</button>
            </div>
        </header>

        <main class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <h2 class="text-xl sm:text-2xl font-semibold text-slate-800 mb-4">Gerenciamento de Usuários</h2>
            <div class="mb-4">
                <label for="search-user" class="block text-sm font-medium text-slate-600">Filtrar por nome ou e-mail</label>
                <input type="text" id="search-user" class="mt-1 block w-full md:w-1/2 px-3 py-2 bg-white border border-slate-300 rounded-md text-base" placeholder="Digite para buscar...">
            </div>
            <div class="table-responsive-wrapper border rounded-lg overflow-hidden">
                <table class="min-w-full min-w-table divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th scope="col" class="action-cell px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Editar</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Nome</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Email</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">UID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Plano</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Expira em</th>
                            <th scope="col" class="action-cell px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase">Excluir</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="bg-white divide-y divide-slate-200">
                        </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="edit-license-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg m-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl sm:text-2xl font-semibold mb-2">Editar Licença</h3>
            <p class="mb-6 text-sm sm:text-base text-slate-600">Usuário: <strong id="edit-user-name"></strong></p>

            <form id="edit-license-form" class="space-y-4">
                <input type="hidden" id="edit-user-id">

                <div>
                    <label for="edit-license-type" class="block text-sm font-medium text-slate-600">Tipo de Plano</label>
                    <select id="edit-license-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-base" required>
                        <option value="gratuito">Gratuito</option>
                        <option value="anual">Anual</option>
                        <option value="cortesia">Cortesia</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div id="expires-field" class="hidden">
                    <label for="edit-license-expires" class="block text-sm font-medium text-slate-600">Data de Expiração (Plano Anual)</label>
                    <input type="date" id="edit-license-expires" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-base">
                    <p class="text-xs text-slate-500 mt-1">Sugestão: 1 ano a partir de hoje.</p>
                </div>

                <div class="border-t pt-4">
                    <label class="block text-sm font-medium text-slate-600 mb-2">Viagens Avulsas Compradas</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="edit-purchased-trips" class="flex-grow px-3 py-2 bg-white border border-slate-300 rounded-md text-base" placeholder="Cole o ID da Viagem aqui">
                        <button type="button" id="add-purchased-trip-btn" class="flex-shrink-0 px-3 py-2 bg-green-600 text-white text-sm font-semibold rounded hover:bg-green-700">Add</button>
                    </div>
                    <div id="purchased-trips-list" class="mt-2 space-y-1 text-sm max-h-24 overflow-y-auto border p-2 rounded bg-slate-50">
                        {/* Lista de viagens avulsas adicionadas */}
                    </div>

                    <!--* Botão e container para listar viagens do usuário -->
                    <button type="button" id="list-user-trips-btn" class="mt-3 w-full sm:w-auto px-4 py-2 bg-indigo-100 text-indigo-700 text-sm font-semibold rounded hover:bg-indigo-200 transition-colors">
                        Listar Viagens do Usuário (para copiar ID)
                    </button>
                    <div id="user-trips-list-container" class="hidden mt-2 border rounded bg-slate-50 p-3 max-h-40 overflow-y-auto">
                        {/* Lista de viagens do usuário será inserida aqui */}
                    </div>
                </div>

                <div class="pt-6 flex flex-col sm:flex-row justify-end gap-3 border-t">
                    <button type="button" onclick="closeModal('edit-license-modal')" class="w-full sm:w-auto px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Salvar Licença</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-user-delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg m-4">
            <h3 class="text-lg sm:text-xl font-semibold mb-4 text-red-700">Confirmar Exclusão de Dados</h3>
            <p class="text-sm sm:text-base text-slate-600 mb-2">Excluir permanentemente todos os dados do usuário:</p>
            <p class="mb-1"><strong id="delete-user-name" class="text-slate-800 break-words"></strong></p>
            <p class="mb-6 text-xs sm:text-sm text-slate-500 break-words" id="delete-user-email"></p>
            <p class="text-xs sm:text-sm text-red-600 bg-red-50 p-3 rounded border border-red-200">
                <strong>Atenção:</strong> Ação irreversível. Apagará todos os dados no banco de dados. Exclua a conta no Firebase Authentication manualmente depois.
            </p>
            <input type="hidden" id="delete-user-uid">
            <div class="pt-6 flex flex-col sm:flex-row justify-end gap-3">
                <button type="button" onclick="closeModal('confirm-user-delete-modal')" class="w-full sm:w-auto px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                <button id="confirm-user-delete-btn" onclick="executeUserDeletion()" class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors font-semibold">Excluir Dados</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, get, update, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
             apiKey: "AIzaSyD1IYYMSYXBqfgvUQrp8DaX4Z5n7-4Wryw",
            authDomain: "viagensappoficial.firebaseapp.com",
            databaseURL: "https://viagensappoficial-default-rtdb.firebaseio.com",
            projectId: "viagensappoficial",
            storageBucket: "viagensappoficial.firebasestorage.app",
            messagingSenderId: "344833861467",
            appId: "1:344833861467:web:4fcd794a653fefcb68dc7e",
            measurementId: "G-TN6TN0X5WR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const loginView = document.getElementById('login-form');
        const adminView = document.getElementById('admin-panel');
        const usersTableBody = document.getElementById('users-table-body');
        const searchInput = document.getElementById('search-user');
        let allUsersData = [];
        let currentEditingUid = null;
        let tempPurchasedTrips = {};

        // --- 1. CONTROLE DE AUTENTICAÇÃO ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário logado - verifica se é admin
                checkAdminStatus(user);
            } else {
                // Usuário deslogado - mostra tela de login
                loginView.classList.remove('hidden');
                adminView.classList.add('hidden');
            }
        });

        async function checkAdminStatus(user) {
            const licenseRef = ref(db, `users/${user.uid}/license`);
            try {
                const snapshot = await get(licenseRef);
                // Verifica se o nó 'license' existe e se 'type' é 'admin'
                if (snapshot.exists() && snapshot.val().type === 'admin') {
                    // É admin: esconde login, mostra painel, carrega dados
                    loginView.classList.add('hidden');
                    adminView.classList.remove('hidden');
                    document.getElementById('admin-email').textContent = user.email; // Mostra email do admin logado
                    loadAllUsers(); // Carrega a lista de usuários
                } else {
                    // Não é admin: Acesso negado e desloga
                    alert("Acesso negado. Privilégios de administrador necessários.");
                    signOut(auth);
                }
            } catch (error) {
                // Erro ao verificar permissões
                console.error("Erro ao verificar status de admin:", error);
                alert("Erro ao verificar permissões. Tente novamente.");
                signOut(auth); // Desloga por segurança
            }
        }

        // --- 2. LÓGICA DE LOGIN/LOGOUT ---
        loginView.addEventListener('submit', (e) => {
            e.preventDefault(); // Impede recarregamento da página
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            // Validação simples
            if (!email || !password) {
                alert("Por favor, preencha e-mail e senha.");
                return;
            }

            // Tenta fazer login com Firebase Auth
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Login bem-sucedido é tratado pelo onAuthStateChanged
                    console.log("Login successful for:", userCredential.user.email);
                })
                .catch((error) => {
                    // Erro no login
                    console.error("Erro no login:", error.code, error.message);
                    // Fornece feedback mais específico se possível
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                         alert("E-mail ou senha inválidos.");
                    } else if (error.code === 'auth/invalid-email') {
                         alert("Formato de e-mail inválido.");
                    } else {
                         alert("Falha no login. Verifique os dados ou tente mais tarde.");
                    }
                });
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
             signOut(auth).catch(error => console.error("Erro ao deslogar:", error));
        });

        // --- 3. LÓGICA DO PAINEL ADMIN ---
        async function loadAllUsers() {
            const usersRef = ref(db, 'users');
            // Usa onValue para manter a lista atualizada em tempo real
            onValue(usersRef, (snapshot) => {
                const colspanValue = 7; // Número total de colunas na tabela
                if (!snapshot.exists()) {
                    // Se não houver usuários no DB
                    usersTableBody.innerHTML = `<tr><td colspan="${colspanValue}" class="px-6 py-4 text-center text-slate-500">Nenhum usuário cadastrado.</td></tr>`;
                    allUsersData = []; // Limpa o cache local
                    return;
                }

                // Processa os dados dos usuários
                allUsersData = [];
                snapshot.forEach(userSnapshot => {
                    const uid = userSnapshot.key;
                    const profile = userSnapshot.child('profile').val() || {}; // Pega o perfil ou objeto vazio
                    const license = userSnapshot.child('license').val() || { type: 'gratuito' }; // Pega licença ou default
                    allUsersData.push({
                        uid,
                        name: profile.fullName || "Sem nome", // Nome do perfil ou default
                        email: profile.email || "Sem email", // Email do perfil ou default
                        licenseType: license.type || 'gratuito', // Tipo de licença ou default
                        expires: license.expires ? new Date(license.expires).toLocaleDateString('pt-BR') : 'N/A', // Data formatada ou N/A
                        licenseData: license // Guarda dados completos da licença
                    });
                });
                // Ordena alfabeticamente pelo nome para consistência
                allUsersData.sort((a, b) => a.name.localeCompare(b.name));
                renderUsersTable(allUsersData); // Desenha a tabela com os dados
            }, (error) => {
                // Trata erro ao carregar usuários
                console.error("Erro ao carregar lista de usuários:", error);
                usersTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Erro ao carregar usuários.</td></tr>`;
            });
        }

        function renderUsersTable(users) {
            usersTableBody.innerHTML = ''; // Limpa tabela antes de redesenhar
            const colspanValue = 7;
            if (users.length === 0) {
                // Mensagem se a lista (ou filtro) estiver vazia
                usersTableBody.innerHTML = `<tr><td colspan="${colspanValue}" class="px-6 py-4 text-center text-slate-500">Nenhum usuário encontrado.</td></tr>`;
                return;
            }

            // Cria uma linha (tr) para cada usuário
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50'; // Efeito visual ao passar o mouse
                // Define o HTML interno da linha com os dados do usuário e botões
                tr.innerHTML = `
                    <td class="action-cell px-6 py-4 whitespace-nowrap text-left text-sm font-medium">
                        <button onclick="openEditModal('${user.uid}')" class="text-blue-600 hover:text-blue-900" title="Editar Licença">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${user.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-slate-400 font-mono" title="${user.uid}">${user.uid.substring(0, 10)}...</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${user.licenseType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${user.expires}</td>
                    <td class="action-cell px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="confirmUserDeletion('${user.uid}', '${user.name.replace(/'/g, "\\'")}', '${user.email.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-900" title="Excluir Dados">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </td>`;
                usersTableBody.appendChild(tr); // Adiciona a linha à tabela
            });
        }

        // Filtro de busca na tabela
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim(); // Pega o termo de busca
            // Filtra o cache local de usuários
            const filteredUsers = allUsersData.filter(user =>
                user.name.toLowerCase().includes(query) ||
                user.email.toLowerCase().includes(query) ||
                user.uid.toLowerCase().includes(query) // Adicionado filtro por UID
            );
            renderUsersTable(filteredUsers); // Redesenha a tabela com os resultados filtrados
        });

        // --- 4. LÓGICA DO MODAL DE EDIÇÃO ---

        // Abre o modal para editar a licença de um usuário
        window.openEditModal = (uid) => {
            currentEditingUid = uid; // Guarda o UID do usuário que está sendo editado
            const user = allUsersData.find(u => u.uid === uid); // Encontra os dados do usuário no cache
            if (!user) { console.error("Usuário não encontrado no cache:", uid); return; } // Segurança

            // Preenche os campos do modal com os dados atuais
            document.getElementById('edit-user-id').value = uid;
            document.getElementById('edit-user-name').textContent = `${user.name} (${user.email})`;
            document.getElementById('edit-license-type').value = user.licenseData.type || 'gratuito'; // Usa 'gratuito' se não houver tipo definido
            const expiresInput = document.getElementById('edit-license-expires');
            // Formata a data de expiração para o input type="date" (YYYY-MM-DD)
            expiresInput.value = user.licenseData.expires ? new Date(user.licenseData.expires).toISOString().split('T')[0] : '';

            toggleExpiresField(); // Mostra/esconde campo de data e sugere data se necessário

            // Prepara a lista de viagens avulsas
            tempPurchasedTrips = user.licenseData.purchasedTrips || {}; // Pega viagens ou objeto vazio
            renderPurchasedTripsList(); // Desenha a lista de viagens avulsas

            // Limpa e esconde a lista de viagens do usuário antes de abrir
            const userTripsContainer = document.getElementById('user-trips-list-container');
            userTripsContainer.innerHTML = '<p class="text-xs text-slate-400 text-center">Clique em "Listar Viagens" para buscar.</p>';
            userTripsContainer.classList.add('hidden');

            openModal('edit-license-modal'); // Abre o modal
        }

        // Calcula a data daqui a um ano no formato YYYY-MM-DD
        function getOneYearFromNowDateString() {
            const today = new Date();
            today.setFullYear(today.getFullYear() + 1); // Adiciona 1 ano
            return today.toISOString().split('T')[0]; // Formata
        }

        // Controla a visibilidade do campo de data de expiração e sugere data
        document.getElementById('edit-license-type').addEventListener('change', toggleExpiresField);
        function toggleExpiresField() {
            const typeSelect = document.getElementById('edit-license-type');
            const expiresField = document.getElementById('expires-field');
            const expiresInput = document.getElementById('edit-license-expires');
            const isAnual = typeSelect.value === 'anual'; // Verifica se o plano é anual

            expiresField.classList.toggle('hidden', !isAnual); // Mostra/esconde o campo

            // Se for anual E o campo de data estiver vazio, preenche com a sugestão
            if (isAnual && !expiresInput.value) {
                expiresInput.value = getOneYearFromNowDateString();
            }
        }

        // Desenha a lista de IDs de viagens avulsas já adicionadas
        function renderPurchasedTripsList() {
            const listContainer = document.getElementById('purchased-trips-list');
            listContainer.innerHTML = ''; // Limpa a lista
            const tripIds = Object.keys(tempPurchasedTrips); // Pega os IDs

            if (tripIds.length === 0) {
                listContainer.innerHTML = '<p class="text-slate-400 text-xs">Nenhuma viagem avulsa adicionada.</p>';
                return;
            }

            // Cria um item para cada ID de viagem avulsa
            tripIds.forEach(tripId => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-slate-100 p-2 rounded text-xs';
                item.innerHTML = `
                    <span class="truncate" title="${tripId}">${tripId}</span>
                    <button type="button" class="text-red-500 font-bold ml-2 flex-shrink-0" data-tripid="${tripId}">&times;</button>`;
                // Adiciona evento para o botão de remover
                item.querySelector('button').addEventListener('click', () => removePurchasedTrip(tripId));
                listContainer.appendChild(item);
            });
        }

        // Adiciona um ID de viagem avulsa à lista temporária
        document.getElementById('add-purchased-trip-btn').addEventListener('click', () => {
            const input = document.getElementById('edit-purchased-trips');
            const tripId = input.value.trim(); // Pega e limpa o ID do input
            if (tripId) {
                tempPurchasedTrips[tripId] = true; // Adiciona ao objeto temporário
                input.value = ''; // Limpa o input
                renderPurchasedTripsList(); // Redesenha a lista
            }
        });

        // Remove um ID de viagem avulsa da lista temporária
        function removePurchasedTrip(tripId) {
            delete tempPurchasedTrips[tripId]; // Remove do objeto temporário
            renderPurchasedTripsList(); // Redesenha a lista
        }

        // Salva as alterações da licença no Firebase
        document.getElementById('edit-license-form').addEventListener('submit', async (e) => {
            e.preventDefault(); // Impede envio padrão do formulário
            const uid = document.getElementById('edit-user-id').value;
            const type = document.getElementById('edit-license-type').value;
            const expiresDateStr = document.getElementById('edit-license-expires').value;
            let expiresTimestamp = null; // Timestamp de expiração (null se não aplicável)

            // Converte a data para timestamp se for plano anual e houver data
            if (type === 'anual' && expiresDateStr) {
                // Pega a data no final do dia em UTC para evitar problemas de fuso
                expiresTimestamp = new Date(expiresDateStr + 'T23:59:59Z').getTime();
            } else if (type === 'anual' && !expiresDateStr) {
                // Validação: Plano anual precisa de data
                alert("Plano Anual exige uma data de expiração.");
                return;
            }

            // Monta o objeto com os dados da licença a serem salvos
            const newLicenseData = {
                type: type,
                expires: expiresTimestamp,
                purchasedTrips: tempPurchasedTrips // Usa a lista temporária atualizada
            };

            // Tenta salvar no Firebase
            try {
                const licenseRef = ref(db, `users/${uid}/license`); // Referência do nó da licença
                await set(licenseRef, newLicenseData); // Salva os dados
                alert("Licença atualizada com sucesso!");
                closeModal('edit-license-modal'); // Fecha o modal
            } catch (error) {
                // Trata erro ao salvar
                console.error("Erro ao salvar licença:", error);
                alert("Falha ao salvar a licença. Verifique o console para detalhes.");
            }
        });

        // --- 4.1 LÓGICA PARA LISTAR VIAGENS DO USUÁRIO (ATUALIZADA) ---

        // --- 4.1 LÓGICA PARA LISTAR VIAGENS DO USUÁRIO (ATUALIZADA COM ORDENAÇÃO) ---

        // --- 4.1 LÓGICA PARA LISTAR VIAGENS DO USUÁRIO (ATUALIZADA COM ORDENAÇÃO E DATA) ---

        async function listUserTrips() {
            if (!currentEditingUid) {
                console.warn("Nenhum UID de usuário selecionado para buscar viagens.");
                return;
            }

            const listContainer = document.getElementById('user-trips-list-container');
            listContainer.innerHTML = '<p class="text-xs text-slate-400 text-center animate-pulse">Buscando viagens...</p>';
            listContainer.classList.remove('hidden');

            try {
                // --- Passo 1: Obter os IDs das Viagens ---
                const memberOfRef = ref(db, `users/${currentEditingUid}/memberOf`);
                const memberOfSnapshot = await get(memberOfRef);

                let tripIds = [];
                if (memberOfSnapshot.exists()) {
                    tripIds = Object.keys(memberOfSnapshot.val());
                } else {
                    // Plano B: Query mais lenta
                    console.log("Nó 'memberOf' não encontrado, tentando query em /trips...");
                    const tripsRef = ref(db, 'trips');
                    const userTripsQuery = query(tripsRef, orderByChild(`members/${currentEditingUid}`), equalTo(true));
                    const tripsSnapshot = await get(userTripsQuery);
                    if (tripsSnapshot.exists()) {
                         tripsSnapshot.forEach(tripSnap => tripIds.push(tripSnap.key));
                    }
                }

                listContainer.innerHTML = ''; 

                if (tripIds.length === 0) {
                    listContainer.innerHTML = '<p class="text-xs text-slate-500 text-center">Nenhuma viagem encontrada para este usuário.</p>';
                    return;
                }

                // --- Passo 2: Buscar Detalhes Completos da Viagem ---
                const tripPromises = tripIds.map(tripId => get(ref(db, `trips/${tripId}`)));
                const tripSnapshots = await Promise.all(tripPromises);

                // --- Passo 3: Processar, Filtrar e Criar Lista para Ordenar ---
                const tripsWithDetails = [];
                tripSnapshots.forEach(tripSnap => {
                    if (tripSnap.exists()) {
                        const tripData = tripSnap.val();
                        const tripId = tripSnap.key;

                        if (tripData.name) {
                            tripsWithDetails.push({
                                id: tripId,
                                name: tripData.name,
                                // Assumindo que o campo de data se chama 'createdAt'
                                createdAt: tripData.timestamp || 0 
                            });
                        }
                    }
                });
                
                // --- Passo 4: Ordenar a Lista ---
                tripsWithDetails.sort((a, b) => b.createdAt - a.createdAt);

                // --- Passo 5: Renderizar a Lista Ordenada (Modificado) ---
                if (tripsWithDetails.length === 0) {
                    listContainer.innerHTML = '<p class="text-xs text-slate-500 text-center">Nenhuma viagem (com nome) encontrada.</p>';
                    return;
                }

                // Itera sobre a lista JÁ ORDENADA e cria os elementos
                tripsWithDetails.forEach(trip => {
                    // *** INÍCIO DA MODIFICAÇÃO ***
                    // Formata a data de criação, se ela existir (não for 0)
                    const createdAtDate = trip.createdAt 
                        ? new Date(trip.createdAt).toLocaleDateString('pt-BR') 
                        : 'Data N/A'; // Texto para caso a data seja 0

                    const tripElement = document.createElement('div');
                    tripElement.className = 'user-trip-item flex justify-between items-center p-2 rounded';
                    // Adicionamos a linha com a data formatada
                    tripElement.innerHTML = `
                        <div>
                            <p class="text-sm font-medium text-slate-700 truncate" title="${trip.name}">${trip.name}</p>
                            <p class="text-xs text-slate-500 font-mono">${trip.id}</p>
                            <p class="text-xs text-slate-400">${createdAtDate}</p>
                        </div>
                        <button type="button" onclick="copyTripId('${trip.id}', this)" class="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded hover:bg-slate-300">Copiar ID</button>
                    `;
                    // *** FIM DA MODIFICAÇÃO ***
                    listContainer.appendChild(tripElement);
                });

            } catch (error) {
                console.error("Erro ao buscar viagens do usuário:", error);
                listContainer.innerHTML = '<p class="text-xs text-red-500 text-center">Erro ao buscar viagens. Verifique as permissões.</p>';
            }
        }

        // Adiciona o listener ao botão "Listar Viagens"
        document.getElementById('list-user-trips-btn').addEventListener('click', listUserTrips);

        // Função para copiar ID para a área de transferência
        window.copyTripId = (tripId, buttonElement) => {
            navigator.clipboard.writeText(tripId).then(() => {
                // Feedback visual de sucesso
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'Copiado!';
                buttonElement.classList.add('bg-green-200', 'text-green-800');
                // Volta ao normal após um tempo
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('bg-green-200', 'text-green-800');
                }, 1500);
            }).catch(err => {
                // Tratamento de erro ao copiar
                console.error('Erro ao copiar ID:', err);
                alert('Falha ao copiar ID. Verifique permissões do navegador.');
            });
        }


        // --- 5. FUNÇÕES DE EXCLUSÃO DE USUÁRIO (DATABASE ONLY) ---
        window.confirmUserDeletion = (uid, name, email) => {
            document.getElementById('delete-user-uid').value = uid;
            document.getElementById('delete-user-name').textContent = name;
            document.getElementById('delete-user-email').textContent = email;
            openModal('confirm-user-delete-modal');
        }

        window.executeUserDeletion = async () => {
            const uidToDelete = document.getElementById('delete-user-uid').value;
            if (!uidToDelete) return; // Segurança

            const userDbRef = ref(db, `users/${uidToDelete}`); // Referência do nó do usuário no DB

            try {
                console.log(`Excluindo dados de ${uidToDelete} do Realtime Database...`);
                await remove(userDbRef); // Executa a exclusão

                // Tenta limpar o índice emailToUid (melhor esforço)
                try {
                    const emailToUidRef = ref(db, "emailToUid");
                    // Busca pela chave (email codificado) que tem o UID como valor
                    const snapshot = await get(query(emailToUidRef, orderByValue(), equalTo(uidToDelete)));
                    if (snapshot.exists()) {
                       const updates = {};
                       // Marca as chaves encontradas para exclusão
                       snapshot.forEach(childSnapshot => { updates[childSnapshot.key] = null; });
                       await update(emailToUidRef, updates); // Executa a exclusão no índice
                       console.log(`Índice emailToUid limpo para ${uidToDelete}.`);
                    }
                } catch (emailError) {
                    // Apenas avisa se a limpeza do índice falhar
                    console.warn("Aviso: Falha ao tentar limpar o índice emailToUid automaticamente.", emailError);
                }

                alert('Dados do usuário excluídos com sucesso do Realtime Database!\n\nLembre-se de excluir a conta manualmente no Firebase Authentication.');
                closeModal('confirm-user-delete-modal'); // Fecha o modal de confirmação
                // O onValue em loadAllUsers atualizará a tabela automaticamente.

            } catch (error) {
                // Trata erro na exclusão principal do DB
                console.error("Erro ao excluir dados do usuário no Realtime Database:", error);
                alert(`Falha ao excluir os dados do usuário: ${error.message}\nVerifique as regras de segurança e o console.`);
                closeModal('confirm-user-delete-modal');
            }
        }


        // --- 6. FUNÇÕES UTILITÁRIAS DE MODAL ---
        window.openModal = (id) => {
             const modal = document.getElementById(id);
             if(modal) modal.classList.replace('hidden', 'flex'); // Mostra o modal
        }

        window.closeModal = (id) => {
             const modalElement = document.getElementById(id);
             if (modalElement) {
                 modalElement.classList.replace('flex', 'hidden'); // Esconde o modal
                 const form = modalElement.querySelector('form');
                 if (form) form.reset(); // Reseta o formulário se houver um

                 // Limpezas específicas ao fechar cada modal
                 if (id === 'edit-license-modal') {
                     tempPurchasedTrips = {}; // Limpa viagens avulsas temporárias
                     const purchasedList = document.getElementById('purchased-trips-list');
                     if(purchasedList) purchasedList.innerHTML = ''; // Limpa lista visual
                     const expiresInput = document.getElementById('edit-license-expires');
                     if(expiresInput) expiresInput.value = ''; // Limpa data
                     // Limpa e esconde a lista de viagens do usuário
                     const userTripsContainer = document.getElementById('user-trips-list-container');
                     if (userTripsContainer) {
                         userTripsContainer.innerHTML = '';
                         userTripsContainer.classList.add('hidden');
                     }
                     currentEditingUid = null; // Limpa UID em edição
                 }
                 // Limpa o UID no modal de exclusão
                 const deleteUidInput = document.getElementById('delete-user-uid');
                 if (id === 'confirm-user-delete-modal' && deleteUidInput) {
                      deleteUidInput.value = '';
                 }
             }
        }

    </script>

</body>
</html>
