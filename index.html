<!DOCTYPE html>
<html lang="pt-BR"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="icon" href="favicon.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Guia de Viagens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    
    <style>

/* --- ESTILOS PARA SUGESTÕES DE VIAJANTES --- */
        .suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .suggestion-item:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        .suggestion-item .suggestion-name {
            font-weight: 500;
            color: #1e293b; /* slate-800 */
        }
        .suggestion-item .suggestion-email {
            font-size: 0.75rem;
            color: #64748b; /* slate-500 */
        }

        #app:has(#details-view:not(.hidden)) #trips-view {
            display: none !important;
        }

        .hidden {
            display: none !important;
        }

/* --- ESTILOS PARA O BOTÃO VOLTAR AO TOPO ---  https://meuguiadeviagens.github.io/viagensapp_pro */
        #back-to-top-btn {
            transition: opacity 0.3s, transform 0.3s;
        }

#view-note-description {
      white-space: pre-line;
}
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .trip-card-action-button {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .trip-card:hover .trip-card-action-button {
            opacity: 1;
        }
        .icon-picker-option {
            transition: all 0.2s ease-in-out;
        }
        .icon-picker-option.selected {
            border-color: #3b82f6;
            background-color: #dbeafe;
            transform: scale(1.1);
        }
        #documents-content, #spending-content, #notes-content {
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, margin 0.5s ease-in-out, padding 0.5s ease-in-out;
            max-height: 1000px;
            opacity: 1;
        }
        #add-expense-panel.collapsed #add-expense-content, /* Adicione esta linha */
        #documents-panel.collapsed #documents-content,
        #spending-panel.collapsed #spending-content,
        #notes-panel.collapsed #notes-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            margin-top: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
        #documents-toggle-btn svg, #spending-toggle-btn svg, #notes-toggle-btn svg {
            transition: transform 0.3s ease-in-out;
        }
        #add-expense-panel.collapsed .panel-toggle-btn svg, /* Adicione esta linha */
        #documents-panel.collapsed #documents-toggle-btn svg,
        #spending-panel.collapsed #spending-toggle-btn svg,
        #notes-panel.collapsed #notes-toggle-btn svg {
            transform: rotate(180deg);
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .status-dot:hover {
            transform: scale(1.2);
        }
        #details-header {
            position: relative;
            background-size: cover;
            background-position: center;
            border-radius: 1rem;
            padding: 2rem;
            overflow: hidden;
            isolation: isolate;
        }
        #details-header::after {
            content: '';
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: -1;
        }

        /* --- ESTILOS ATUALIZADOS PARA O MODO DE REORGANIZAÇÃO --- */

        /* Estilos para o seletor de modo de reorganização */
        .reorg-mode-btn {
            transition: all 0.2s ease-in-out;
        }
        .reorg-mode-btn.active {
            background-color: #ffffff;
            color: #1e293b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Controle de visibilidade dos handles de arrastar */
        .drag-handle, .activity-drag-handle {
            display: none; /* Escondidos por padrão */
            cursor: grab;
            color: #94a3b8;
        }
        /* Mostra o handle do DIA apenas no modo de dias */
        #daily-itinerary-list.is-reorganizing.mode-days .drag-handle {
            display: block;
        }
        /* Mostra o handle da ATIVIDADE apenas no modo de atividades */
        #daily-itinerary-list.is-reorganizing.mode-activities .activity-item[data-iseditable="true"] .activity-drag-handle {
            display: block;
        }
        
        #daily-itinerary-list.is-reorganizing .add-activity-btn {
            display: none; /* Esconde o botão de adicionar atividade */
        }
        .delete-day-btn {
            display: none; /* Escondido por padrão */
        }
        #daily-itinerary-list.is-reorganizing.mode-days .delete-day-btn {
            display: flex; /* Visível no modo de reorganização de DIAS */
        }
        .day-panel.sortable-ghost {
            background: #dbeafe;
            opacity: 0.8;
            border: 2px dashed #3b82f6;
        }
        .activity-item.sortable-ghost {
            background: #dbeafe !important;
            opacity: 0.8;
            border: 2px dashed #3b82f6;
        }
        .activity-item.sortable-chosen {
            background: #eff6ff !important;
        }
        .insertion-point {
            display: none; /* Escondido por padrão */
            padding: 8px;
            margin-bottom: 1.5rem;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            color: #475569;
            transition: all 0.2s ease-in-out;
        }
        .insertion-point:hover {
            background-color: #e0e7ff;
            border-color: #a5b4fc;
            color: #3730a3;
        }
        #daily-itinerary-list.is-reorganizing.mode-days .insertion-point {
            display: flex; /* Visível no modo de reorganização de DIAS */
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* --- ESTILOS PARA O DROPDOWN DE SUGESTÕES --- */
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #cbd5e1;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 150px;
            overflow-y: auto;
        }
        .autocomplete-suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
        }
        .autocomplete-suggestion-item:hover {
            background-color: #f1f5f9;
        }

        .paid-transaction {
            text-decoration: line-through;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <form id="login-form" class="max-w-sm mx-auto mt-20 p-8 bg-white rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-6 text-center">Meu Guia de Viagens</h2>
        <div class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-slate-600">Email</label>
                <input type="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-slate-600">Senha</label>
                <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md" required>
            </div>
            <div class="flex flex-col gap-3 pt-2">
                <button id="login-btn" type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Entrar</button>
                <button id="signup-btn" type="button" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Criar Conta</button>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="button" onclick="promptForPasswordReset()" class="text-sm text-blue-600 hover:underline">
                Esqueci minha senha
            </button>
        </div>

    </form>

            <!-- Início: Novos Modais para Troca de Senha -->

        <div id="reauth-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
            <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
                <h3 class="text-xl font-semibold mb-4">Verificação de Segurança</h3>
                <p class="text-slate-600 mb-6">Para continuar, por favor, insira sua senha atual.</p>
                <form id="reauth-form">
                    <div>
                        <label for="current-password" class="block text-sm font-medium text-slate-600">Sua Senha Atual</label>
                        <input type="password" id="current-password" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                    </div>
                    <div class="pt-6 flex justify-end gap-3">
                        <button type="button" onclick="closeModal('reauth-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Verificar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="change-password-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
            <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
                <h3 class="text-xl font-semibold mb-4">Definir Nova Senha</h3>
                <form id="change-password-form" class="space-y-4">
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-slate-600">Nova Senha (mínimo 6 caracteres)</label>
                        <input type="password" id="new-password" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="confirm-new-password" class="block text-sm font-medium text-slate-600">Confirme a Nova Senha</label>
                        <input type="password" id="confirm-new-password" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                    </div>
                    <div class="pt-6 flex justify-end gap-3">
                        <button type="button" onclick="closeModal('change-password-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Salvar Nova Senha</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Fim: Novos Modais para Troca de Senha -->

    <div id="signup-view" class="hidden max-w-lg mx-auto mt-12 mb-12 p-8 bg-white rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-6 text-center">Crie sua Conta</h2>
        
        <form id="signup-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-slate-600">E-mail</label>
                    <input type="email" id="signup-email" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-slate-600">Senha (mínimo 6 caracteres)</label>
                    <input type="password" id="signup-password" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
            </div>

            <div class="border-t pt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="signup-fullname" class="block text-sm font-medium text-slate-600">Nome completo</label>
                    <input type="text" id="signup-fullname" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
                <div>
                    <label for="signup-birthdate" class="block text-sm font-medium text-slate-600">Data de Nascimento</label>
                    <input type="date" id="signup-birthdate" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="signup-cpf" class="block text-sm font-medium text-slate-600">CPF</label>
                    <input type="text" id="signup-cpf" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
                <div>
                    <label for="signup-passport" class="block text-sm font-medium text-slate-600">Passaporte (Opcional)</label>
                    <input type="text" id="signup-passport" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="signup-country" class="block text-sm font-medium text-slate-600">País de residência</label>
                    <input type="text" id="signup-country" value="Brasil" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
                <div>
                    <label for="signup-city" class="block text-sm font-medium text-slate-600">Cidade/UF de residência</label>
                    <input type="text" id="signup-city" placeholder="Ex: São Paulo/SP" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
            </div>
            <div>
                <label for="signup-phone" class="block text-sm font-medium text-slate-600">Telefone</label>
                <input type="tel" id="signup-phone" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
            </div>
            <div class="flex flex-col md:flex-row justify-end gap-3 pt-4">
                <button id="cancel-signup-btn" type="button" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Voltar</button>
                <button id="confirm-signup-btn" type="submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Finalizar Cadastro</button>
            </div>
        </form>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8 hidden">

        <div id="trips-view">
            <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-slate-900"><img src="logo_meuguiadeviagens.png"></h1>
                    <p class="text-slate-500 mt-1"></p>
                </div>
                <div class="flex items-center gap-4 mt-4 sm:mt-0">
                    <button onclick="openModal('add-trip-modal')" class="flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="8" y2="16"></line><line x1="8" x2="16" y1="12" y2="12"></line></svg>
                        <span>Nova Viagem</span>
                    </button>

                    <div class="relative" id="user-menu-container">
                        <button id="user-menu-btn" class="relative flex items-center gap-2 bg-slate-200 text-slate-700 font-semibold px-4 py-3 rounded-lg hover:bg-slate-300 transition-colors">
                            <span id="user-menu-name">Carregando...</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
                            <span id="notification-badge" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-slate-200"></span>
                        </button>
                        <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                            <a href="#" id="edit-profile-btn" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Alterar meus dados</a>
                            <a href="#" onclick="openModal('notifications-modal')" class="flex justify-between items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">
                                <span>Notificações</span>
                                <span id="notification-menu-badge" class="hidden bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full"></span>
                            </a>
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-600 hover:bg-slate-100">Sair</a>
                        </div>
                    </div>
                </div>
            </header>

            <section id="featured-trips-panel" class="mb-10"></section>

            <main>
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Próximas Viagens</h2>
                <div id="upcoming-trips-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>

                <h2 class="text-2xl font-bold text-slate-800 mt-10 mb-4">Viagens já Realizadas</h2>
                <div id="past-trips-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                
                <p class="text-center text-sm text-slate-500 mt-8">v1.0081 | 16/10/2025, 07:11</p>
            </main>
        </div>

        <div id="details-view" class="hidden">
            <header id="details-header" class="mb-8">
                 <button onclick="showTripsView()" class="flex items-center gap-2 text-slate-200 hover:text-white font-medium mb-4 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>
                    Voltar para todas as viagens
                </button>
                <h1 id="details-title" class="text-4xl font-bold text-white"></h1>
                <p id="details-dates" class="text-slate-300 mt-1"></p>
                <div id="details-cities-container" class="mt-4 flex flex-wrap gap-2"></div>
                <div class="flex flex-wrap items-center gap-2 mt-4">
                    <button onclick="openEditTripModal()" class="flex items-center gap-2 text-sm bg-white/20 text-white font-semibold px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>
                        <span>Editar Viagem</span>
                    </button>
                    <button onclick="openModal('index-modal')" class="flex items-center gap-2 text-sm bg-white/20 text-white font-semibold px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-marked"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path><polyline points="10 2 10 10 14 7 18 10 18 2"></polyline></svg>
                        <span>Índice</span>
                    </button>
                    <button onclick="scrollToSectionAndClose('spending-panel', null)" class="flex items-center gap-2 text-sm bg-white/20 text-white font-semibold px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt-text"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"/><path d="M14 8H8"/><path d="M16 12H8"/><path d="M11 16H8"/></svg>
                        <span>Despesas</span>
                    </button>
                    <button onclick="scrollToItinerary()" class="flex items-center gap-2 text-sm bg-white/20 text-white font-semibold px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-collapse"><path d="m3 10 2.5-2.5L3 5"></path><path d="m3 19 2.5-2.5L3 14"></path><path d="M10 6h11"></path><path d="M10 12h11"></path><path d="M10 18h11"></path></svg>
                        <span>Roteiro</span>
                    </button>
                    <button id="custom-link-btn" style="display: none;" class="flex items-center gap-2 text-sm bg-white/20 text-white font-semibold px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                        <span></span> </button>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <section id="flights-section" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Voos</h2>
                        <button onclick="openModal('add-flight-modal')" class="flex items-center justify-center w-10 h-10 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <div id="flights-list" class="space-y-4"></div>
                </section>
                <section id="transport-section" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Transporte</h2>
                        <button onclick="openModal('add-transport-modal')" class="flex items-center justify-center w-10 h-10 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <div id="transport-list" class="space-y-4"></div>
                </section>
                <section id="lodging-section" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <h2 class="text-2xl font-semibold">Hospedagens</h2>
                            <span id="lodging-status-dot" class="status-dot"></span>
                        </div>
                        <button onclick="openModal('add-lodging-modal')" class="flex items-center justify-center w-10 h-10 bg-purple-100 text-purple-600 rounded-full hover:bg-purple-200 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <div id="lodging-list" class="space-y-4"></div>
                </section>
            </main>

            <section id="documents-panel" class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleGenericPanel('documents-panel')">
                    <h2 class="text-2xl font-semibold">Documentos</h2>
                    <button id="documents-toggle-btn" class="text-slate-500 hover:text-slate-800 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up"><path d="m18 15-6-6-6 6"></path></svg>
                    </button>
                </div>
                <div id="documents-content" class="mt-4">
                    <form id="add-document-form" class="flex gap-2 mb-4">
                        <input type="text" id="document-name" placeholder="Ex: Passaporte" class="flex-grow mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                        <button type="submit" class="flex-shrink-0 bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 self-center h-11 mt-1">Adicionar</button>
                    </form>
                    <div id="documents-list" class="space-y-2">
                    </div>
                </div>
            </section>

            <section id="daily-itinerary-panel" class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Roteiro</h2>
                    <div class="flex items-center gap-2">
                        <div id="reorg-actions-container" class="hidden items-center gap-2">
                            <div class="flex items-center gap-1 bg-slate-300 p-1 rounded-lg">
                                <button id="reorg-mode-days-btn" onclick="switchReorganizationType('days')" class="reorg-mode-btn text-xs font-bold px-3 py-1 rounded-md">Dias</button>
                                <button id="reorg-mode-activities-btn" onclick="switchReorganizationType('activities')" class="reorg-mode-btn text-xs font-bold px-3 py-1 rounded-md">Ativid.</button>
                            </div>
                            <button onclick="toggleReorganizationMode(true)" class="text-sm bg-slate-200 text-slate-700 font-semibold px-3 py-1.5 rounded-lg hover:bg-slate-300 transition-colors">Cancelar</button>
                            <button onclick="toggleReorganizationMode(false)" class="text-sm bg-blue-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
                        </div>
                         <button id="reorg-start-btn" onclick="toggleReorganizationMode(false)" class="text-sm bg-slate-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-slate-700 transition-colors">Reordenar</button>
                        
                    </div>
                </div>
                <div id="daily-itinerary-list">
                </div>
            </section>
            
            <section id="notes-panel" class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleNotesPanel()">
                    <h2 class="text-2xl font-semibold">Anotações</h2>
                    <button id="notes-toggle-btn" class="text-slate-500 hover:text-slate-800 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up"><path d="m18 15-6-6-6 6"></path></svg>
                    </button>
                </div>
                <div id="notes-content" class="mt-4">
                    <button onclick="openModal('add-note-modal')" class="w-full flex items-center justify-center gap-2 bg-blue-100 text-blue-700 font-semibold mb-4 px-5 py-3 rounded-lg shadow-sm hover:bg-blue-200 transition-colors duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        <span>Adicionar Anotação</span>
                    </button>
                    <div id="notes-list" class="space-y-2"></div>
                </div>
            </section>

            <section id="spending-panel" class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleSpendingPanel()">
                    <h2 class="text-2xl font-semibold">Gastos Previstos</h2>
                    <button id="spending-toggle-btn" class="text-slate-500 hover:text-slate-800 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up"><path d="m18 15-6-6-6 6"></path></svg>
                    </button>
                </div>
                <div id="spending-content" class="mt-4">
                    <div id="spending-list" class="space-y-4">
                        </div>
                    <div id="spending-total-display" class="mt-4 pt-4 border-t-2 border-slate-200 text-xl font-bold text-slate-900 text-right">
                        </div>
                </div>
            </section>
            <section id="shared-expenses-panel" class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleGenericPanel('shared-expenses-panel')">
                    <h2 class="text-2xl font-semibold">Divisão de Despesas do Grupo</h2>
                    <button class="panel-toggle-btn text-slate-500 hover:text-slate-800 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up"><path d="m18 15-6-6-6 6"></path></svg>
                    </button>
                </div>
                <div class="panel-content mt-4">
    <div id="add-expense-panel" class="bg-slate-50 border border-slate-200 rounded-lg mb-6 collapsed">
        <div class="flex justify-between items-center cursor-pointer p-4" onclick="toggleGenericPanel('add-expense-panel')">
            <h3 class="font-semibold text-lg text-slate-800">Adicionar Nova Despesa</h3>
            <button class="panel-toggle-btn text-slate-500 hover:text-slate-800 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up"><path d="m18 15-6-6-6 6"></path></svg>
            </button>
        </div>
        
        <div id="add-expense-content" class="px-4 pb-4">
            <form id="add-expense-form" class="space-y-4 border-t pt-4">
                <div>
                    <label for="expense-description" class="block text-sm font-medium text-slate-600">Descrição</label>
                    <input type="text" id="expense-description" placeholder="Ex: Jantar de boas-vindas" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-slate-600">Valor Total</label>
                        <input type="number" id="expense-amount" placeholder="150.00" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="expense-currency" class="block text-sm font-medium text-slate-600">Moeda</label>
                        <select id="expense-currency" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required=""></select>
                        <input type="text" id="expense-currency-custom" maxlength="6" placeholder="Ex: ARS" class="hidden mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="expense-payer" class="block text-sm font-medium text-slate-600">Quem Pagou? (Credor)</label>
                        <select id="expense-payer" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required=""></select>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center">
                        <label class="block text-sm font-medium text-slate-600">Quem deve pagar? (Incluir o credor também se for o caso)</label>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="select-all-participants" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="select-all-participants" class="text-sm font-medium text-slate-600 cursor-pointer">Marcar Todos</label>
                        </div>
                    </div>
                    <div id="expense-participants-checkboxes" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2 border p-3 rounded-md bg-white">
                        </div>
                </div>
                <div class="text-right">
                     <button type="submit" class="bg-indigo-600 text-white font-semibold px-5 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Adicionar Despesa</button>
                </div>
            </form>
        </div>
    </div>

    <h4 class="text-lg font-semibold text-slate-800 mb-3">Despesas em grupo adicionadas:</h4>

    <div id="shared-expenses-list" class="space-y-3">
        </div>

    <div class="mt-6 pt-4 border-t flex flex-col items-center gap-3">
        <button onclick="calculateExpenseSummary()" class="w-full max-w-sm bg-blue-600 text-white font-bold px-6 py-3 rounded-lg shadow-lg hover:bg-blue-700 transition-transform hover:scale-105">
            Calcular Resumo Final de Contas
        </button>
        <button onclick="showExpenseExplanation()" class="w-full max-w-sm bg-teal-500 text-white font-bold px-6 py-3 rounded-lg shadow-lg hover:bg-teal-600 transition-transform hover:scale-105">
            Explicar Resumo de Contas
        </button>
        <button onclick="showSpendingPerPerson()" class="w-full max-w-sm bg-orange-500 text-white font-bold px-6 py-3 rounded-lg shadow-lg hover:bg-orange-600 transition-transform hover:scale-105">
            Verificar despesas por pessoa
        </button>
    </div>
</div>
            </section>
        </div>
    </div>

<div id="notifications-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 flex flex-col" style="max-height: 80vh;">
        <h3 class="text-2xl font-semibold mb-4 text-slate-800">Notificações</h3>
        <div id="notifications-list" class="flex-grow overflow-y-auto pr-2 space-y-3">
            </div>
        <div class="pt-6 flex justify-end">
            <button type="button" onclick="closeModal('notifications-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Fechar</button>
        </div>
    </div>
</div>

<div id="index-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
        <h3 class="text-2xl font-semibold mb-6">Índice Rápido</h3>
        <div class="space-y-3">
            <button onclick="scrollToSectionAndClose('flights-section', 'index-modal')" class="w-full text-left p-3 rounded-lg hover:bg-slate-100 transition-colors font-medium">Voos</button>
            <button onclick="scrollToSectionAndClose('transport-section', 'index-modal')" class="w-full text-left p-3 rounded-lg hover:bg-slate-100 transition-colors font-medium">Transporte</button>
            <button onclick="scrollToSectionAndClose('lodging-section', 'index-modal')" class="w-full text-left p-3 rounded-lg hover:bg-slate-100 transition-colors font-medium">Hospedagens</button>
            <button onclick="scrollToSectionAndClose('documents-panel', 'index-modal')" class="w-full text-left p-3 rounded-lg hover:bg-slate-100 transition-colors font-medium">Documentos</button>
            <button onclick="scrollToSectionAndClose('daily-itinerary-panel', 'index-modal')" class="w-full text-left p-3 rounded-lg hover:bg-slate-100 transition-colors font-medium">Roteiro</button>
            <button id="index-btn-notes" onclick="scrollToSectionAndClose('notes-panel', 'index-modal')" class="w-full text-left p-3 rounded-lg hover:bg-slate-100 transition-colors font-medium">Anotações</button>
            <button onclick="scrollToSectionAndClose('spending-panel', 'index-modal')" class="w-full text-left p-3 rounded-lg hover:bg-slate-100 transition-colors font-medium">Divisão de Despesas</button>
        </div>
        <div class="pt-6 flex justify-end">
            <button type="button" onclick="closeModal('index-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Fechar</button>
        </div>
    </div>
</div>

    <div id="add-trip-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <h3 class="text-2xl font-semibold mb-6">Adicionar Nova Viagem</h3>
            <form id="add-trip-form" class="space-y-4">
                <div>
                    <label for="trip-name" class="block text-sm font-medium text-slate-600">Nome da Viagem</label>
                    <input type="text" id="trip-name" placeholder="Ex: Férias na Itália" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="trip-destination" class="block text-sm font-medium text-slate-600">Resumo</label>
                    <input type="text" id="trip-destination" placeholder="Descrição" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label for="trip-start-date" class="block text-sm font-medium text-slate-600">Data de Início</label>
                        <input type="date" id="trip-start-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                    </div>
                    <div class="flex-1">
                        <label for="trip-end-date" class="block text-sm font-medium text-slate-600">Data de Fim</label>
                        <input type="date" id="trip-end-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('add-trip-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Viagem</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-flight-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Adicionar Voo</h3>
            <form id="add-flight-form" class="space-y-4">
                <div>
                    <label for="flight-leg-type" class="block text-sm font-medium text-slate-600">Trecho</label>
                    <select id="flight-leg-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                        <option value="ida">Ida</option>
                        <option value="volta">Volta</option>
                    </select>
                </div>
                <div>
                    <label for="flight-date" class="block text-sm font-medium text-slate-600">Data do Voo</label>
                    <input type="date" id="flight-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="flight-departure-time" class="block text-sm font-medium text-slate-600">Horário de Saída</label>
                        <input type="time" id="flight-departure-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="flight-arrival-time" class="block text-sm font-medium text-slate-600">Horário de Chegada</label>
                        <input type="time" id="flight-arrival-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="flight-origin" class="block text-sm font-medium text-slate-600">Cidade de Origem</label>
                        <input type="text" id="flight-origin" placeholder="Ex: São Paulo (GRU)" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="flight-destination" class="block text-sm font-medium text-slate-600">Cidade de Destino</label>
                        <input type="text" id="flight-destination" placeholder="Ex: Roma (FCO)" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div>
                    <label for="flight-company" class="block text-sm font-medium text-slate-600">Companhia Aérea</label>
                    <input type="text" id="flight-company" placeholder="Ex: LATAM" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="flight-code" class="block text-sm font-medium text-slate-600">Código do Voo (Opcional)</label>
                        <input type="text" id="flight-code" placeholder="Ex: LA8064" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="flight-type" class="block text-sm font-medium text-slate-600">Tipo de Voo</label>
                        <select id="flight-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                            <option>Voo Direto</option>
                            <option>Com Conexão</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="flight-cost" class="block text-sm font-medium text-slate-600">Custo (R$) (Opcional)</label>
                    <input type="number" id="flight-cost" placeholder="Ex: 3500.50" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('add-flight-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Adicionar Voo</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-flight-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Editar Voo</h3>
            <form id="edit-flight-form" class="space-y-4">
                <div>
                    <label for="edit-flight-leg-type" class="block text-sm font-medium text-slate-600">Trecho</label>
                    <select id="edit-flight-leg-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                        <option value="ida">Ida</option>
                        <option value="volta">Volta</option>
                    </select>
                </div>
                <div>
                    <label for="edit-flight-date" class="block text-sm font-medium text-slate-600">Data do Voo</label>
                    <input type="date" id="edit-flight-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-flight-departure-time" class="block text-sm font-medium text-slate-600">Horário de Saída</label>
                        <input type="time" id="edit-flight-departure-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-flight-arrival-time" class="block text-sm font-medium text-slate-600">Horário de Chegada</label>
                        <input type="time" id="edit-flight-arrival-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-flight-origin" class="block text-sm font-medium text-slate-600">Cidade de Origem</label>
                        <input type="text" id="edit-flight-origin" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-flight-destination" class="block text-sm font-medium text-slate-600">Cidade de Destino</label>
                        <input type="text" id="edit-flight-destination" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div>
                    <label for="edit-flight-company" class="block text-sm font-medium text-slate-600">Companhia Aérea</label>
                    <input type="text" id="edit-flight-company" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-flight-code" class="block text-sm font-medium text-slate-600">Código do Voo (Opcional)</label>
                        <input type="text" id="edit-flight-code" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="edit-flight-type" class="block text-sm font-medium text-slate-600">Tipo de Voo</label>
                        <select id="edit-flight-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                            <option>Voo Direto</option>
                            <option>Com Conexão</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="edit-flight-cost" class="block text-sm font-medium text-slate-600">Custo (R$) (Opcional)</label>
                    <input type="number" id="edit-flight-cost" placeholder="Ex: 3500.50" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('edit-flight-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="add-transport-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Adicionar Transporte</h3>
            <form id="add-transport-form" class="space-y-4">
                <div>
                    <label for="transport-type" class="block text-sm font-medium text-slate-600">Tipo de Transporte</label>
                    <select id="transport-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                        <option value="Trem">Trem</option>
                        <option value="Carro Alugado">Carro Alugado</option>
                        <option value="Ônibus">Ônibus</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="transport-departure-date" class="block text-sm font-medium text-slate-600">Data de Embarque/Retirada</label>
                        <input type="date" id="transport-departure-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="transport-departure-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="transport-departure-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="transport-arrival-date" class="block text-sm font-medium text-slate-600">Data de Chegada/Devolução</label>
                        <input type="date" id="transport-arrival-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="transport-arrival-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="transport-arrival-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div>
                    <label for="transport-origin" class="block text-sm font-medium text-slate-600">Origem</label>
                    <input type="text" id="transport-origin" placeholder="Ex: Roma Termini" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="transport-destination" class="block text-sm font-medium text-slate-600">Destino</label>
                    <input type="text" id="transport-destination" placeholder="Ex: Firenze S.M.N." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="transport-description" class="block text-sm font-medium text-slate-600">Descrição (Opcional)</label>
                    <textarea id="transport-description" rows="3" placeholder="Ex: Trem #9418, vagão 5, assentos 21, 22" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label for="transport-cost" class="block text-sm font-medium text-slate-600">Custo (R$) (Opcional)</label>
                    <input type="number" id="transport-cost" placeholder="Ex: 150.00" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('add-transport-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-semibold">Adicionar Transporte</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="add-lodging-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Adicionar Hospedagem</h3>
            <form id="add-lodging-form" class="space-y-4">
                 <div>
                    <label for="lodging-name" class="block text-sm font-medium text-slate-600">Nome do Hotel/Local</label>
                    <input type="text" id="lodging-name" placeholder="Ex: Hotel Coliseu" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="lodging-address" class="block text-sm font-medium text-slate-600">Endereço</label>
                    <input type="text" id="lodging-address" placeholder="Ex: Via Cavour, 123" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="lodging-checkin-date" class="block text-sm font-medium text-slate-600">Data de Check-in</label>
                        <input type="date" id="lodging-checkin-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="lodging-checkin-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="lodging-checkin-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="lodging-checkout-date" class="block text-sm font-medium text-slate-600">Data de Check-out</label>
                        <input type="date" id="lodging-checkout-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="lodging-checkout-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="lodging-checkout-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div>
                    <label for="lodging-cost" class="block text-sm font-medium text-slate-600">Custo Total (R$)</label>
                    <input type="number" id="lodging-cost" placeholder="Ex: 1500" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="lodging-link" class="block text-sm font-medium text-slate-600">Link (Opcional)</label>
                    <input type="url" id="lodging-link" placeholder="https://..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('add-lodging-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors font-semibold">Adicionar Hospedagem</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-transport-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Editar Transporte</h3>
            <form id="edit-transport-form" class="space-y-4">
                <div>
                    <label for="edit-transport-type" class="block text-sm font-medium text-slate-600">Tipo de Transporte</label>
                    <select id="edit-transport-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                        <option value="Trem">Trem</option>
                        <option value="Carro Alugado">Carro Alugado</option>
                        <option value="Ônibus">Ônibus</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-transport-departure-date" class="block text-sm font-medium text-slate-600">Data de Embarque/Retirada</label>
                        <input type="date" id="edit-transport-departure-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-transport-departure-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="edit-transport-departure-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-transport-arrival-date" class="block text-sm font-medium text-slate-600">Data de Chegada/Devolução</label>
                        <input type="date" id="edit-transport-arrival-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-transport-arrival-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="edit-transport-arrival-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div>
                    <label for="edit-transport-origin" class="block text-sm font-medium text-slate-600">Origem</label>
                    <input type="text" id="edit-transport-origin" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="edit-transport-destination" class="block text-sm font-medium text-slate-600">Destino</label>
                    <input type="text" id="edit-transport-destination" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="edit-transport-description" class="block text-sm font-medium text-slate-600">Descrição (Opcional)</label>
                    <textarea id="edit-transport-description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div>
                    <label for="edit-transport-cost" class="block text-sm font-medium text-slate-600">Custo (R$) (Opcional)</label>
                    <input type="number" id="edit-transport-cost" placeholder="Ex: 150.00" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('edit-transport-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-lodging-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Editar Hospedagem</h3>
            <form id="edit-lodging-form" class="space-y-4">
                 <div>
                    <label for="edit-lodging-name" class="block text-sm font-medium text-slate-600">Nome do Hotel/Local</label>
                    <input type="text" id="edit-lodging-name" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div>
                    <label for="edit-lodging-address" class="block text-sm font-medium text-slate-600">Endereço</label>
                    <input type="text" id="edit-lodging-address" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-lodging-checkin-date" class="block text-sm font-medium text-slate-600">Data de Check-in</label>
                        <input type="date" id="edit-lodging-checkin-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-lodging-checkin-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="edit-lodging-checkin-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-lodging-checkout-date" class="block text-sm font-medium text-slate-600">Data de Check-out</label>
                        <input type="date" id="edit-lodging-checkout-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-lodging-checkout-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="edit-lodging-checkout-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div>
                    <label for="edit-lodging-cost" class="block text-sm font-medium text-slate-600">Custo Total (R$)</label>
                    <input type="number" id="edit-lodging-cost" placeholder="Ex: 1500" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="edit-lodging-link" class="block text-sm font-medium text-slate-600">Link (Opcional)</label>
                    <input type="url" id="edit-lodging-link" placeholder="https://..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('edit-lodging-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-trip-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Editar Informações da Viagem</h3>
            <form id="edit-trip-form" class="space-y-4">
                <div>
                    <label for="edit-trip-name" class="block text-sm font-medium text-slate-600">Nome da Viagem</label>
                    <input type="text" id="edit-trip-name" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div>
                    <label for="edit-trip-destination" class="block text-sm font-medium text-slate-600">Resumo</label>
                    <input type="text" id="edit-trip-destination" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div>
                    <label for="edit-trip-image-url" class="block text-sm font-medium text-slate-600">URL da Imagem</label>
                    <input type="url" id="edit-trip-image-url" placeholder="https://exemplo.com/imagem.jpg" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                ...
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label for="edit-trip-start-date" class="block text-sm font-medium text-slate-600">Data de Início</label>
                        <input type="date" id="edit-trip-start-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div class="flex-1">
                        <label for="edit-trip-end-date" class="block text-sm font-medium text-slate-600">Data de Fim</label>
                        <input type="date" id="edit-trip-end-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>

                <div class="border-t pt-4 mt-2">
                    <label class="block text-sm font-medium text-slate-600 mb-2">Gerenciar Viajantes</label>
                    <div id="travelers-list" class="space-y-2 mb-3 max-h-40 overflow-y-auto">
                        </div>
                    <div class="flex items-end gap-2 p-2 bg-slate-50 rounded-md">
                        <div class="flex items-end gap-2 p-2 bg-slate-50 rounded-md relative"> <div class="flex-grow">
                            <label for="traveler-name" class="block text-xs font-medium text-slate-500">Nome</label>
                            <input type="text" id="traveler-name" placeholder="Nome do Viajante" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-sm">
                        </div>
                        <div class="flex-grow">
                            <label for="traveler-email" class="block text-xs font-medium text-slate-500">E-mail</label>
                            <input type="email" id="traveler-email" placeholder="email@exemplo.com" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-sm">
                        </div>
                        <button type="button" onclick="addTraveler()" class="flex-shrink-0 bg-green-600 text-white font-semibold px-4 h-10 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 self-center">Adicionar</button>
                          <div id="traveler-suggestions" class="hidden absolute top-full left-0 right-0 z-10 bg-white border border-slate-300 rounded-md shadow-lg mt-1 max-h-40 overflow-y-auto">
                            </div>
                        </div>
                    </div>
                </div>                
                 <div class="border-t pt-4 mt-2">
                    <label class="block text-sm font-medium text-slate-600 mb-1">Link Personalizado (Opcional)</label>
                    <div>
                        <label for="edit-trip-link-text" class="block text-xs font-medium text-slate-500">Texto do Botão</label>
                        <input type="text" id="edit-trip-link-text" placeholder="Ex: Reservas" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div class="mt-2">
                        <label for="edit-trip-link-url" class="block text-xs font-medium text-slate-500">URL do Link</label>
                        <input type="url" id="edit-trip-link-url" placeholder="https://..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('edit-trip-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
            <h3 class="text-xl font-semibold mb-4">Confirmar Exclusão</h3>
            <p id="confirm-delete-message" class="text-slate-600 mb-6">Você tem certeza que deseja excluir este item?</p>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeModal('confirm-delete-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors font-semibold">Excluir</button>
            </div>
        </div>
    </div>

    <div id="add-activity-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Adicionar Atividade</h3>
            <form id="add-activity-form" class="space-y-4">
                <input type="hidden" id="activity-date">
                <input type="hidden" id="activity-icon" value="passeio">
                <div>
                    <label for="activity-time" class="block text-sm font-medium text-slate-600">Horário</label>
                    <input type="time" id="activity-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                </div>
                 <div>
                    <label for="activity-name" class="block text-sm font-medium text-slate-600">Nome da Atividade</label>
                    <input type="text" id="activity-name" placeholder="Ex: Visita ao Coliseu" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="activity-type" class="block text-sm font-medium text-slate-600">Tipo de Atividade</label>
                    <select id="activity-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                        <option value="Passeio">Passeio</option>
                        <option value="Cidade">Cidade</option>
                        <option value="Restaurante">Restaurante</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="activity-description" class="block text-sm font-medium text-slate-600">Descrição (Opcional)</label>
                    <textarea id="activity-description" rows="3" placeholder="Ex: Tour guiado com acesso ao subterrâneo." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></textarea>
                </div>
                <div>
                    <label for="activity-link" class="block text-sm font-medium text-slate-600">Link (Opcional)</label>
                    <input type="url" id="activity-link" placeholder="https://exemplo.com/passeio" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                 <div>
                    <label for="activity-cost" class="block text-sm font-medium text-slate-600">Custo (R$) (Opcional)</label>
                    <input type="number" id="activity-cost" placeholder="Ex: 50.00" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">Ícone</label>
                    <div id="add-icon-picker" class="mt-2 flex flex-wrap gap-2">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('add-activity-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Atividade</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-activity-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Editar Atividade</h3>
            <form id="edit-activity-form" class="space-y-4">
                <input type="hidden" id="edit-activity-id">
                <input type="hidden" id="edit-activity-icon">
                <div>
                    <label for="edit-activity-time" class="block text-sm font-medium text-slate-600">Horário</label>
                    <input type="time" id="edit-activity-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="edit-activity-name" class="block text-sm font-medium text-slate-600">Nome da Atividade</label>
                    <input type="text" id="edit-activity-name" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="edit-activity-type" class="block text-sm font-medium text-slate-600">Tipo de Atividade</label>
                    <select id="edit-activity-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                        <option value="Passeio">Passeio</option>
                        <option value="Cidade">Cidade</option>
                        <option value="Restaurante">Restaurante</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="edit-activity-description" class="block text-sm font-medium text-slate-600">Descrição (Opcional)</label>
                    <textarea id="edit-activity-description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></textarea>
                </div>
                <div>
                    <label for="edit-activity-link" class="block text-sm font-medium text-slate-600">Link (Opcional)</label>
                    <input type="url" id="edit-activity-link" placeholder="https://exemplo.com/passeio" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="edit-activity-cost" class="block text-sm font-medium text-slate-600">Custo (R$) (Opcional)</label>
                    <input type="number" id="edit-activity-cost" placeholder="Ex: 50.00" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">Ícone</label>
                    <div id="edit-icon-picker" class="mt-2 flex flex-wrap gap-2">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('edit-activity-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="view-activity-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 text-center">
            <div id="view-activity-icon" class="mx-auto mb-4 w-12 h-12 flex items-center justify-center bg-slate-100 text-slate-600 rounded-full">
            </div>
            <h3 id="view-activity-name" class="text-2xl font-semibold text-slate-800"></h3>
            <p id="view-activity-time" class="text-slate-500"></p>
            <p id="view-activity-type" class="text-sm font-medium text-slate-500 bg-slate-100 rounded-full px-3 py-1 mt-2 mb-4 inline-block"></p>
            <p id="view-activity-description" class="text-slate-600 mb-4"></p>
            <div id="view-activity-details-list" class="text-sm text-left space-y-2 border-t pt-4"></div>
            <div class="mt-6 space-y-3">
                <div id="view-activity-search-container" style="display: none;">
                    <button id="view-activity-search-btn" class="inline-flex items-center justify-center gap-2 w-full bg-slate-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-slate-700 transition-colors duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
                        <span>Pesquisar</span>
                    </button>
                </div>
                <div id="view-activity-link-container" style="display: none;">
                     <a id="view-activity-link-btn" href="#" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center gap-2 w-full bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line></svg>
                        <span>Link da Atividade</span>
                    </a>
                </div>
            </div>
            <div class="pt-6 flex justify-center">
                <button type="button" onclick="closeModal('view-activity-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <div id="lodging-coverage-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <div class="flex items-center gap-3 mb-4">
                <span id="lodging-coverage-modal-icon"></span>
                <h3 id="lodging-coverage-modal-title" class="text-xl font-semibold"></h3>
            </div>
            <div id="lodging-coverage-modal-body" class="text-slate-600 text-sm space-y-2"></div>
            <div id="lodging-total-cost-display" class="mt-4 pt-4 border-t border-slate-200 text-base font-semibold text-slate-800"></div>
            <div class="pt-6 flex justify-end">
                <button type="button" onclick="closeModal('lodging-coverage-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Fechar</button>
            </div>
        </div>
    </div>

 <div id="add-note-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4">
            <h3 class="text-2xl font-semibold mb-6">Adicionar Anotação</h3>
            <form id="add-note-form" class="space-y-4">
                <input type="hidden" id="note-icon" value="note_food">
                <div>
                    <label for="note-title" class="block text-sm font-medium text-slate-600">Nome da Anotação</label>
                    <input type="text" id="note-title" placeholder="Ex: Dica de restaurante do amigo" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">Incluído por</label>
                    <p id="note-author-display" class="mt-1 block w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-md text-slate-600"></p>
                </div>
                <div>
                    <label for="note-description" class="block text-sm font-medium text-slate-600">Descrição</label>
                    <textarea id="note-description" rows="3" placeholder="Anotações, detalhes, etc." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></textarea>
                </div>
                <div>
                    <label for="note-link" class="block text-sm font-medium text-slate-600">Link de Referência (Opcional)</label>
                    <input type="url" id="note-link" placeholder="https://..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">Ícone</label>
                    <div id="add-note-icon-picker" class="mt-2 flex flex-wrap gap-2">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('add-note-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Anotação</button>
                </div>
            </form>
        </div>
    </div>

<div id="edit-note-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4">
            <h3 class="text-2xl font-semibold mb-6">Editar Anotação</h3>
            <form id="edit-note-form" class="space-y-4">
                <input type="hidden" id="edit-note-id">
                <input type="hidden" id="edit-note-icon">
                <div>
                    <label for="edit-note-title" class="block text-sm font-medium text-slate-600">Nome da Anotação</label>
                    <input type="text" id="edit-note-title" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                </div>                
                <div>
                    <label for="edit-note-description" class="block text-sm font-medium text-slate-600">Descrição</label>
                    <textarea id="edit-note-description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></textarea>
                </div>
                <div>
                    <label for="edit-note-link" class="block text-sm font-medium text-slate-600">Link de Referência (Opcional)</label>
                    <input type="url" id="edit-note-link" placeholder="https://..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">Ícone</label>
                    <div id="edit-note-icon-picker" class="mt-2 flex flex-wrap gap-2">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('edit-note-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    

    <div id="view-note-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4">
            <h3 id="view-note-title" class="text-2xl font-semibold text-slate-800 mb-1"></h3>
            <p id="view-note-author" class="text-sm text-slate-500 mb-4"></p>
            
            <div id="view-note-description-container" class="text-slate-600 mb-4 p-3 bg-slate-50 rounded-md border">
                <p id="view-note-description"></p>
            </div>
            
            <div id="view-note-link-container" style="display: none;" class="mt-6">
                 <a id="view-note-link-btn" href="#" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center gap-2 w-full bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line></svg>
                    <span>Acessar Link de Referência</span>
                </a>
            </div>
            <div class="pt-6 flex justify-center">
                <button type="button" onclick="closeModal('view-note-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <div id="view-expense-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <h3 id="view-expense-description" class="text-2xl font-semibold text-slate-800 mb-2"></h3>
            <p class="text-lg font-medium text-slate-600 mb-4">Total: <span id="view-expense-amount" class="font-bold text-indigo-600"></span></p>
            <p class="text-sm text-slate-500 mb-4">Pago por: <span id="view-expense-payer" class="font-semibold"></span></p>
            
            <div class="border-t pt-4">
                <h4 class="font-semibold text-slate-700 mb-2">Divisão entre os responsáveis:</h4>
                <div id="view-expense-participants-list" class="space-y-2 text-sm">
                    </div>
            </div>

            <div class="pt-6 flex justify-end">
                <button type="button" onclick="closeModal('view-expense-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Fechar</button>
            </div>
        </div>
    </div>

    <div id="expense-summary-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold text-slate-800 mb-4">Resumo Final de Contas</h3>
            <p class="text-sm text-slate-500 mb-4">Este é o jeito mais simples de acertar as contas. Cada pessoa só precisa fazer um pagamento para quem ela deve.</p>
            <div id="expense-summary-results" class="space-y-3">
                </div>
            <div class="pt-6 flex justify-end">
                <button type="button" onclick="closeModal('expense-summary-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Fechar</button>
            </div>
        </div>
    </div>

    <div id="edit-expense-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4">
        <h3 class="text-2xl font-semibold mb-6">Editar Despesa</h3>
        <form id="edit-expense-form" class="space-y-4">
            <input type="hidden" id="edit-expense-id">
            <div>
                <label for="edit-expense-description" class="block text-sm font-medium text-slate-600">Descrição</label>
                <input type="text" id="edit-expense-description" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="edit-expense-amount" class="block text-sm font-medium text-slate-600">Valor Total</label>
                    <input type="number" id="edit-expense-amount" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="edit-expense-currency" class="block text-sm font-medium text-slate-600">Moeda</label>
                    <select id="edit-expense-currency" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required></select>
                    <input type="text" id="edit-expense-currency-custom" maxlength="6" placeholder="Ex: ARS" class="hidden mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="edit-expense-payer" class="block text-sm font-medium text-slate-600">Quem Pagou? (Credor)</label>
                    <select id="edit-expense-payer" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required></select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-600">Quem deve pagar? (Incluir o credor também se for o caso)</label>
                <div id="edit-expense-participants-checkboxes" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2 border p-3 rounded-md bg-white">
                </div>
            </div>
            <div class="pt-6 flex justify-end gap-3">
                <button type="button" onclick="closeModal('edit-expense-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-semibold">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

    <div id="spending-per-person-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold text-slate-800 mb-4">Total Pago por Pessoa</h3>
            <p class="text-sm text-slate-500 mb-4">Esta lista mostra o valor total da responsabilidade (quota-parte) de cada viajante, somando sua parte em todas as despesas em que participou.</p>
            
            <div id="spending-per-person-results" class="space-y-2 border-t pt-4">
                </div>

            <div class="pt-6 flex justify-end">
                <button type="button" onclick="closeModal('spending-per-person-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Fechar</button>
            </div>
        </div>
    </div>

    <div id="expense-explanation-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl m-4 flex flex-col" style="max-height: 90vh;">
        <h3 class="text-2xl font-semibold text-slate-800 mb-2">Explicação Detalhada do Resumo</h3>
        <p class="text-sm text-slate-500 mb-4">Veja abaixo o detalhamento de quanto cada pessoa pagou, qual era sua responsabilidade (cota-parte) e o balanço final para cada moeda.</p>
        
        <div id="expense-explanation-content" class="flex-grow overflow-y-auto space-y-4 border-t pt-4 pr-2">
            </div>

        <div class="pt-6 flex justify-end">
            <button type="button" onclick="closeModal('expense-explanation-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Fechar</button>
        </div>
    </div>
</div>

<div id="edit-profile-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4">
        <h3 class="text-2xl font-semibold mb-6">Alterar Meus Dados</h3>
        <form id="edit-profile-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="profile-fullname" class="block text-sm font-medium text-slate-600">Nome completo</label>
                    <input type="text" id="profile-fullname" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
                <div>
                    <label for="profile-birthdate" class="block text-sm font-medium text-slate-600">Data de Nascimento</label>
                    <input type="date" id="profile-birthdate" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="profile-cpf" class="block text-sm font-medium text-slate-600">CPF</label>
                    <input type="text" id="profile-cpf" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
                <div>
                    <label for="profile-passport" class="block text-sm font-medium text-slate-600">Passaporte (Opcional)</label>
                    <input type="text" id="profile-passport" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md">
                </div>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="profile-country" class="block text-sm font-medium text-slate-600">País de residência</label>
                    <input type="text" id="profile-country" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
                <div>
                    <label for="profile-city" class="block text-sm font-medium text-slate-600">Cidade/UF de residência</label>
                    <input type="text" id="profile-city" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
                </div>
            </div>
             <div>
                <label for="profile-phone" class="block text-sm font-medium text-slate-600">Telefone</label>
                <input type="tel" id="profile-phone" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" required>
            </div>
            <div class="border-t pt-4 mt-4">
                <button type="button" onclick="openReauthModal()" class="w-full px-4 py-2 bg-slate-600 text-white font-semibold rounded-md hover:bg-slate-700">
                    Trocar Senha
                </button>
            </div>
            <div class="pt-6 flex justify-end gap-3">
                <button type="button" onclick="closeModal('edit-profile-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>


    <script type="module">
        // Importações do Firebase
        // Importações do Firebase - Agora com tudo que precisamos
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail,
            EmailAuthProvider,          // <-- ADICIONE
            reauthenticateWithCredential, // <-- ADICIONE
            updatePassword // <-- ADICIONE
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getDatabase, ref, onValue, set, push, remove, update, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD1IYYMSYXBqfgvUQrp8DaX4Z5n7-4Wryw",
            authDomain: "viagensappoficial.firebaseapp.com",
            databaseURL: "https://viagensappoficial-default-rtdb.firebaseio.com",
            projectId: "viagensappoficial",
            storageBucket: "viagensappoficial.firebasestorage.app",
            messagingSenderId: "344833861467",
            appId: "1:344833861467:web:4fcd794a653fefcb68dc7e",
            measurementId: "G-TN6TN0X5WR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const loginView = document.getElementById('login-form');
        const appView = document.getElementById('app');
        const signupView = document.getElementById('signup-view');

        
        // Variáveis globais
        let currentUserId = null; 
        let db, tripsRef;
        let activeTripListeners = {};
        let currentUserProfile = {};
        let tripsData = []; 
        let currentTripId = null;
        let currentEditingItemIndex = null;
        let currentEditingItemId = null; // Para anotações e outros itens com ID único
        let onConfirmAction = () => {};
        let confirmDeleteTimer = null; // <<< ADICIONE ESTA LINHA
        
        // Variáveis de estado para reorganização
        let isReorganizing = false;
        let frequentTravelersCache = [];
        let initialTripState = null; // Para o botão de cancelar
        let sortableInstance = null; // Apenas uma instância ativa por vez (para dias)
        let sortableInstances = []; // Para o modo de atividades
        let reorganizationMode = 'days'; // 'days' ou 'activities'


        // Adicione esta constante perto de suas outras variáveis globais
        const PREDEFINED_CURRENCIES = [
            "BRL", "USD", "EUR", "JPY", "GBP", "AUD", 
            "CAD", "CHF", "CNY", "CC/IOF"
        ];

        // --- INÍCIO DO CÓDIGO PARA CONTROLE DE HISTÓRICO ---

// 1. Define o estado inicial da página ao carregar
// Usamos replaceState para não criar uma entrada duplicada no histórico.
history.replaceState({ view: 'trips' }, 'Todas as Viagens', '#');

// 2. Cria uma função central para trocar de tela
function navigateTo(view, tripId = null) {
    if (view === 'details') {
        // Mostra a tela de detalhes
        showTripDetails(tripId); 
    } else {
        // Mostra a lista de viagens
        showTripsView(); 
    }
}

// 3. Adiciona o "ouvinte" para o botão voltar/avançar do navegador
window.addEventListener('popstate', (event) => {
    if (event.state) {
        // Se houver um estado salvo, navega para a tela correspondente
        navigateTo(event.state.view, event.state.tripId);
    } else {
        // Caso não haja estado (raro), volta para a tela principal
        navigateTo('trips');
    }
});

// --- FIM DO CÓDIGO PARA CONTROLE DE HISTÓRICO ---

        window.toggleSettlementPaid = async (checkbox, from, to, currency) => {
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            // 1. Cria um ID único para a transação (ex: "Maria_João_BRL")
            const transactionId = `${from}_${to}_${currency}`;
            
            // 2. Pega a lista de pagamentos já realizados ou cria uma nova
            const currentPaidSettlements = trip.paidSettlements || [];

            if (checkbox.checked) {
                // 3. Se o checkbox foi MARCADO, adiciona o ID à lista (se já não estiver lá)
                if (!currentPaidSettlements.includes(transactionId)) {
                    currentPaidSettlements.push(transactionId);
                }
            } else {
                // 4. Se o checkbox foi DESMARCADO, remove o ID da lista
                const index = currentPaidSettlements.indexOf(transactionId);
                if (index > -1) {
                    currentPaidSettlements.splice(index, 1);
                }
            }

            // 5. Salva a lista atualizada no banco de dados
            const updates = { [`/${currentTripId}/paidSettlements`]: currentPaidSettlements };
            await update(ref(db, 'trips'), updates);

            // 6. Atualiza o estilo visual do item instantaneamente
            const transactionElement = checkbox.closest('.transaction-item');
            if (transactionElement) {
                transactionElement.classList.toggle('paid-transaction', checkbox.checked);
            }
        };

        // --- FUNÇÃO PARA REDEFINIÇÃO DE SENHA ---
        window.promptForPasswordReset = () => {
            const email = prompt("Por favor, digite seu e-mail para receber o link de redefinição de senha:");

            if (!email) {
                return; // Usuário cancelou
            }

            sendPasswordResetEmail(auth, email.trim())
                .then(() => {
                    alert(`Um link para redefinir sua senha foi enviado para ${email}, caso esta conta exista. Verifique sua caixa de entrada e spam.`);
                })
                .catch((error) => {
                    console.error("Erro ao enviar e-mail de redefinição:", error);
                    // Não informamos ao usuário se o e-mail não foi encontrado por segurança
                    alert("Ocorreu um erro ao tentar enviar o e-mail. Por favor, verifique o e-mail digitado e tente novamente.");
                });
        }

        // Adicione esta função auxiliar
        function populateCurrencySelect(selectId, customInputId, selectedCurrency = "BRL") {
            const select = document.getElementById(selectId);
            const customInput = document.getElementById(customInputId);
            select.innerHTML = '';

            PREDEFINED_CURRENCIES.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                option.textContent = currency;
                select.appendChild(option);
            });
            select.innerHTML += '<option value="custom">Outra (especificar)</option>';

            // Lógica para selecionar a moeda correta ou mostrar o campo customizado
            if (PREDEFINED_CURRENCIES.includes(selectedCurrency)) {
                select.value = selectedCurrency;
                customInput.classList.add('hidden');
                customInput.value = '';
            } else {
                select.value = 'custom';
                customInput.classList.remove('hidden');
                customInput.value = selectedCurrency;
            }

            select.onchange = () => {
                if (select.value === 'custom') {
                    customInput.classList.remove('hidden');
                } else {
                    customInput.classList.add('hidden');
                }
            };
        }

        // Função para mostrar as sugestões filtradas na tela
        function renderSuggestions(filteredTravelers) {
            const suggestionsContainer = document.getElementById('traveler-suggestions');
            const nameInput = document.getElementById('traveler-name');
            suggestionsContainer.innerHTML = '';

            if (filteredTravelers.length === 0) {
                suggestionsContainer.classList.add('hidden');
                return;
            }

            filteredTravelers.forEach(traveler => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'suggestion-item';
                // Guardamos os dados no próprio elemento para usar ao clicar
                suggestionDiv.dataset.name = traveler.name;
                suggestionDiv.dataset.email = traveler.email;
                suggestionDiv.innerHTML = `
                    <div class="suggestion-name">${traveler.name}</div>
                    <div class="suggestion-email">${traveler.email}</div>
                `;
                suggestionDiv.addEventListener('click', () => {
                    selectSuggestion(traveler.name, traveler.email);
                });
                suggestionsContainer.appendChild(suggestionDiv);
            });

            suggestionsContainer.classList.remove('hidden');
        }

        // Função para preencher os campos ao clicar em uma sugestão
        function selectSuggestion(name, email) {
            document.getElementById('traveler-name').value = name;
            document.getElementById('traveler-email').value = email;
            document.getElementById('traveler-suggestions').classList.add('hidden');
        }

        // Função principal que configura os listeners do autocomplete
        async function setupAutocomplete() {
            // 1. Carrega o histórico do Firebase e guarda em cache
            const frequentTravelersRef = ref(db, `users/${currentUserId}/frequentTravelers`);
            const snapshot = await get(frequentTravelersRef);
            if (snapshot.exists()) {
                frequentTravelersCache = Object.values(snapshot.val());
            } else {
                frequentTravelersCache = [];
            }

            const nameInput = document.getElementById('traveler-name');
            const emailInput = document.getElementById('traveler-email');

            // 2. Adiciona o listener de digitação
            const handleInput = (e) => {
                const query = e.target.value.toLowerCase();
                if (query.length < 1) {
                    document.getElementById('traveler-suggestions').classList.add('hidden');
                    return;
                }
                
                // 3. Filtra o cache local (não o banco de dados!)
                const filtered = frequentTravelersCache.filter(t => 
                    t.name.toLowerCase().includes(query) || 
                    t.email.toLowerCase().includes(query)
                );
                
                renderSuggestions(filtered);
            };

            nameInput.addEventListener('input', handleInput);
            emailInput.addEventListener('input', handleInput);

            // 4. Esconde as sugestões se o usuário clicar fora
            document.body.addEventListener('click', (e) => {
                if (!e.target.closest('#traveler-suggestions') && e.target !== nameInput && e.target !== emailInput) {
                    document.getElementById('traveler-suggestions').classList.add('hidden');
                }
            }, true);
        }
        // --- FIM DAS FUNÇÕES DE AUTOCOMPLETE ---

        // --- INÍCIO DAS FUNÇÕES PARA EDITAR NOME DO VIAJANTE (VERSÃO CORRIGIDA) ---

        // Transforma a linha do viajante em um formulário de edição
        window.editTravelerName = (index, currentName) => {
            const travelerItem = document.getElementById(`traveler-item-${index}`);
            const trip = tripsData.find(t => t.id === currentTripId);
            const traveler = trip.travelers[index];

            travelerItem.innerHTML = `
                <div class="flex-grow">
                    <input type="text" id="edit-traveler-name-${index}" class="block w-full px-2 py-1 bg-white border border-blue-400 rounded-md shadow-sm text-sm" value="${currentName}">
                    <p class="text-xs text-slate-500 mt-1">${traveler.email}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" onclick="saveTravelerName(${index}, '${currentName.replace(/'/g, "\\'")}')" class="text-green-600 hover:text-green-700 p-1" title="Salvar">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>
                    </button>
                     <button type="button" onclick="renderTravelersList(currentTripId)" class="text-red-500 hover:text-red-700 p-1" title="Cancelar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
            `;
            document.getElementById(`edit-traveler-name-${index}`).focus();
        }

        // Salva o novo nome no Firebase, atualizando em toda a viagem
        window.saveTravelerName = async (index, oldName) => {
            const newNameInput = document.getElementById(`edit-traveler-name-${index}`);
            const newName = newNameInput.value.trim();

            if (!newName || newName === oldName) {
                renderTravelersList(currentTripId); // Se não houver mudança, apenas cancela a edição
                return;
            }

            const trip = tripsData.find(t => t.id === currentTripId);
            const updates = {};

            // 1. Atualiza o nome na lista principal de viajantes
            const updatedTravelers = [...trip.travelers];
            updatedTravelers[index].name = newName;
            updates[`/travelers`] = updatedTravelers;

            // 2. Procura e substitui o nome nas Anotações
            if (trip.notes) {
                const updatedNotes = trip.notes.map(note => {
                    if (note.author === oldName) {
                        return { ...note, author: newName };
                    }
                    return note;
                });
                updates[`/notes`] = updatedNotes;
            }
            
            // 3. Procura e substitui o nome nas Despesas Compartilhadas
            if (trip.sharedExpenses) {
                const updatedExpenses = trip.sharedExpenses.map(expense => {
                    if (expense.payerName === oldName) {
                        expense.payerName = newName;
                    }
                    expense.participants = expense.participants.map(p => p === oldName ? newName : p);
                    return expense;
                });
                 updates[`/sharedExpenses`] = updatedExpenses;
            }

            const tripRef = ref(db, `trips/${currentTripId}`);
            await update(tripRef, updates);

            renderTravelersList(currentTripId);
        }
        // --- FIM DAS FUNÇÕES PARA EDITAR NOME DO VIAJANTE ---

        // Função Utilitária
        function formatDate(dateString, options = { day: 'numeric', month: 'short', year: 'numeric' }) {
            if(!dateString) return 'Data indefinida';
            const date = new Date(dateString + 'T00:00:00Z');
            return date.toLocaleDateString('pt-BR', { timeZone: 'UTC', ...options });
        }
        
        function formatCurrency(value, currency = 'BRL') {
            if (typeof value !== 'number') {
                value = parseFloat(value);
            }
            if (isNaN(value)) {
                return currency === 'BRL' ? 'R$ 0,00' : '$ 0,00';
            }

            if (currency === 'BRL') {
                // Se for Real, usa a formatação completa com R$
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            } else {
                // Para outras moedas, formata o número no padrão brasileiro (com vírgula) e adiciona o $
                const formattedNumber = value.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                return `$ ${formattedNumber}`;
            }
        }

        // Definições de Ícones (sem alterações)
        const ICONS = {
            flight_departure: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>`,
            flight_arrival: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" transform="scale(1,-1)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>`,
            lodging_checkin: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            lodging_checkout: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>`,
            train: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 18h2a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H6a2 2 0 0 0-4 2v10a2 2 0 0 0 2 2h2"/><path d="m12 18-3-3 3-3 3 3-3 3Z"/><path d="M6 12h12"/><path d="M6 6h12"/></svg>`,
            car: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>`,
            bus: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6v6"/><path d="M16 6v6"/><path d="M2 12h19.6"/><path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>`,
            transport_other: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 18H8a4 4 0 0 1 0-8h1.5"/><path d="m20 12-3-3 3-3"/><path d="M4 18V6"/></svg>`,
            passeio: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`,
            restaurante: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3z"/></svg>`,
            outro: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12a10.06 10.06 1 0 0-20 0Z"/><path d="M12 12v8a2 2 0 0 0 4 0"/><path d="M12 2v1"/></svg>`,
            basketball: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 0-10 10c0 .2 0 .5.1.7"/><path d="M22 12a10 10 0 0 0-10-10c-.2 0-.5 0-.7.1"/><path d="M2 12h20"/><path d="M12 22a10 10 0 0 0 10-10c0-.2 0-.5-.1-.7"/><path d="M2 12a10 10 0 0 0 10 10c.2 0 .5 0 .7-.1"/></svg>`,
            building: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>`,
            shopping: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>`,
            tree: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-8"/><path d="m17 14-5-5-5 5h10z"/><path d="M8.5 14h7"/><path d="M7 9a5 5 0 0 1 10 0v2H7Z"/></svg>`,
            cake: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16h16"/><path d="M16 11V7a4 4 0 0 0-8 0v4"/><path d="M12 21v-4"/><path d="M12 7a2 2 0 0 1 0-4 2 2 0 0 1 0 4Z"/></svg>`,
            sun: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`,
            leaf: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`,
            mountain: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 3 4 8 5-5 5 15H2L8 3z"/></svg>`,
            ferris_wheel: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="2"/><circle cx="12" cy="12" r="10"/><path d="m12 22 3-8 3 8"/><path d="m12 22-3-8-3 8"/><path d="m2 12h8"/><path d="m14 12h8"/><path d="m19.07 4.93-4.24 4.24"/><path d="m4.93 19.07 4.24-4.24"/><path d="m4.93 4.93 4.24 4.24"/><path d="m14.83 19.07-4.24-4.24"/></svg>`,
            music: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`,
            waves: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6c.9.5 2.2 1 3.5 1s2.6-.5 3.5-1 2.2 1 3.5 1 2.6-.5 3.5-1"/><path d="M3 12c.9.5 2.2 1 3.5 1s2.6-.5 3.5-1 2.2 1 3.5 1 2.6-.5 3.5-1"/><path d="M3 18c.9.5 2.2 1 3.5 1s2.6-.5 3.5-1 2.2 1 3.5 1 2.6-.5 3.5-1"/></svg>`,
            sunglasses: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 14h2"/><path d="M20 14h2"/><path d="M5.2 11.3 4 14"/><path d="M18.8 11.3 20 14"/><circle cx="8" cy="15" r="4"/><circle cx="16" cy="15" r="4"/><path d="M12 15a4 4 0 0 0-4-4h8a4 4 0 0 0-4 4Z"/></svg>`,
           
            note_food: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-utensils-crossed"><path d="m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8Z"/><path d="M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Zm0 0 7 7"/><path d="m2.1 21.8 6.4-6.3"/></svg>`,
            note_market: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.16"/></svg>`,
            note_star: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
            note_remedy: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-plus"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>`,
            note_alert: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-siren"><path d="M7 12a5 5 0 0 1 5-5v0a5 5 0 0 1 5 5v0a5 5 0 0 1-5 5v0a5 5 0 0 1-5-5Z"/><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Z"/><path d="M10 19h4"/><path d="M12 12v-5"/></svg>`,
            
            note_tag: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tag-icon lucide-tag"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></svg>`,
            note_backpack: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-backpack-icon lucide-backpack"><path d="M4 10a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z"/><path d="M8 10h8"/><path d="M8 18h8"/><path d="M8 22v-6a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>`,
            note_money: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-dollar-sign-icon lucide-circle-dollar-sign"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg>`,
            note_gift: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gift-icon lucide-gift"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>`,
            note_heart: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart-icon lucide-heart"><path d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"/></svg>`,

		default: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`
        };
  

        // Inicializa o Firebase com a configuração definida acima
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            // As variáveis 'db' e 'tripsRef' serão definidas após o login do usuário
        } catch (error) {
            console.error("Falha na inicialização do Firebase:", error);
            alert("Não foi possível conectar ao serviço. Tente recarregar a página.");
        }

        // --- FUNÇÕES DE DIVISÃO DE DESPESAS ---

        function renderSharedExpenses(trip) {
            const travelers = trip.travelers || [];
            const expenses = trip.sharedExpenses || [];
            
            const payerSelect = document.getElementById('expense-payer');
            const participantsContainer = document.getElementById('expense-participants-checkboxes');
            const expenseListContainer = document.getElementById('shared-expenses-list');

            // 1. Popula os campos do formulário de ADIÇÃO
            populateCurrencySelect('expense-currency', 'expense-currency-custom');
            payerSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
            participantsContainer.innerHTML = '';

            if (travelers.length === 0) {
                participantsContainer.innerHTML = '<p class="text-sm text-slate-400 col-span-full">Cadastre viajantes para adicionar despesas.</p>';
            } else {
                travelers.forEach(traveler => {
                    const option = document.createElement('option');
                    option.value = traveler.name;
                    option.textContent = traveler.name;
                    payerSelect.appendChild(option.cloneNode(true));

                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center gap-2';
                    checkboxDiv.innerHTML = `<input type="checkbox" id="participant-${traveler.name.replace(/\s+/g, '-')}" value="${traveler.name}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="participant-${traveler.name.replace(/\s+/g, '-')}" class="text-sm text-slate-700">${traveler.name}</label>`;
                    participantsContainer.appendChild(checkboxDiv);
                });
                const selectAllCheckbox = document.getElementById('select-all-participants');
                selectAllCheckbox.checked = true;
                selectAllCheckbox.dispatchEvent(new Event('change'));
            }

            // 2. AGRUPA despesas por moeda e renderiza a lista
            expenseListContainer.innerHTML = '';
            if (expenses.length === 0) {
                expenseListContainer.innerHTML = '<p class="text-center text-sm text-slate-500 py-4">Nenhuma despesa de grupo adicionada ainda.</p>';
            } else {
                const expensesByCurrency = expenses.reduce((acc, expense) => {
                    const currency = expense.currency || 'BRL';
                    if (!acc[currency]) {
                        acc[currency] = [];
                    }
                    acc[currency].push(expense);
                    return acc;
                }, {});

                // Ordena as moedas (BRL primeiro, depois as outras)
                const sortedCurrencies = Object.keys(expensesByCurrency).sort((a, b) => {
                    if (a === 'BRL') return -1;
                    if (b === 'BRL') return 1;
                    return a.localeCompare(b);
                });

                sortedCurrencies.forEach(currency => {
                    const currencyExpenses = expensesByCurrency[currency];
                    
                    // Cria o cabeçalho do grupo de moeda
                    const currencyHeader = document.createElement('div');
                    currencyHeader.className = 'mt-4 mb-2';
                    currencyHeader.innerHTML = `<h4 class="inline-block bg-slate-200 text-slate-800 text-md font-bold px-3 py-1 rounded-md">${currency}</h4>`;
                    expenseListContainer.appendChild(currencyHeader);

                    currencyExpenses.forEach(expense => {
                        const expenseElement = document.createElement('div');
                        expenseElement.className = 'flex justify-between items-center p-3 rounded-lg hover:bg-slate-50 border border-slate-200 cursor-pointer';
                        expenseElement.onclick = () => openExpenseDetailsModal(expense.id);

                        expenseElement.innerHTML = `
                            <div>
                                <p class="font-semibold text-slate-800">${expense.description}</p>
                                <p class="text-sm text-slate-500">Total: ${formatCurrency(expense.amount, expense.currency)} | Pago por: ${expense.payerName}</p>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="text-xs bg-slate-200 text-slate-600 font-medium px-2 py-1 rounded-full">${expense.participants.length}</span>
                                <button onclick="event.stopPropagation(); openEditExpenseModal('${expense.id}')" class="text-slate-400 hover:text-blue-600 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                                <button onclick="event.stopPropagation(); deleteSharedExpense('${expense.id}')" class="text-slate-400 hover:text-red-600 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            </div>`;
                        expenseListContainer.appendChild(expenseElement);
                    });
                });
            }
        }
        
        window.openExpenseDetailsModal = (expenseId) => {
            const trip = tripsData.find(t => t.id === currentTripId);
            const expense = (trip.sharedExpenses || []).find(e => e.id === expenseId);
            if (!expense) return;

            document.getElementById('view-expense-description').textContent = expense.description;
            document.getElementById('view-expense-amount').textContent = formatCurrency(expense.amount, expense.currency);
            document.getElementById('view-expense-payer').textContent = expense.payerName;
            
            const participantsList = document.getElementById('view-expense-participants-list');
            participantsList.innerHTML = '';
            
            const share = expense.amount / expense.participants.length;
            
            expense.participants.forEach(name => {
                const isPayer = name === expense.payerName;
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-slate-50 rounded-md';
                item.innerHTML = `
                <span>${name} ${isPayer ? '(Pagou)' : ''}</span>
                <span class="font-semibold">${isPayer ? 'Pagou a própria quota' : `Deve ${formatCurrency(share, expense.currency)}`}</span>
            `;
                participantsList.appendChild(item);
            });

            openModal('view-expense-modal');
        }

        window.deleteSharedExpense = (expenseId) => {
            showConfirmDelete('Tem certeza que deseja excluir esta despesa compartilhada?', async () => {
                const trip = tripsData.find(t => t.id === currentTripId);
                const updatedExpenses = (trip.sharedExpenses || []).filter(e => e.id !== expenseId);
                const updates = { [`/${currentTripId}/sharedExpenses`]: updatedExpenses };
                await update(ref(db, 'trips'), updates);
                closeModal('confirm-delete-modal');
            });
        };

        // Adicione estas funções junto com as outras de despesas
        
        window.openEditExpenseModal = (expenseId) => {
            const trip = tripsData.find(t => t.id === currentTripId);
            const expense = (trip.sharedExpenses || []).find(e => e.id === expenseId);
            if (!expense) return;

            // Preenche os campos simples
            document.getElementById('edit-expense-id').value = expense.id;
            document.getElementById('edit-expense-description').value = expense.description;
            document.getElementById('edit-expense-amount').value = expense.amount;

            populateCurrencySelect('edit-expense-currency', 'edit-expense-currency-custom', expense.currency);

            const payerSelect = document.getElementById('edit-expense-payer');
            const participantsContainer = document.getElementById('edit-expense-participants-checkboxes');
            payerSelect.innerHTML = '';
            participantsContainer.innerHTML = '';

            // Popula as listas de viajantes no modal de edição
            (trip.travelers || []).forEach(traveler => {
                // Adiciona ao <select> de quem pagou
                const option = document.createElement('option');
                option.value = traveler.name;
                option.textContent = traveler.name;
                if (traveler.name === expense.payerName) {
                    option.selected = true;
                }
                payerSelect.appendChild(option);

                // Adiciona os checkboxes e marca os que participaram
                const isParticipant = expense.participants.includes(traveler.name);
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center gap-2';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="edit-participant-${traveler.name.replace(/\s+/g, '-')}" value="${traveler.name}" ${isParticipant ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="edit-participant-${traveler.name.replace(/\s+/g, '-')}" class="text-sm text-slate-700">${traveler.name}</label>
                `;
                participantsContainer.appendChild(checkboxDiv);
            });

            openModal('edit-expense-modal');
        };


        // --- INÍCIO DAS FUNÇÕES DE NOTIFICAÇÃO ---

        // Atualiza a bolinha vermelha e o indicador no menu com base nas notificações não lidas
        function updateNotificationBadge(notifications) {
            const mainBadge = document.getElementById('notification-badge');
            const menuBadge = document.getElementById('notification-menu-badge');
            const unreadCount = notifications.filter(n => !n.isRead).length;

            if (unreadCount > 0) {
                // Mostra a bolinha vermelha principal
                mainBadge.classList.remove('hidden');
                
                // Mostra o indicador no menu e coloca a contagem dentro dele
                menuBadge.classList.remove('hidden');
                menuBadge.textContent = unreadCount;

            } else {
                // Esconde ambos os indicadores se não houver notificações não lidas
                mainBadge.classList.add('hidden');
                menuBadge.classList.add('hidden');
            }
        }

        // Renderiza a lista de notificações dentro do modal
        function renderNotificationsList(notifications) {
            const listContainer = document.getElementById('notifications-list');
            listContainer.innerHTML = '';

            if (notifications.length === 0) {
                listContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhuma notificação ainda.</p>';
                return;
            }
            
            // Ordena as notificações da mais nova para a mais antiga
            notifications.sort((a, b) => b.timestamp - a.timestamp);

            notifications.forEach(note => {
                const noteElement = document.createElement('div');
                const isUnread = !note.isRead;
                noteElement.className = `p-3 rounded-lg border ${isUnread ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-slate-200'}`;
                
                const date = new Date(note.timestamp);
                const formattedDate = date.toLocaleString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });

                noteElement.innerHTML = `
                    <p class="text-slate-800">${note.message}</p>
                    <p class="text-xs text-slate-500 mt-1">${formattedDate}</p>
                `;
                listContainer.appendChild(noteElement);
            });
        }

        // Configura o "ouvinte" principal para as notificações do usuário
        function setupNotificationListener(userId) {
            const notificationsRef = ref(db, `users/${userId}/notifications`);
            
            onValue(notificationsRef, (snapshot) => {
                if (snapshot.exists()) {
                    const notificationsData = snapshot.val();
                    // Converte o objeto do Firebase em um array
                    const notificationsArray = Object.keys(notificationsData).map(key => ({
                        id: key,
                        ...notificationsData[key]
                    }));
                    
                    updateNotificationBadge(notificationsArray);
                    renderNotificationsList(notificationsArray);
                } else {
                    // Se não houver notificações, garante que a interface esteja limpa
                    updateNotificationBadge([]);
                    renderNotificationsList([]);
                }
            });
        }
        // --- FIM DAS FUNÇÕES DE NOTIFICAÇÃO ---


        // "PORTEIRO": gerencia qual tela é exibida
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // --- INÍCIO DA MODIFICAÇÃO ---
                currentUserId = user.uid; // Guarda o ID do usuário logado
                // --- FIM DA MODIFICAÇÃO ---
                
                // 1. USUÁRIO ESTÁ LOGADO
                //console.log("Usuário logado:", user.uid);

                db = getDatabase(app);
                
                const userProfileRef = ref(db, `users/${user.uid}/profile`);
                    onValue(userProfileRef, (snapshot) => {
                        const profile = snapshot.val();
                        currentUserProfile = profile || {};
                        if (profile && profile.fullName) {
                            const firstName = profile.fullName.split(' ')[0];
                            document.getElementById('user-menu-name').textContent = firstName;
                        } else {
                            document.getElementById('user-menu-name').textContent = "Perfil";
                        }
                    });

                loginView.classList.add('hidden');
                signupView.classList.add('hidden');
                appView.classList.remove('hidden');

                setupTripsListener(); 
                setupIconPickers();
                setupNotificationListener(user.uid);

            } else {
                // --- INÍCIO DA MODIFICAÇÃO ---
                currentUserId = null; // Limpa o ID quando o usuário sai
                // --- FIM DA MODIFICAÇÃO ---

                // 2. USUÁRIO ESTÁ DESLOGADO
                console.log("Nenhum usuário logado.");

                loginView.classList.remove('hidden');
                signupView.classList.add('hidden');
                appView.classList.add('hidden');
            }
        });

         // Ação do botão de LOGIN
        // Ação do formulário de LOGIN
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault(); // Impede o recarregamento da página

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                alert('Por favor, preencha os campos de e-mail e senha.');
                return; 
            }

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    console.error("Erro no login:", error.code);
                    alert("Falha no login. Verifique seu e-mail e senha.");
                });
        });

        // Ação do botão de CADASTRO (agora só abre o painel)
        document.getElementById('signup-btn').addEventListener('click', () => {
            loginView.classList.add('hidden');
            signupView.classList.remove('hidden');
        });

        // Ação do botão para CANCELAR o cadastro e voltar
        document.getElementById('cancel-signup-btn').addEventListener('click', () => {
            signupView.classList.add('hidden');
            loginView.classList.remove('hidden');
        });

        // Ação do formulário de CADASTRO DETALHADO
        document.getElementById('signup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const profileData = {
                fullName: document.getElementById('signup-fullname').value,
                birthDate: document.getElementById('signup-birthdate').value,
                cpf: document.getElementById('signup-cpf').value,
                passport: document.getElementById('signup-passport').value,
                country: document.getElementById('signup-country').value,
                city: document.getElementById('signup-city').value,
                phone: document.getElementById('signup-phone').value,
            };
            if (!email || !password || !profileData.fullName || !profileData.birthDate || !profileData.cpf) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            let userId;

            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    const user = userCredential.user;
                    userId = user.uid;
                    
                    const encodedEmail = btoa(email.toLowerCase());

                    try {
                        // Operação 1: Salva o perfil
                        await set(ref(db, `users/${userId}/profile`), profileData);
                        // Operação 2: Salva o índice de e-mail
                        await set(ref(db, `emailToUid/${encodedEmail}`), userId);
                        
                        alert('Conta criada com sucesso! Você já está logado.');
                    } catch (error) {
                        console.error("Erro ao salvar dados do novo usuário:", error);
                        alert("A conta foi criada, mas houve um erro ao salvar os dados do perfil.");
                    }
                })
                .catch((error) => {
                    console.error("Erro no cadastro:", error.code);
                    if (error.code === 'auth/weak-password') {
                        alert('Senha muito fraca. A senha deve ter pelo menos 6 caracteres.');
                    } else if (error.code === 'auth/email-already-in-use') {
                        alert('Este e-mail já está em uso. Tente fazer login.');
                    } else {
                        alert('Ocorreu um erro ao criar a conta.');
                    }
                });
        });

       
        // Adicione este listener junto com os outros no final do script
        document.getElementById('edit-expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            const expenseId = document.getElementById('edit-expense-id').value;
            
            const currencySelect = document.getElementById('edit-expense-currency');
            let currency = currencySelect.value;
            if (currency === 'custom') {
                currency = document.getElementById('edit-expense-currency-custom').value.toUpperCase().trim() || 'CUSTOM';
            }

            const updatedExpense = {
                id: expenseId,
                description: document.getElementById('edit-expense-description').value,
                amount: parseFloat(document.getElementById('edit-expense-amount').value),
                currency, // <-- CAMPO NOVO
                payerName: document.getElementById('edit-expense-payer').value,
                participants: []
            };

            document.querySelectorAll('#edit-expense-participants-checkboxes input[type="checkbox"]:checked').forEach(checkbox => {
                updatedExpense.participants.push(checkbox.value);
            });
            
            if (updatedExpense.participants.length === 0) {
                alert('Uma despesa deve ter ao menos um responsável.');
                return;
            }

            const currentExpenses = trip.sharedExpenses || [];
            const expenseIndex = currentExpenses.findIndex(ex => ex.id === expenseId);

            if (expenseIndex > -1) {
                currentExpenses[expenseIndex] = updatedExpense;
                const updates = { [`/${currentTripId}/sharedExpenses`]: currentExpenses };
                await update(ref(db, 'trips'), updates);
                closeModal('edit-expense-modal');
            } else {
                alert('Erro: não foi possível encontrar a despesa para atualizar.');
            }
        });

        window.showSpendingPerPerson = () => {
            const trip = tripsData.find(t => t.id === currentTripId);
            const travelers = trip.travelers || [];
            const resultsContainer = document.getElementById('spending-per-person-results');
            resultsContainer.innerHTML = '';

            // Passo 1: Agrupar despesas por moeda
            const expensesByCurrency = (trip.sharedExpenses || []).reduce((acc, expense) => {
                const currency = expense.currency || 'BRL';
                if (!acc[currency]) {
                    acc[currency] = [];
                }
                acc[currency].push(expense);
                return acc;
            }, {});

            // Ordena as moedas para uma exibição consistente
            const sortedCurrencies = Object.keys(expensesByCurrency).sort((a, b) => {
                if (a === 'BRL') return -1;
                if (b === 'BRL') return 1;
                return a.localeCompare(b);
            });

            if (sortedCurrencies.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-slate-600">Nenhuma despesa de grupo foi adicionada para verificar.</p>';
                openModal('spending-per-person-modal');
                return;
            }

            // Passo 2: Calcular a responsabilidade de cada pessoa para cada moeda
            sortedCurrencies.forEach(currency => {
                const currencyExpenses = expensesByCurrency[currency];

                const responsibilityTotals = {};
                travelers.forEach(t => {
                    responsibilityTotals[t.name] = 0;
                });

                currencyExpenses.forEach(expense => {
                    const numberOfParticipants = expense.participants.length;
                    if (numberOfParticipants > 0) {
                        const share = expense.amount / numberOfParticipants;
                        expense.participants.forEach(participantName => {
                            if (responsibilityTotals.hasOwnProperty(participantName)) {
                                responsibilityTotals[participantName] += share;
                            }
                        });
                    }
                });

                const sortedResponsibilities = Object.entries(responsibilityTotals).sort(([, a], [, b]) => b - a);
                
                // Passo 3: Exibir os resultados agrupados por moeda
                const currencyHeader = document.createElement('div');
                currencyHeader.innerHTML = `<h4 class="text-lg font-bold text-slate-800 bg-slate-100 px-3 py-2 rounded-md mt-4 first:mt-0">${currency}</h4>`;
                resultsContainer.appendChild(currencyHeader);

                sortedResponsibilities.forEach(([name, total]) => {
                    // Só exibe pessoas que tiveram algum custo
                    if (total > 0.01) {
                        const spendingEl = document.createElement('div');
                        spendingEl.className = 'flex justify-between items-center p-2 bg-slate-50 rounded-md text-base';
                        spendingEl.innerHTML = `
                            <span class="font-medium text-slate-700">${name}</span>
                            <span class="font-bold text-slate-800">${formatCurrency(total, currency)}</span>
                        `;
                        resultsContainer.appendChild(spendingEl);
                    }
                });
            });

            openModal('spending-per-person-modal');
        };
        
        // --- FUNÇÕES DE GERENCIAMENTO DE VIAJANTES ---

        function renderTravelersList(tripId) {
            const listElement = document.getElementById('travelers-list');
            listElement.innerHTML = '';
            const trip = tripsData.find(t => t.id === tripId);
            const travelers = trip?.travelers || [];

            if (travelers.length === 0) {
                listElement.innerHTML = `<p class="text-sm text-slate-400 text-center py-2">Nenhum viajante adicionado.</p>`;
                return;
            }

            const ownerUid = Object.keys(trip.members).find(uid => trip.members[uid] === 'owner');

            travelers.forEach((traveler, index) => {
                const travelerElement = document.createElement('div');
                // Adicionamos um ID único para cada item da lista para facilitar a edição
                travelerElement.id = `traveler-item-${index}`; 
                travelerElement.className = 'flex items-center justify-between p-2 bg-slate-100 rounded-md';
                
                const isOwner = traveler.uid === ownerUid;

                // Prepara os botões de ação (editar e excluir)
                let actionButtonsHtml = '';
                if (!isOwner) {
                    // Se não for o dono, pode ser editado e removido
                    actionButtonsHtml = `
                        <button type="button" onclick="editTravelerName(${index}, '${traveler.name.replace(/'/g, "\\'")}')" class="text-slate-500 hover:text-blue-600 p-1" title="Editar nome">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button type="button" onclick="removeTraveler(${index})" class="text-red-500 hover:text-red-700 p-1" title="Remover viajante">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    `;
                } else {
                    // O dono só pode ter o nome editado (não pode ser removido)
                     actionButtonsHtml = `
                        <button type="button" onclick="editTravelerName(${index}, '${traveler.name.replace(/'/g, "\\'")}')" class="text-slate-500 hover:text-blue-600 p-1" title="Editar nome">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <span class="text-xs font-semibold text-blue-600 px-2">(Dono)</span>
                    `;
                }

                travelerElement.innerHTML = `
                    <div>
                        <p class="font-semibold text-slate-800">${traveler.name}</p>
                        <p class="text-xs text-slate-500">${traveler.email}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        ${actionButtonsHtml}
                    </div>
                `;
                listElement.appendChild(travelerElement);
            });
        }

        window.addTraveler = async () => {
            const nameInput = document.getElementById('traveler-name');
            const emailInput = document.getElementById('traveler-email');
            const name = nameInput.value.trim();
            const email = emailInput.value.trim().toLowerCase();

            if (!name || !email) {
                alert('Por favor, preencha o nome e o e-mail do viajante.');
                return;
            }

            const encodedEmail = btoa(email);
            const emailToUidRef = ref(db, `emailToUid/${encodedEmail}`);
            const snapshot = await get(emailToUidRef);

            if (!snapshot.exists()) {
                alert('Usuário não encontrado. Peça para que ele crie uma conta primeiro.');
                return;
            }

            const newTravelerUid = snapshot.val();
            const trip = tripsData.find(t => t.id === currentTripId);
            const currentTravelers = trip.travelers || [];

            if (currentTravelers.some(traveler => traveler.uid === newTravelerUid)) {
                alert('Este viajante já foi adicionado à viagem.');
                return;
            }
            
            const updates = {};

            const newTraveler = { uid: newTravelerUid, name, email }; 
            const updatedTravelers = [...currentTravelers, newTraveler];
            updates[`/trips/${currentTripId}/travelers`] = updatedTravelers;
            updates[`/trips/${currentTripId}/members/${newTravelerUid}`] = "member"; 
            updates[`/users/${newTravelerUid}/memberOf/${currentTripId}`] = true;

            if (newTravelerUid !== currentUserId) {
                const newNotificationKey = push(ref(db, `users/${newTravelerUid}/notifications`)).key;
                const newNotification = {
                    message: `Você foi adicionado(a) à viagem "${trip.name}" por ${currentUserProfile.fullName}.`,
                    tripId: currentTripId,
                    isRead: false,
                    timestamp: serverTimestamp()
                };
                updates[`/users/${newTravelerUid}/notifications/${newNotificationKey}`] = newNotification;
            }

            // --- INÍCIO DA CORREÇÃO ---
            // O código para salvar no histórico foi movido para dentro do objeto 'updates'
            // e a chamada 'update' separada foi removida.
            if (currentUserId && newTravelerUid !== currentUserId) {
                updates[`/users/${currentUserId}/frequentTravelers/${newTravelerUid}`] = { name, email };
            }
            // --- FIM DA CORREÇÃO ---

            try {
                // Agora, todas as escritas no banco de dados acontecem em uma única operação.
                await update(ref(db), updates); 

                nameInput.value = '';
                emailInput.value = '';
                document.getElementById('traveler-suggestions').classList.add('hidden');
            } catch (error) {
                console.error("Erro ao adicionar viajante e criar notificação:", error);
                alert("Ocorreu um erro ao adicionar o viajante.");
            }

            renderTravelersList(currentTripId); 
        };

        window.removeTraveler = async (index) => {
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip || !trip.travelers) return;

            // 1. Identifica o viajante a ser removido com base no índice
            const travelerToRemove = trip.travelers[index];
            if (!travelerToRemove) {
                console.error("Viajante não encontrado no índice fornecido.");
                return;
            }

            const emailToRemove = travelerToRemove.email.toLowerCase();

            // 2. Pede confirmação ao usuário, pois é uma ação destrutiva
            if (!confirm(`Tem certeza que deseja remover ${travelerToRemove.name} da viagem? Esta ação também removerá o acesso dele(a) à viagem.`)) {
                return;
            }

            // 3. Encontra o UID (ID de usuário) do viajante a ser removido
            const encodedEmail = btoa(emailToRemove);
            const emailToUidRef = ref(db, `emailToUid/${encodedEmail}`);
            const snapshot = await get(emailToUidRef);

            let uidToRemove = null;
            if (snapshot.exists()) {
                uidToRemove = snapshot.val();
            } else {
                console.warn(`UID para o e-mail ${emailToRemove} não encontrado. O viajante será removido da lista, mas o acesso pode não ser totalmente revogado se o UID não for encontrado.`);
            }

            // 4. Prepara a atualização de "mão dupla" para a remoção
            // Cria um novo array de viajantes sem a pessoa que foi removida
            const updatedTravelers = trip.travelers.filter((_, i) => i !== index);

            const updates = {};
            // Lado 1: Atualiza a lista de 'travelers' da viagem
            updates[`/trips/${currentTripId}/travelers`] = updatedTravelers;

            if (uidToRemove) {
                // Lado 2: Remove o viajante da lista de 'members' da viagem (revoga a permissão)
                updates[`/trips/${currentTripId}/members/${uidToRemove}`] = null; // null para deletar
                // Lado 3: Remove a viagem da lista 'memberOf' do viajante (remove da lista dele)
                updates[`/users/${uidToRemove}/memberOf/${currentTripId}`] = null; // null para deletar
            }

            // 5. Executa a atualização atômica
            await update(ref(db), updates);
            
            // O listener em tempo real cuidará de atualizar a interface do usuário
            renderTravelersList(currentTripId); 
        };
                 

        function populateTravelersDropdown(selectElementId, selectedAuthorName = null) {
            const selectElement = document.getElementById(selectElementId);
            selectElement.innerHTML = '<option value="" disabled>Selecione um viajante</option>';
            const trip = tripsData.find(t => t.id === currentTripId);
            const travelers = trip?.travelers || [];

            if (travelers.length === 0) {
                selectElement.innerHTML = '<option value="" disabled>Adicione viajantes em "Editar Viagem"</option>';
                return;
            }

            travelers.forEach(traveler => {
                const option = document.createElement('option');
                option.value = traveler.name;
                option.textContent = traveler.name;
                if (traveler.name === selectedAuthorName) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        window.toggleGenericPanel = (panelId) => {
            document.getElementById(panelId).classList.toggle('collapsed');
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        // VERSÃO NOVA
        function renderTripLists() {
            const featuredTripsPanel = document.getElementById('featured-trips-panel');
            const featuredTripsList = document.createElement('div');
            featuredTripsList.id = 'featured-trips-list';
            featuredTripsList.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

            // 1. Pega a referência para os novos containers da lista
            const upcomingTripsList = document.getElementById('upcoming-trips-list');
            const pastTripsList = document.getElementById('past-trips-list');
            
            // Limpa todos os containers antes de preencher
            featuredTripsPanel.innerHTML = '';
            upcomingTripsList.innerHTML = '';
            pastTripsList.innerHTML = '';

            // A lógica para viagens destacadas continua a mesma
            const featuredTrips = tripsData.filter(trip => trip.featured);
            if(featuredTrips.length > 0) {
                featuredTripsPanel.innerHTML = `<h2 class="text-2xl font-bold text-slate-800 mb-4">Viagens Destacadas</h2>`;
                featuredTrips.forEach(trip => {
                    featuredTripsList.appendChild(createTripCard(trip, true));
                });
                featuredTripsPanel.appendChild(featuredTripsList);
            }
            
            // Trata o caso de não haver nenhuma viagem cadastrada
            if (tripsData.length === 0) {
                 const emptyMessage = `<div class="col-span-full text-center p-10 bg-white rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-slate-700">Nenhuma viagem encontrada.</h3>
                    <p class="text-slate-500 mt-2">Clique em "Nova Viagem" para começar a planejar!</p>
                </div>`;
                upcomingTripsList.innerHTML = emptyMessage;
                pastTripsList.innerHTML = `<p class="col-span-full text-center text-sm text-slate-500 py-4">Nenhuma viagem realizada ainda.</p>`;
                return;
            }

            // 2. Separa as viagens em futuras e passadas
            const today = new Date();
            today.setUTCHours(0, 0, 0, 0); // Zera o horário para comparar apenas a data

            const upcomingTrips = [];
            const pastTrips = [];

            tripsData.forEach(trip => {
                // Considera a data de término da viagem para a comparação
                const tripEndDate = new Date(trip.endDate + 'T00:00:00Z');
                if (tripEndDate < today) {
                    pastTrips.push(trip);
                } else {
                    upcomingTrips.push(trip);
                }
            });

            // 3. Renderiza a lista de PRÓXIMAS viagens
            if (upcomingTrips.length > 0) {
                upcomingTrips.forEach(trip => {
                    upcomingTripsList.appendChild(createTripCard(trip, false));
                });
            } else {
                upcomingTripsList.innerHTML = `<p class="col-span-full text-center text-sm text-slate-500 py-4">Nenhuma viagem futura planejada.</p>`;
            }

            // 4. Renderiza a lista de viagens JÁ REALIZADAS
            if (pastTrips.length > 0) {
                pastTrips.forEach(trip => {
                    pastTripsList.appendChild(createTripCard(trip, false));
                });
            } else {
                pastTripsList.innerHTML = `<p class="col-span-full text-center text-sm text-slate-500 py-4">Nenhuma viagem realizada ainda.</p>`;
            }
        }
        
        function createTripCard(trip, isFeaturedCard) {
            const tripCard = document.createElement('div');
            tripCard.className = 'trip-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer transform hover:-translate-y-1 transition-transform duration-300 relative';
            tripCard.onclick = () => showTripDetails(trip.id);
            
            const isOwner = currentUserId && trip.members && trip.members[currentUserId] === 'owner';

            // --- INÍCIO DA LÓGICA PARA ENCONTRAR O NOME DO DONO ---
            let ownerDisplayName = 'Carregando...';
            // Garante que a viagem tenha as informações necessárias
            if (trip.members && trip.travelers) {
                // 1. Encontra o ID do usuário que é o "owner"
                const ownerUid = Object.keys(trip.members).find(uid => trip.members[uid] === 'owner');
                
                if (ownerUid) {
                    // 2. Encontra o objeto do viajante que corresponde ao ID do dono
                    const ownerTraveler = trip.travelers.find(traveler => traveler.uid === ownerUid);
                    if (ownerTraveler && ownerTraveler.name) {
                         // 3. Pega o primeiro nome do dono para exibir
                        ownerDisplayName = ownerTraveler.name.split(' ')[0];
                    } else {
                        ownerDisplayName = "Dono não encontrado";
                    }
                } else {
                    ownerDisplayName = "Sem dono definido";
                }
            }
            // --- FIM DA LÓGICA ---

            let deleteButtonHtml = '';
            if (isOwner) {
                deleteButtonHtml = `
                    <button onclick="deleteTrip(event, '${trip.id}')" title="Excluir Viagem" class="trip-card-action-button w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    </button>
                `;
            }

            let imageContainerClasses = 'h-48';
            let textContainerClasses = 'p-6';
            let titleClasses = 'text-2xl';

            if (!isFeaturedCard) {
                imageContainerClasses = 'h-24';
                textContainerClasses = 'p-4';
                titleClasses = 'text-xl';

                const today = new Date();
                today.setUTCHours(0, 0, 0, 0);
                const tripEndDate = new Date(trip.endDate + 'T00:00:00Z');

                if (tripEndDate < today) {
                    imageContainerClasses += ' grayscale';
                }
            }

            const starIcon = trip.featured ?
                `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>` :
                `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`;

            tripCard.innerHTML = `
                <button onclick="toggleFeatured(event, '${trip.id}')" class="absolute top-3 left-3 z-10 w-8 h-8 flex items-center justify-center bg-white/70 backdrop-blur-sm text-yellow-500 rounded-full hover:bg-white transition-colors">
                    ${starIcon}
                </button>
                <div class="absolute top-3 right-3 z-10 flex gap-2">
                    <button onclick="duplicateTrip(event, '${trip.id}')" title="Duplicar Viagem" class="trip-card-action-button w-8 h-8 flex items-center justify-center bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>
                    </button>
                    ${deleteButtonHtml}
                </div>
                <div class="${imageContainerClasses} bg-cover bg-center transition-all duration-300" style="background-image: url('${trip.imageUrl}')"></div>
                <div class="${textContainerClasses}">
                    <h3 class="${titleClasses} font-bold text-slate-900 truncate">${trip.name}</h3>
                    
                    <p class="text-slate-500 mt-1 text-sm truncate">Criado por ${ownerDisplayName}</p>
                    
                    <div class="mt-2 text-xs font-medium text-slate-600">
                       ${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}
                    </div>
                </div>
            `;
            return tripCard;
        }

        function renderTripDetails(tripId) {
            currentTripId = tripId;
            const trip = tripsData.find(t => t.id === tripId);

            if (!trip) {
                console.error("Viagem não encontrada:", tripId);
                showTripsView();
                return;
            }

            // Atualiza o contador de anotações no botão do Índice Rápido
            const notesCount = trip.notes ? trip.notes.length : 0;
            const indexNotesButton = document.getElementById('index-btn-notes');
            if (indexNotesButton) {
                indexNotesButton.textContent = `Anotações (${notesCount})`;
            }

            const header = document.getElementById('details-header');
            header.style.backgroundImage = `url('${trip.imageUrl}')`;

            const citiesContainer = document.getElementById('details-cities-container');
            citiesContainer.innerHTML = ''; 

            if (trip.activities) {
                const cityActivities = Object.values(trip.activities).filter(activity => activity.type === 'Cidade');
                
                if (cityActivities.length > 0) {
                    const uniqueCities = [...new Set(cityActivities.map(activity => activity.name).filter(Boolean))];
                    
                    const cityIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-slate-100"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`;
                    
                    const citiesHtml = uniqueCities.map(city => `
                        <div onclick="scrollToCity('${city.replace(/'/g, "\\'")}')" class="flex items-center gap-2 bg-white/20 px-3 py-1 rounded-full text-sm font-medium backdrop-blur-sm cursor-pointer hover:bg-white/30 transition-colors">
                            ${cityIcon}
                            <span style="color: #ffc95c; font-weight: 600;">${city}</span>
                        </div>
                    `).join('');
                    
                    citiesContainer.innerHTML = citiesHtml;
                }
            }
            
            document.getElementById('details-title').textContent = trip.name;
            document.getElementById('details-dates').textContent = `${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}`;
            
            const customLinkBtn = document.getElementById('custom-link-btn');
            if (trip.customLinkText && trip.customLinkUrl) {
                customLinkBtn.style.display = 'flex';
                customLinkBtn.querySelector('span').textContent = trip.customLinkText;
                customLinkBtn.onclick = () => window.open(trip.customLinkUrl, '_blank');
            } else {
                customLinkBtn.style.display = 'none';
            }

            renderDocuments(trip);
            renderNotes(trip); // RENDERIZAÇÃO DO NOVO PAINEL
            renderDailyItinerary(trip);
            renderLodgingCoverageStatus(trip);
            renderSpendingPanel(trip);
            renderSharedExpenses(trip);

            const flightTemplate = (flight, flightId, index, allFlights) => `
                <div>
                    <p class="font-semibold text-slate-800">${flight.origin} → ${flight.destination}</p>
                    <p class="text-sm text-slate-600">${flight.company} ${flight.code} - ${formatDate(flight.date)}</p>
                    <p class="text-xs text-slate-500">${flight.departureTime} - ${flight.arrivalTime}</p>
                </div>
                <div class="flex flex-col gap-2 items-center">
                    <div class="flex gap-1">
                        <button ${index === 0 ? 'disabled' : ''} onclick="reorderDetailItem('flights', '${flightId}', 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        </button>
                        <button ${index === allFlights.length - 1 ? 'disabled' : ''} onclick="reorderDetailItem('flights', '${flightId}', 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="m12 8 v8"/></svg>
                        </button>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditFlightModal('${flightId}')" class="p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button onclick="deleteDetailItem('flights', '${flightId}')" class="p-1 text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
            `;
            renderDetailList('flights-list', trip.flights, flightTemplate, 'Nenhum voo adicionado.');

            const transportTemplate = (item, transportId, index, allTransport) => `
                <div>
                    <p class="font-semibold text-slate-800">${item.type}</p>
                    <p class="text-sm text-slate-600">${item.from ? `${item.from} → ` : ''}${item.to ? item.to : ''}</p>
                    <p class="text-xs text-slate-500">Partida/Retirada: ${formatDate(item.departureDate)} às ${item.departureTime}</p>
                    <p class="text-xs text-slate-500">Chegada/Devolução: ${formatDate(item.arrivalDate)} às ${item.arrivalTime}</p>
                </div>
                <div class="flex flex-col gap-2 items-center">
                    <div class="flex gap-1">
                        <button ${index === 0 ? 'disabled' : ''} onclick="reorderDetailItem('transport', '${transportId}', 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        </button>
                        <button ${index === allTransport.length - 1 ? 'disabled' : ''} onclick="reorderDetailItem('transport', '${transportId}', 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="m12 8 v8"/></svg>
                        </button>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditTransportModal('${transportId}')" class="p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button onclick="deleteDetailItem('transport', '${transportId}')" class="p-1 text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
            `;
            renderDetailList('transport-list', trip.transport, transportTemplate, 'Nenhum transporte adicionado.');

            const lodgingTemplate = (item, lodgingId, index, allLodging) => `
                <div class="flex-1">
                    <p class="font-semibold text-slate-800">${item.name}</p>
                    <p class="text-sm text-slate-600">${item.address}</p>
                    <p class="text-xs text-slate-500">Check-in: ${formatDate(item.checkinDate)}</p>
                    <p class="text-xs text-slate-500">Check-out: ${formatDate(item.checkoutDate)} às ${item.checkoutTime}</p>
                    ${item.link ? `
                    <a href="${item.link}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="mt-2 inline-flex items-center gap-2 text-xs bg-slate-100 text-slate-700 font-semibold px-3 py-1.5 rounded-md hover:bg-slate-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line></svg>
                        <span>Acessar Link</span>
                    </a>` : ''}
                </div>
                <div class="flex flex-col gap-2 items-center">
                    <div class="flex gap-1">
                        <button ${index === 0 ? 'disabled' : ''} onclick="reorderDetailItem('lodging', '${lodgingId}', 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        </button>
                        <button ${index === allLodging.length - 1 ? 'disabled' : ''} onclick="reorderDetailItem('lodging', '${lodgingId}', 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="m12 8 v8"/></svg>
                        </button>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditLodgingModal('${lodgingId}')" class="p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button onclick="deleteDetailItem('lodging', '${lodgingId}')" class="p-1 text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
            `;
            renderDetailList('lodging-list', trip.lodging, lodgingTemplate, 'Nenhuma hospedagem adicionada.');
        }

        function renderDocuments(trip) {
            const listElement = document.getElementById('documents-list');
            listElement.innerHTML = '';
            const documents = trip.documents || [];

            if (documents.length === 0) {
                listElement.innerHTML = `<p class="text-slate-500 text-sm text-center py-2">Nenhum documento adicionado.</p>`;
                return;
            }

            documents.forEach((doc, index) => {
                const docElement = document.createElement('div');
                docElement.className = 'flex items-center justify-between p-2 rounded-md hover:bg-slate-50';
                docElement.innerHTML = `
                    <span class="text-slate-700">${doc.name}</span>
                    <div class="flex items-center gap-2">
                        <button ${index === 0 ? 'disabled' : ''} onclick="reorderDocument('${doc.id}', 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        </button>
                        <button ${index === documents.length - 1 ? 'disabled' : ''} onclick="reorderDocument('${doc.id}', 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="m12 8 v8"/></svg>
                        </button>
                        <button onclick="deleteDocument('${doc.id}')" class="text-slate-400 hover:text-red-600 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                `;
                listElement.appendChild(docElement);
            });
        }

        // NOVO: Função para renderizar as anotações
        // NOVO: Função para renderizar as anotações (COM AGRUPAMENTO POR AUTOR)
        function renderNotes(trip) {
            const listElement = document.getElementById('notes-list');
            listElement.innerHTML = '';
            const notes = trip.notes || [];

            if (notes.length === 0) {
                listElement.innerHTML = `<p class="text-slate-500 text-sm text-center py-2">Nenhuma anotação adicionada.</p>`;
                return;
            }

            // 1. Agrupa as anotações por autor
            const notesByAuthor = notes.reduce((acc, note) => {
                const author = note.author ? note.author.trim() : 'Sem autor';
                if (!acc[author]) {
                    acc[author] = [];
                }
                acc[author].push(note);
                return acc;
            }, {});

            // 2. Obtém os nomes dos autores e os ordena alfabeticamente
            const sortedAuthors = Object.keys(notesByAuthor).sort((a, b) => a.localeCompare(b));

            // 3. Itera sobre os autores ordenados e renderiza suas anotações
            sortedAuthors.forEach(author => {
                const authorNotes = notesByAuthor[author];
                
                // Cria um cabeçalho para o autor
                const authorHeader = document.createElement('div'); // Usamos div para mais flexibilidade
                authorHeader.className = 'mt-4 mb-2'; // Apenas margens no container
                // O <span> interno recebe o estilo de "tag" verde
                authorHeader.innerHTML = `<span class="inline-block bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-md">${author}</span>`;
                listElement.appendChild(authorHeader);

                // Renderiza cada anotação do autor
                authorNotes.forEach(note => {
                    const noteElement = document.createElement('div');
                    noteElement.className = 'flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 border border-slate-200 cursor-pointer';
                    
                    noteElement.dataset.title = note.title;
                    noteElement.dataset.author = note.author || 'Não especificado';
                    noteElement.dataset.description = note.description || 'Sem descrição.';
                    noteElement.dataset.link = note.link || '';
                    noteElement.dataset.icon = note.icon || 'note_food'; 
                    noteElement.onclick = () => openViewNoteModal(noteElement);

                    const iconSvg = ICONS[note.icon] || ICONS['note_food'];
                    const originalNoteIndex = notes.findIndex(n => n.id === note.id); // Pega o índice original para reordenação

                    noteElement.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="text-slate-500">
                               ${iconSvg.replace(/class="[^"]*"/, 'class="w-6 h-6"')}
                            </div>
                            <span class="text-slate-700 font-medium">${note.title}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button ${originalNoteIndex === 0 ? 'disabled' : ''} onclick="event.stopPropagation(); reorderNote('${note.id}', 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed text-slate-400 hover:text-slate-700">
                               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"></circle><path d="m16 12-4-4-4 4"></path><path d="M12 16V8"></path></svg>
                            </button>
                            <button ${originalNoteIndex === notes.length - 1 ? 'disabled' : ''} onclick="event.stopPropagation(); reorderNote('${note.id}', 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed text-slate-400 hover:text-slate-700">
                               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"></circle><path d="m8 12 4 4 4-4"></path><path d="m12 8 v8"></path></svg>
                            </button>
                            <button onclick="event.stopPropagation(); openEditNoteModal('${note.id}')" class="text-slate-400 hover:text-blue-600 p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>
                            </button>
                            <button onclick="event.stopPropagation(); deleteNote('${note.id}')" class="text-slate-400 hover:text-red-600 p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg>
                            </button>
                        </div>
                    `;
                    listElement.appendChild(noteElement);
                });
            });
        }
        
        function renderDailyItinerary(trip) {
            const container = document.getElementById('daily-itinerary-list');
            container.innerHTML = '';
            
            if (!trip.startDate || !trip.endDate) { return; }

            const allEvents = [];
            
            if (trip.flights) {
                Object.values(trip.flights).forEach(f => {
                    const flightData = { isEditable: false, ...f };
                    const eventName = `Voo ${f.company}`;
                    if (f.date && f.departureTime) {
                        allEvents.push({ dateTime: new Date(`${f.date}T${f.departureTime}`), name: eventName, description: `Partida de ${f.origin} para ${f.destination}`, icon: ICONS.flight_departure, data: flightData });
                    }
                    if (f.date && f.arrivalTime) {
                        let arrivalDateTime = new Date(`${f.date}T${f.arrivalTime}`);
                        if (arrivalDateTime < new Date(`${f.date}T${f.departureTime}`)) {
                            arrivalDateTime.setDate(arrivalDateTime.getDate() + 1);
                        }
                        allEvents.push({ dateTime: arrivalDateTime, name: eventName, description: `Chegada em ${f.destination}`, icon: ICONS.flight_arrival, data: flightData });
                    }
                });
            }
            if (trip.transport) {
                Object.values(trip.transport).forEach(t => {
                    let eventIcon;
                    const transportData = { isEditable: false, ...t };

                    switch (t.type) {
                        case 'Carro Alugado': 
                            eventIcon = ICONS.car;
                            if (t.departureDate && t.departureTime) allEvents.push({ dateTime: new Date(`${t.departureDate}T${t.departureTime}`), name: `Retirada de Carro`, description: t.description || 'Detalhes do aluguel', icon: eventIcon, data: transportData });
                            if (t.arrivalDate && t.arrivalTime) allEvents.push({ dateTime: new Date(`${t.arrivalDate}T${t.arrivalTime}`), name: `Devolução de Carro`, description: t.description || 'Detalhes da devolução', icon: eventIcon, data: transportData });
                            break;
                        case 'Trem':
                        case 'Ônibus':
                        default:
                            eventIcon = t.type === 'Trem' ? ICONS.train : (t.type === 'Ônibus' ? ICONS.bus : ICONS.transport_other);
                            if (t.departureDate && t.departureTime) allEvents.push({ dateTime: new Date(`${t.departureDate}T${t.departureTime}`), name: `Partida (${t.type})`, description: `De ${t.from || '?'} para ${t.to || '?'}`, icon: eventIcon, data: transportData });
                            if (t.arrivalDate && t.arrivalTime) allEvents.push({ dateTime: new Date(`${t.arrivalDate}T${t.arrivalTime}`), name: `Chegada (${t.type})`, description: `Em ${t.to || '?'}`, icon: eventIcon, data: transportData });
                    }
                });
            }
            if (trip.lodging) {
                Object.values(trip.lodging).forEach(l => {
                    const lodgingData = { isEditable: false, ...l };
                    if (l.checkinDate && l.checkinTime) allEvents.push({ dateTime: new Date(`${l.checkinDate}T${l.checkinTime}`), name: `Check-in`, description: l.name, icon: ICONS.lodging_checkin, data: lodgingData });
                    if (l.checkoutDate && l.checkoutTime) allEvents.push({ dateTime: new Date(`${l.checkoutDate}T${l.checkoutTime}`), name: `Check-out`, description: l.name, icon: ICONS.lodging_checkout, data: lodgingData });
                });
            }
            if (trip.activities) {
                Object.values(trip.activities).forEach(a => {
                    const activityIcon = ICONS[a.icon] || ICONS.default;
                    if(a.date && a.time) allEvents.push({ dateTime: new Date(`${a.date}T${a.time}`), name: a.name || 'Atividade', description: a.description || '', icon: activityIcon, data: { isEditable: true, ...a } });
                });
            }

            allEvents.sort((a,b) => a.dateTime - b.dateTime);

            const groupedByDay = allEvents.reduce((acc, event) => {
                const date = new Date(event.dateTime);
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                const day = date.toISOString().split('T')[0];
                if (!acc[day]) acc[day] = [];
                acc[day].push(event);
                return acc;
            }, {});
            
            const cityAnchorsCreated = new Set();
            const startDate = new Date(trip.startDate + 'T00:00:00Z');
            const endDate = new Date(trip.endDate + 'T00:00:00Z');
            const totalTripDays = Math.round((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;
            let dayCounter = 1;

            let currentDate = new Date(trip.startDate + 'T00:00:00Z');
            
            container.innerHTML += `<div class="insertion-point" onclick="insertNewDay(0)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>Inserir Novo Dia</span>
            </div>`;
            
            while(currentDate <= endDate) {
                const dayKey = currentDate.toISOString().split('T')[0];
                const dayEvents = groupedByDay[dayKey] || [];
                
                const dayPanel = document.createElement('div');
                dayPanel.className = 'day-panel border-t pt-6 space-y-4';
                dayPanel.dataset.date = dayKey;
                
                for (const event of dayEvents) {
                    if (event.data.isEditable && event.data.type === 'Cidade') {
                        const cityName = event.data.name;
                        if (!cityAnchorsCreated.has(cityName)) {
                            dayPanel.id = `itinerary-day-${cityName.toLowerCase().replace(/\s+/g, '-')}`;
                            cityAnchorsCreated.add(cityName);
                            break; 
                        }
                    }
                }
                
                let eventsHtml = dayEvents.map(event => {
                    const { isEditable, ...eventData } = event.data;
                    const datasetAttributes = Object.entries(eventData)
                        .map(([key, value]) => `data-${key.toLowerCase()}="${String(value || '').replace(/"/g, '&quot;')}"`)
                        .join(' ');
                    
                    let bgColorStyle = '';
                    if (isEditable) {
                        if (eventData.type === 'Cidade') {
                            bgColorStyle = 'background-color: #F4C664;';
                        } else {
                            bgColorStyle = 'background-color: #e6f1ff;';
                        }
                    }
                    const time = event.dateTime.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});

                    return `
                    <div 
                        class="activity-item flex items-center justify-between gap-4 p-2 rounded-md cursor-pointer hover:bg-slate-100" 
                        style="${bgColorStyle}"
                        onclick='openViewActivityModal(this)'
                        data-icon='${event.icon}'
                        data-time="${time}"
                        data-name="${(event.name || '').replace(/"/g, '&quot;')}"
                        data-description="${(event.description || '').replace(/"/g, '&quot;')}"
                        data-iseditable="${isEditable}"
                        data-activity-id="${eventData.id || ''}"
                        ${datasetAttributes}
                    >
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                             <svg class="activity-drag-handle" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
                            <span class="font-bold text-sm w-12 text-right flex-shrink-0">${time}</span>
                            <div class="flex items-center gap-2 text-slate-500 flex-shrink-0">${event.icon || ''}</div>
                            <p class="text-sm text-slate-700 truncate">
                                <strong class="font-semibold">${event.name}</strong>
                                ${event.description ? ` | ${event.description}` : ''}
                            </p>
                        </div>
                        ${isEditable ? `
                        <div class="flex gap-2 items-center flex-shrink-0">
                            <button onclick="event.stopPropagation(); openEditActivityModal('${event.data.id}')" class="text-slate-500 hover:text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                            </button>
                            <button onclick="event.stopPropagation(); deleteActivity('${event.data.id}')" class="text-slate-500 hover:text-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `}).join('');

                if (dayEvents.length === 0) {
                    eventsHtml = '<p class="text-sm text-slate-400 py-2 ml-4">Nenhuma atividade para este dia.</p>';
                }

                dayPanel.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                         <div class="flex items-center gap-3">
                            <svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
                            <h3 class="font-bold text-lg text-slate-800">${dayCounter}/${totalTripDays} | ${formatDate(dayKey, {weekday: 'long', day: 'numeric', month: 'long'})}</h3>
                        </div>
                        <div class="flex items-center gap-2">
                             <button onclick="deleteDay('${dayKey}')" class="delete-day-btn flex items-center justify-center w-10 h-10 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                            <button onclick="openAddActivityModal('${dayKey}')" class="add-activity-btn flex items-center justify-center w-10 h-10 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition-colors">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div class="activity-list border-l-2 border-slate-100 pl-2 space-y-1" data-date="${dayKey}">
                        ${eventsHtml}
                    </div>
                `;
                container.appendChild(dayPanel);

                container.innerHTML += `<div class="insertion-point" onclick="insertNewDay(${dayCounter})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span>Inserir Novo Dia</span>
                </div>`;

                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                dayCounter++;
            }
        }
        
        function renderDetailList(elementId, items, itemTemplate, emptyMessage) {
            const listElement = document.getElementById(elementId);
            listElement.innerHTML = '';
            // 'items' agora é um objeto. Verificamos se ele está vazio.
            if (!items || Object.keys(items).length === 0) {
                listElement.innerHTML = `<p class="text-slate-500 text-sm">${emptyMessage}</p>`;
                return;
            }
            // Convertemos o objeto para um array de pares [id, dados]
            const itemsArray = Object.entries(items);

            itemsArray.forEach(([itemId, itemData], index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-start border-l-4 border-slate-200 pl-4 py-2';
                // Agora passamos o ID do item para a função de template!
                itemDiv.innerHTML = itemTemplate(itemData, itemId, index, itemsArray);
                listElement.appendChild(itemDiv);
            });
        }
        
        function setupTripsListener() {
            const user = auth.currentUser;
            if (!user) return;

            // A referência para a lista de viagens do usuário continua a mesma
            const memberOfRef = ref(db, `users/${user.uid}/memberOf`);

            // Este listener principal descobre QUAIS viagens o usuário tem
            onValue(memberOfRef, (snapshot) => {
                const tripIdsObject = snapshot.val() || {};
                const newTripIds = Object.keys(tripIdsObject);

                // --- Gerenciamento Inteligente de Listeners ---

                // 1. Desconecta listeners de viagens que o usuário não tem mais acesso
                Object.keys(activeTripListeners).forEach(tripId => {
                    if (!newTripIds.includes(tripId)) {
                        const { unsubscribe } = activeTripListeners[tripId];
                        unsubscribe(); // Desconecta o "ouvinte" daquela viagem
                        delete activeTripListeners[tripId];
                        console.log(`Listener para a viagem ${tripId} desconectado.`);
                    }
                });

                // Remove viagens antigas da lista local
                tripsData = tripsData.filter(trip => newTripIds.includes(trip.id));

                // 2. Conecta listeners para CADA viagem, individualmente
                newTripIds.forEach(tripId => {
                    // Só conecta se já não estivermos "ouvindo" esta viagem
                    if (!activeTripListeners[tripId]) {
                        const tripRef = ref(db, `trips/${tripId}`);
                        
                        // onValue retorna uma função "unsubscribe" que podemos usar para desconectar depois
                        const unsubscribe = onValue(tripRef, (tripSnapshot) => {
                            if (tripSnapshot.exists()) {
                                const updatedTrip = { id: tripSnapshot.key, ...tripSnapshot.val() };
                                
                                // Atualiza ou adiciona a viagem na nossa lista de dados local
                                const index = tripsData.findIndex(t => t.id === updatedTrip.id);
                                if (index > -1) {
                                    tripsData[index] = updatedTrip; // Atualiza a viagem existente
                                } else {
                                    tripsData.push(updatedTrip); // Adiciona a nova viagem
                                }

                                // Reordena e redesenha a tela com os dados atualizados
                                tripsData.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                                renderCurrentView(); // Esta é a função que redesenha a tela
                            } else {
                                // Se a viagem foi deletada da base de dados, removemos da lista local
                                tripsData = tripsData.filter(t => t.id !== tripId);
                                renderCurrentView();
                            }
                        });

                        // Guarda a função de "unsubscribe" para uso futuro
                        activeTripListeners[tripId] = { unsubscribe };
                        console.log(`Listener para a viagem ${tripId} conectado.`);
                    }
                });

                // Se o usuário não tiver mais nenhuma viagem, limpa a tela
                if (newTripIds.length === 0) {
                    tripsData = [];
                    activeTripListeners = {};
                    renderCurrentView();
                }
            });
        }

        function renderCurrentView() {
            const trip = tripsData.find(t => t.id === currentTripId);

            if (currentTripId && trip) {
                // Se temos um ID de viagem ativo e essa viagem existe, renderiza os detalhes
                renderTripDetails(currentTripId);
            } else {
                // Caso contrário, mostra a lista de viagens
                renderTripLists();
                showTripsView(); // Garante que a tela correta está visível
            }
        }

          function setupIconPickers() {
            const activityIconOptions = {
                passeio: ICONS.passeio, restaurante: ICONS.restaurante, shopping: ICONS.shopping, music: ICONS.music,
                building: ICONS.building, tree: ICONS.tree, leaf: ICONS.leaf, sun: ICONS.sun, cake: ICONS.cake, 
                mountain: ICONS.mountain, ferris_wheel: ICONS.ferris_wheel, basketball: ICONS.basketball, 
                waves: ICONS.waves, sunglasses: ICONS.sunglasses,
                outro: ICONS.outro
            };
            
            const noteIconOptions = {
                note_food: ICONS.note_food, note_market: ICONS.note_market, note_star: ICONS.note_star,
                note_remedy: ICONS.note_remedy, note_alert: ICONS.note_alert, note_tag: ICONS.note_tag,
                note_backpack: ICONS.note_backpack, note_money: ICONS.note_money, note_gift: ICONS.note_gift,
                note_heart: ICONS.note_heart
            };

            const populatePicker = (pickerId, iconSet) => {
                const picker = document.getElementById(pickerId);
                picker.innerHTML = '';
                for (const [name, svg] of Object.entries(iconSet)) {
                    if (!svg) {
                        console.warn(`Icon '${name}' is missing in ICONS object.`);
                        continue;
                    }
                    const option = document.createElement('div');
                    option.className = 'icon-picker-option cursor-pointer p-2 border-2 border-slate-200 rounded-full';
                    option.dataset.icon = name;
                    option.innerHTML = svg.replace(/w-[\d_]+ h-[\d_]+/, 'w-6 h-6');
                    picker.appendChild(option);
                }
            };

            const handlePickerClick = (e, formId) => {
                const target = e.target.closest('.icon-picker-option');
                if (!target) return;

                const iconName = target.dataset.icon;
                const picker = target.parentElement;
                const hiddenInput = document.getElementById(formId);

                hiddenInput.value = iconName;

                picker.querySelectorAll('.icon-picker-option').forEach(opt => opt.classList.remove('selected'));
                target.classList.add('selected');
            };

            populatePicker('add-icon-picker', activityIconOptions);
            populatePicker('edit-icon-picker', activityIconOptions);
            populatePicker('add-note-icon-picker', noteIconOptions);
            populatePicker('edit-note-icon-picker', noteIconOptions);


            document.getElementById('add-icon-picker').addEventListener('click', (e) => handlePickerClick(e, 'activity-icon'));
            document.getElementById('edit-icon-picker').addEventListener('click', (e) => handlePickerClick(e, 'edit-activity-icon'));
            document.getElementById('add-note-icon-picker').addEventListener('click', (e) => handlePickerClick(e, 'note-icon'));
            document.getElementById('edit-note-icon-picker').addEventListener('click', (e) => handlePickerClick(e, 'edit-note-icon'));
        }

        function renderLodgingCoverageStatus(trip) {
            const statusDot = document.getElementById('lodging-status-dot');
            if (!trip.startDate || !trip.endDate) {
                statusDot.style.display = 'none';
                return;
            }

            const requiredNights = [];
            let currentDate = new Date(trip.startDate + 'T00:00:00Z');
            const endDate = new Date(trip.endDate + 'T00:00:00Z');
            while (currentDate < endDate) {
                requiredNights.push(currentDate.toISOString().split('T')[0]);
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            }

            const coveredNights = new Set();
            const lodgings = trip.lodging ? Object.values(trip.lodging) : [];
            let totalCost = 0;
            
            lodgings.forEach(l => {
                let checkin = new Date(l.checkinDate + 'T00:00:00Z');
                const checkout = new Date(l.checkoutDate + 'T00:00:00Z');
                while (checkin < checkout) {
                    coveredNights.add(checkin.toISOString().split('T')[0]);
                    checkin.setUTCDate(checkin.getUTCDate() + 1);
                }
                if (l.cost && !isNaN(parseFloat(l.cost))) {
                    totalCost += parseFloat(l.cost);
                }
            });

            const missingNights = requiredNights.filter(night => !coveredNights.has(night));

            const modalTitle = document.getElementById('lodging-coverage-modal-title');
            const modalBody = document.getElementById('lodging-coverage-modal-body');
            const modalIcon = document.getElementById('lodging-coverage-modal-icon');
            const totalCostDisplay = document.getElementById('lodging-total-cost-display');

            const formattedCost = totalCost.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            if (totalCost > 0) {
                totalCostDisplay.innerHTML = `Custo Total Estimado: <strong>${formattedCost}</strong>`;
                totalCostDisplay.style.display = 'block';
            } else {
                totalCostDisplay.style.display = 'none';
            }

            if (missingNights.length === 0 && requiredNights.length > 0) {
                statusDot.style.backgroundColor = '#22c55e'; // Verde
                statusDot.onclick = () => {
                    modalTitle.textContent = "Cobertura de Hospedagem Completa";
                    modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`;
                    modalBody.innerHTML = `<p>Todas as ${requiredNights.length} noites da sua viagem possuem hospedagem agendada.</p>`;
                    openModal('lodging-coverage-modal');
                };
            } else {
                statusDot.style.backgroundColor = '#ef4444'; // Vermelho
                statusDot.onclick = () => {
                    modalTitle.textContent = "Hospedagem Incompleta";
                     modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>`;
                    if (requiredNights.length === 0) {
                         modalBody.innerHTML = `<p>A viagem não tem noites (começa e termina no mesmo dia).</p>`;
                    } else {
                         modalBody.innerHTML = `
                            <p>Está faltando agendar hospedagem para <strong>${missingNights.length} noite(s)</strong>:</p>
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                ${missingNights.map(night => `<li>${formatDate(night, {weekday: 'short', day: 'numeric', month: 'long'})}</li>`).join('')}
                            </ul>
                        `;
                    }
                    openModal('lodging-coverage-modal');
                };
            }
             statusDot.style.display = 'block';
        }
        
        function renderSpendingPanel(trip) {
            const listElement = document.getElementById('spending-list');
            const totalElement = document.getElementById('spending-total-display');
            listElement.innerHTML = '';
            totalElement.innerHTML = '';

            const allExpenses = [];
            let totalCost = 0;

            const categoryMap = {
                flights: 'Voos',
                transport: 'Transportes',
                lodging: 'Hospedagens',
                activities: 'Atividades'
            };

            for (const category in categoryMap) {
                if (trip[category]) {
                    Object.values(trip[category]).forEach(item => {
                        const cost = parseFloat(item.cost);
                        if (!isNaN(cost) && cost > 0) {
                            let name = 'Item';
                            if (category === 'flights') name = `${item.company}: ${item.origin} → ${item.destination}`;
                            else if (category === 'transport') name = `${item.type}: ${item.from || ''} → ${item.to || ''}`;
                            else if (category === 'lodging') name = `Hospedagem: ${item.name}`;
                            else if (category === 'activities') name = `Atividade: ${item.name}`;
                            
                            allExpenses.push({
                                category: categoryMap[category],
                                name: name,
                                cost: cost
                            });
                            totalCost += cost;
                        }
                    });
                }
            }

            if (allExpenses.length === 0) {
                listElement.innerHTML = `<p class="text-slate-500 text-sm text-center py-2">Nenhum gasto adicionado ainda.</p>`;
                totalElement.innerHTML = `Total Geral: ${formatCurrency(0)}`;
                return;
            }

            const groupedExpenses = allExpenses.reduce((acc, expense) => {
                if (!acc[expense.category]) {
                    acc[expense.category] = [];
                }
                acc[expense.category].push(expense);
                return acc;
            }, {});

            for (const categoryName in groupedExpenses) {
                const groupItems = groupedExpenses[categoryName];
                let groupSubtotal = 0;

                const groupHtml = document.createElement('div');
                
                let itemsHtml = groupItems.map(item => {
                    groupSubtotal += item.cost;
                    return `
                        <div class="flex justify-between items-center text-sm text-slate-600 pl-4 py-1">
                            <span>${item.name}</span>
                            <span class="font-medium">${formatCurrency(item.cost)}</span>
                        </div>
                    `;
                }).join('');

let dividerHtml = '';
                if (categoryName === 'Transportes' || categoryName === 'Hospedagens') {
                    const categoryKey = categoryName.replace(/\s+/g, '');

                    // NOVO: Lê o valor salvo no banco de dados para esta categoria
                    const savedDivider = trip.dividers?.[categoryKey] || '';
                    
                    // NOVO: Calcula o resultado inicial se já houver um divisor salvo
                    let initialResultText = '';
                    if (savedDivider && savedDivider > 0) {
                        const result = groupSubtotal / savedDivider;
                        initialResultText = `= ${formatCurrency(result)} por pessoa`;
                    }

                    dividerHtml = `
                        <div class="flex items-center gap-2 text-sm mt-2 text-slate-600 pl-4">
                            <span>(Div. por</span>
                            <input type="number" min="1"
                                   value="${savedDivider}" 
                                   oninput="saveDivider('${currentTripId}', '${categoryKey}', this.value)"
                                   class="w-16 px-2 py-1 border border-slate-300 rounded-md shadow-sm text-center focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <span>pessoas)</span>
                            <strong class="text-blue-600 font-bold ml-2">${initialResultText}</strong>
                        </div>
                    `;
                }

                groupHtml.innerHTML = `
                    <div class="border-b pb-2">
                        <div class="flex justify-between items-baseline">
                            <h3 class="font-semibold text-lg text-slate-800">${categoryName}</h3>
                            <span class="font-semibold text-slate-700">${formatCurrency(groupSubtotal)}</span>
                        </div>
                       ${dividerHtml}
                        <div class="mt-1 space-y-1">${itemsHtml}</div>
                    </div>
                `;
                listElement.appendChild(groupHtml);
            }

            totalElement.innerHTML = `Total Geral: ${formatCurrency(totalCost)}`;
        }

        
        // --- CONTROLE DE NAVEGAÇÃO, MODAIS E FORMULÁRIOS ---
        window.scrollToCity = (cityName) => {
            const targetId = `itinerary-day-${cityName.toLowerCase().replace(/\s+/g, '-')}`;
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                console.warn(`Âncora para a cidade "${cityName}" não encontrada.`);
            }
        };
        
        window.showTripsView = () => {
            currentTripId = null; 
            history.pushState({ view: 'trips' }, 'Todas as Viagens', '#');

            // --- A LÓGICA CORRETA DE NAVEGAÇÃO ---
            // Mostra o painel da lista de viagens
            document.getElementById('trips-view').classList.remove('hidden');
            // Esconde o painel de detalhes
            document.getElementById('details-view').classList.add('hidden');

            // Esconde o botão flutuante de "voltar"
            document.getElementById('back-to-trips-btn').classList.add('hidden');
        };

        window.showTripDetails = (tripId) => {
            currentTripId = tripId;
            history.pushState({ view: 'details', tripId: tripId }, 'Detalhes da Viagem', '#trip=' + tripId);
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Prepara os painéis internos para a visualização
            document.getElementById('documents-panel').classList.add('collapsed');
            document.getElementById('spending-panel').classList.add('collapsed');
            document.getElementById('notes-panel').classList.remove('collapsed');

            // Carrega os dados da viagem
            renderTripDetails(tripId);

            // --- A LÓGICA CORRETA DE NAVEGAÇÃO ---
            // Esconde APENAS o painel da lista de viagens
            document.getElementById('trips-view').classList.add('hidden');
            // Mostra o painel de detalhes
            document.getElementById('details-view').classList.remove('hidden');

            // Mostra o botão flutuante de "voltar"
            document.getElementById('back-to-trips-btn').classList.remove('hidden');
        };
        
        window.toggleDocumentsPanel = () => {
            document.getElementById('documents-panel').classList.toggle('collapsed');
        }

        // NOVO: Função para controlar o painel de anotações
        window.toggleNotesPanel = () => {
            document.getElementById('notes-panel').classList.toggle('collapsed');
        }

        window.toggleSpendingPanel = () => {
            const panel = document.getElementById('spending-panel');
            const isOpening = panel.classList.contains('collapsed');
            panel.classList.toggle('collapsed');

            if (isOpening) {
                setTimeout(() => {
                    panel.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 150);
            }
        }

window.scrollToSectionAndClose = (targetId, modalId) => {
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            closeModal(modalId);
        };

        window.openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            modal.classList.replace('hidden', 'flex');

            // --- INÍCIO DA LÓGICA CORRIGIDA ---
            // Se o modal que estamos abrindo é o de notificações, marque-as como lidas.
            if (modalId === 'notifications-modal') {
                const notificationsRef = ref(db, `users/${currentUserId}/notifications`);
                get(notificationsRef).then(snapshot => {
                    if (snapshot.exists()) {
                        const updates = {};
                        snapshot.forEach(childSnapshot => {
                            if (!childSnapshot.val().isRead) {
                                updates[`${childSnapshot.key}/isRead`] = true;
                            }
                        });
                        if (Object.keys(updates).length > 0) {
                            update(notificationsRef, updates);
                        }
                    }
                });
            }
            // --- FIM DA LÓGICA CORRIGIDA ---

            if (modalId === 'add-note-modal') {
                document.getElementById('note-author-display').textContent = currentUserProfile.fullName || 'Usuário';
            }

            if (currentTripId) {
                const trip = tripsData.find(t => t.id === currentTripId);
                if (trip && trip.startDate) {
                    const tripStartDate = trip.startDate;
                    
                    if (modalId === 'add-flight-modal') {
                        document.getElementById('flight-date').value = tripStartDate;
                    } else if (modalId === 'add-transport-modal') {
                        document.getElementById('transport-departure-date').value = tripStartDate;
                        document.getElementById('transport-arrival-date').value = tripStartDate;
                    } else if (modalId === 'add-lodging-modal') {
                        document.getElementById('lodging-checkin-date').value = tripStartDate;
                        document.getElementById('lodging-checkout-date').value = tripStartDate;
                    }
                }
            }
        };

        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.replace('flex', 'hidden');
            const form = document.getElementById(modalId).querySelector('form');
            if (form) form.reset();
            
            // Verificação específica para o modal de exclusão
            if (modalId === 'confirm-delete-modal') {
                onConfirmAction = () => {};

                // Se o modal for fechado, o timer é cancelado
                if (confirmDeleteTimer) {
                    clearTimeout(confirmDeleteTimer);
                    confirmDeleteTimer = null;
                }

                // E o botão de exclusão é resetado imediatamente
                const deleteBtn = document.getElementById('confirm-delete-btn');
                deleteBtn.disabled = false;
                deleteBtn.classList.remove('bg-slate-400', 'cursor-not-allowed');
                deleteBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                deleteBtn.textContent = 'Excluir';
            }
        }
        
        window.scrollToItinerary = () => {
            const itineraryPanel = document.getElementById('daily-itinerary-panel');
            if (itineraryPanel) {
                itineraryPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };

        window.scrollToTop = () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.openEditTripModal = () => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            document.getElementById('edit-trip-name').value = trip.name;
            document.getElementById('edit-trip-destination').value = trip.destination;
            document.getElementById('edit-trip-start-date').value = trip.startDate;
            document.getElementById('edit-trip-end-date').value = trip.endDate;
            document.getElementById('edit-trip-image-url').value = trip.imageUrl || '';
            document.getElementById('edit-trip-link-text').value = trip.customLinkText || '';
            document.getElementById('edit-trip-link-url').value = trip.customLinkUrl || '';

            renderTravelersList(currentTripId); // <-- ADICIONE ESTA LINHA AQUI

            setupAutocomplete(); // Ativa o sistema de sugestões

            openModal('edit-trip-modal');
        };

        window.openViewActivityModal = (element) => {
            const isReorganizingActive = document.getElementById('daily-itinerary-list').classList.contains('is-reorganizing');
            if (isReorganizingActive) return;

            const ds = element.dataset;
            document.getElementById('view-activity-icon').innerHTML = ds.icon.replace('w-5 h-5', 'w-8 h-8');
            document.getElementById('view-activity-name').textContent = ds.name;
            document.getElementById('view-activity-time').textContent = ds.time;

            const typeElement = document.getElementById('view-activity-type');
            if (ds.type && ds.iseditable === 'true') {
                typeElement.textContent = ds.type;
                typeElement.style.display = 'inline-block';
            } else {
                typeElement.style.display = 'none';
            }
            
            const descriptionElement = document.getElementById('view-activity-description');
            descriptionElement.textContent = ds.description;
            descriptionElement.style.display = ds.description ? 'block' : 'none';

            const detailsList = document.getElementById('view-activity-details-list');
            let detailsHtml = '';

            if (ds.iseditable !== 'true') {
                 detailsHtml += `<p class="font-semibold text-base text-slate-800">${ds.name}</p>`;
            }

            if (ds.from || ds.to) {
                detailsHtml += `<p class="mt-2"><strong class="font-semibold text-slate-600">Trajeto:</strong> ${ds.from || 'N/A'} → ${ds.to || 'N/A'}</p>`;
            }
            if(ds.address) {
                detailsHtml += `<p class="mt-2"><strong class="font-semibold text-slate-600">Endereço:</strong> ${ds.address}</p>`;
            }
            
            if (ds.description && ds.iseditable !== 'true') {
                 detailsHtml += `<p class="mt-2"><strong class="font-semibold text-slate-600">Detalhes:</strong> ${ds.description}</p>`;
            }

            detailsList.innerHTML = detailsHtml;
            detailsList.style.display = detailsHtml ? 'block' : 'none';

            const linkContainer = document.getElementById('view-activity-link-container');
            const linkBtn = document.getElementById('view-activity-link-btn');
            
            if (ds.link && ds.link.trim() !== '' && ds.link.trim() !== 'undefined') {
                linkBtn.href = ds.link;
                linkContainer.style.display = 'block';
            } else {
                linkContainer.style.display = 'none';
            }

            const searchContainer = document.getElementById('view-activity-search-container');
            const searchBtn = document.getElementById('view-activity-search-btn');

            if (ds.name && ds.iseditable === 'true') {
                searchContainer.style.display = 'block';
                searchBtn.onclick = () => {
                    window.open(`https://www.google.com/search?q=${encodeURIComponent(ds.name)}`, '_blank');
                };
            } else {
                searchContainer.style.display = 'none';
            }

            openModal('view-activity-modal');
        }

        // NOVO: Funções para abrir os modais de anotação
        window.openViewNoteModal = (element) => {
            const ds = element.dataset;
            document.getElementById('view-note-title').textContent = ds.title;
            document.getElementById('view-note-author').textContent = `Por: ${ds.author}`;
            document.getElementById('view-note-description').textContent = ds.description;
            document.getElementById('view-note-description-container').style.display = ds.description ? 'block' : 'none';
            
            const linkContainer = document.getElementById('view-note-link-container');
            const linkBtn = document.getElementById('view-note-link-btn');
            if (ds.link) {
                linkBtn.href = ds.link;
                linkContainer.style.display = 'block';
            } else {
                linkContainer.style.display = 'none';
            }
            openModal('view-note-modal');
        }

        window.openEditNoteModal = (noteId) => {
            const trip = tripsData.find(t => t.id === currentTripId);
            const note = trip?.notes?.find(n => n.id === noteId);
            if (!note) return;

            currentEditingItemId = noteId;
            document.getElementById('edit-note-id').value = note.id;
            document.getElementById('edit-note-title').value = note.title;
            //populateTravelersDropdown('edit-note-author', note.author);
            document.getElementById('edit-note-description').value = note.description || '';
            document.getElementById('edit-note-link').value = note.link || '';
            
            // Lógica para selecionar o ícone
            const noteIcon = note.icon || 'note_food';
            document.getElementById('edit-note-icon').value = noteIcon;
            const picker = document.getElementById('edit-note-icon-picker');
            picker.querySelectorAll('.icon-picker-option').forEach(opt => opt.classList.remove('selected'));
            const selectedIconEl = picker.querySelector(`[data-icon="${noteIcon}"]`);
            if (selectedIconEl) {
                selectedIconEl.classList.add('selected');
            }

            openModal('edit-note-modal');
        }
        
        window.openEditFlightModal = (flightId) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            const flight = trip?.flights?.[flightId]; // Busca o item pelo ID
            if (!flight) return;

            currentEditingItemId = flightId; // Armazena o ID para usar ao salvar
            document.getElementById('edit-flight-leg-type').value = flight.legType;
            document.getElementById('edit-flight-date').value = flight.date;
            document.getElementById('edit-flight-departure-time').value = flight.departureTime;
            document.getElementById('edit-flight-arrival-time').value = flight.arrivalTime;
            document.getElementById('edit-flight-origin').value = flight.origin;
            document.getElementById('edit-flight-destination').value = flight.destination;
            document.getElementById('edit-flight-company').value = flight.company;
            document.getElementById('edit-flight-code').value = flight.code;
            document.getElementById('edit-flight-type').value = flight.flightType;
            document.getElementById('edit-flight-cost').value = flight.cost || '';
            openModal('edit-flight-modal');
        }

        window.openEditTransportModal = (transportId) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            const transport = trip?.transport?.[transportId]; // Busca o item pelo ID
            if (!transport) return;

            currentEditingItemId = transportId; // Armazena o ID
            document.getElementById('edit-transport-type').value = transport.type;
            document.getElementById('edit-transport-origin').value = transport.from;
            document.getElementById('edit-transport-destination').value = transport.to;
            document.getElementById('edit-transport-description').value = transport.description;
            document.getElementById('edit-transport-departure-date').value = transport.departureDate;
            document.getElementById('edit-transport-departure-time').value = transport.departureTime;
            document.getElementById('edit-transport-arrival-date').value = transport.arrivalDate;
            document.getElementById('edit-transport-arrival-time').value = transport.arrivalTime;
            document.getElementById('edit-transport-cost').value = transport.cost || '';
            document.getElementById('edit-transport-type').dispatchEvent(new Event('change'));
            openModal('edit-transport-modal');
        }
        
        window.openEditLodgingModal = (lodgingId) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            const lodging = trip?.lodging?.[lodgingId]; // Busca o item pelo ID
            if (!lodging) return;

            currentEditingItemId = lodgingId; // Armazena o ID
            document.getElementById('edit-lodging-name').value = lodging.name;
            document.getElementById('edit-lodging-address').value = lodging.address;
            document.getElementById('edit-lodging-checkin-date').value = lodging.checkinDate;
            document.getElementById('edit-lodging-checkin-time').value = lodging.checkinTime;
            document.getElementById('edit-lodging-checkout-date').value = lodging.checkoutDate;
            document.getElementById('edit-lodging-checkout-time').value = lodging.checkoutTime;
            document.getElementById('edit-lodging-cost').value = lodging.cost || '';
            document.getElementById('edit-lodging-link').value = lodging.link || '';
            openModal('edit-lodging-modal');
        }

        window.openEditActivityModal = (activityId) => {
            event.stopPropagation();
            const trip = tripsData.find(t => t.id === currentTripId);
            const activity = Object.values(trip.activities).find(a => a.id === activityId);
            if (activity) {
                document.getElementById('edit-activity-id').value = activity.id;
                document.getElementById('edit-activity-time').value = activity.time;
                document.getElementById('edit-activity-name').value = activity.name || '';
                document.getElementById('edit-activity-type').value = activity.type;
                document.getElementById('edit-activity-description').value = activity.description || '';
                document.getElementById('edit-activity-link').value = activity.link || '';
                document.getElementById('edit-activity-cost').value = activity.cost || '';
                document.getElementById('edit-activity-icon').value = activity.icon;

                const picker = document.getElementById('edit-icon-picker');
                picker.querySelectorAll('.icon-picker-option').forEach(opt => opt.classList.remove('selected'));
                const selectedIcon = picker.querySelector(`[data-icon="${activity.icon}"]`);
                if(selectedIcon) selectedIcon.classList.add('selected');
                
                openModal('edit-activity-modal');
            }
        };

        function showConfirmDelete(message, onConfirm) {
            document.getElementById('confirm-delete-message').innerText = message;
            onConfirmAction = onConfirm;
            
            const deleteBtn = document.getElementById('confirm-delete-btn');
            
            // Desabilita o botão imediatamente
            deleteBtn.disabled = true;
            deleteBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            deleteBtn.classList.add('bg-slate-400', 'cursor-not-allowed');
            deleteBtn.textContent = 'Aguarde 2s...';

            openModal('confirm-delete-modal');

            // Limpa qualquer timer anterior para garantir que não haja sobreposição
            if (confirmDeleteTimer) {
                clearTimeout(confirmDeleteTimer);
            }
            
            // Define um timer para reabilitar o botão após 2 segundos
            confirmDeleteTimer = setTimeout(() => {
                deleteBtn.disabled = false;
                deleteBtn.classList.remove('bg-slate-400', 'cursor-not-allowed');
                deleteBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                deleteBtn.textContent = 'Excluir';
            }, 2000); // 2000 milissegundos = 2 segundos
        }

        async function addDetail(category) {
            if (!currentTripId) return;

            let newItem = {};
            // A lógica para pegar os dados do formulário continua a mesma
            if (category === 'flights') {
                newItem = { 
                    legType: document.getElementById('flight-leg-type').value, date: document.getElementById('flight-date').value, departureTime: document.getElementById('flight-departure-time').value, arrivalTime: document.getElementById('flight-arrival-time').value, origin: document.getElementById('flight-origin').value, destination: document.getElementById('flight-destination').value, company: document.getElementById('flight-company').value, code: document.getElementById('flight-code').value, flightType: document.getElementById('flight-type').value,
                    cost: document.getElementById('flight-cost').value,
                };
            } else if (category === 'transport') {
                newItem = { 
                    type: document.getElementById('transport-type').value, from: document.getElementById('transport-origin').value, to: document.getElementById('transport-destination').value, description: document.getElementById('transport-description').value, departureDate: document.getElementById('transport-departure-date').value, departureTime: document.getElementById('transport-departure-time').value, arrivalDate: document.getElementById('transport-arrival-date').value, arrivalTime: document.getElementById('transport-arrival-time').value,
                    cost: document.getElementById('transport-cost').value,
                };
            } else if (category === 'lodging') {
                newItem = { 
                    name: document.getElementById('lodging-name').value, address: document.getElementById('lodging-address').value, checkinDate: document.getElementById('lodging-checkin-date').value, checkinTime: document.getElementById('lodging-checkin-time').value, checkoutDate: document.getElementById('lodging-checkout-date').value, checkoutTime: document.getElementById('lodging-checkout-time').value,
                    cost: document.getElementById('lodging-cost').value,
                    link: document.getElementById('lodging-link').value.trim()
                };
            }

            // A nova forma de salvar:
            // 1. Criamos uma referência para a categoria específica (ex: .../trips/ID_VIAGEM/flights)
            const categoryRef = ref(db, `trips/${currentTripId}/${category}`);
            // 2. Usamos push() para que o Firebase crie um ID único para o novo item
            const newItemRef = push(categoryRef);
            // 3. Salvamos o novo item nesse local único
            await set(newItemRef, newItem);

            // O código para fechar o modal continua o mesmo
            let modalIdToClose = category === 'flights' ? 'add-flight-modal' : (category === 'transport' ? 'add-transport-modal' : 'add-lodging-modal');
            if (modalIdToClose) closeModal(modalIdToClose);
        }
        
        window.deleteTrip = async (event, tripId) => {
            event.stopPropagation();
            showConfirmDelete('Tem certeza que deseja excluir esta viagem?', async () => {
                const tripToDeleteRef = ref(db, `trips/${tripId}`);
                await remove(tripToDeleteRef);
                closeModal('confirm-delete-modal');
            });
        }
        
        window.duplicateTrip = async (event, tripId) => {
            event.stopPropagation();

            const originalTrip = tripsData.find(t => t.id === tripId);
            if (!originalTrip) {
                console.error("Viagem não encontrada para duplicação");
                return;
            }

            const newTrip = JSON.parse(JSON.stringify(originalTrip));

            delete newTrip.id;

            newTrip.name = `${originalTrip.name} (Cópia)`;
            newTrip.featured = false;

            if (newTrip.activities) {
                const activitiesArray = Array.isArray(newTrip.activities) 
                    ? newTrip.activities 
                    : Object.values(newTrip.activities);
                activitiesArray.forEach((activity, index) => {
                    activity.id = `${Date.now()}-${index}`;
                });
                newTrip.activities = activitiesArray;
            }

            if (newTrip.documents) {
                 newTrip.documents.forEach((doc, index) => {
                    doc.id = `${Date.now()}-${index}`;
                });
            }

            try {
                const newTripRef = push(tripsRef);
                await set(newTripRef, newTrip);
            } catch (error) {
                console.error("Falha ao duplicar a viagem:", error);
            }
        };

        window.deleteDetailItem = async (category, itemId) => {
            if (!currentTripId) return;
            showConfirmDelete(`Tem certeza que deseja excluir o item?`, async () => {
                const itemRef = ref(db, `trips/${currentTripId}/${category}/${itemId}`);
                await remove(itemRef);
                closeModal('confirm-delete-modal');
            });
        }
        
        window.reorderDetailItem = async (category, itemId, direction) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            // Converte o objeto de itens em um array de [id, dados]
            const items = trip[category] ? Object.entries(trip[category]) : [];

            const currentIndex = items.findIndex(([id, data]) => id === itemId);
            if (currentIndex === -1) return;

            const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (newIndex < 0 || newIndex >= items.length) return;

            // Reordena o array trocando as posições
            [items[currentIndex], items[newIndex]] = [items[newIndex], items[currentIndex]];

            // Converte o array de volta para um objeto que o Firebase entende
            const reorderedItemsObject = Object.fromEntries(items);

            // Salva o objeto inteiro com a nova ordem
            const updates = {};
            updates[`/${currentTripId}/${category}`] = reorderedItemsObject;
            await update(ref(db, 'trips'), updates);
        };
        
        window.openAddActivityModal = (date) => {
            document.getElementById('activity-date').value = date;
            const picker = document.getElementById('add-icon-picker');
            const hiddenInput = document.getElementById('activity-icon');
            hiddenInput.value = 'passeio'; 
            picker.querySelectorAll('.icon-picker-option').forEach(opt => opt.classList.remove('selected'));
            picker.querySelector('[data-icon="passeio"]').classList.add('selected');
            openModal('add-activity-modal');
        };

        window.deleteActivity = (activityId) => {
            event.stopPropagation();
            showConfirmDelete('Tem certeza que deseja excluir esta atividade?', async () => {
                const trip = tripsData.find(t => t.id === currentTripId);
                const currentActivities = trip.activities ? Object.values(trip.activities) : [];
                const updatedActivities = currentActivities.filter(a => a.id !== activityId);
                const updates = { [`/${currentTripId}/activities`]: updatedActivities };
                await update(ref(db, 'trips'), updates);
                closeModal('confirm-delete-modal');
            });
        };

        // NOVO: Função para excluir anotação
        window.deleteNote = async (noteId) => {
            showConfirmDelete('Tem certeza que deseja excluir esta anotação?', async () => {
                const trip = tripsData.find(t => t.id === currentTripId);
                if (!trip || !trip.notes) return;
                const updatedNotes = trip.notes.filter(n => n.id !== noteId);
                const updates = { [`/${currentTripId}/notes`]: updatedNotes };
                await update(ref(db, 'trips'), updates);
                closeModal('confirm-delete-modal');
            });
        };

        window.deleteDocument = async (docId) => {
             showConfirmDelete('Tem certeza que deseja excluir este documento?', async () => {
                const trip = tripsData.find(t => t.id === currentTripId);
                if (!trip || !trip.documents) return;
                const updatedDocuments = trip.documents.filter(d => d.id !== docId);
                const updates = { [`/${currentTripId}/documents`]: updatedDocuments };
                await update(ref(db, 'trips'), updates);
                closeModal('confirm-delete-modal');
            });
        };
        
        window.reorderDocument = async (docId, direction) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            const documents = trip.documents ? [...trip.documents] : [];
            const index = documents.findIndex(d => d.id === docId);

            if (index === -1) return; 

            const newIndex = direction === 'up' ? index - 1 : index + 1;

            if (newIndex < 0 || newIndex >= documents.length) return;

            [documents[index], documents[newIndex]] = [documents[newIndex], documents[index]];

            const updates = { [`/${currentTripId}/documents`]: documents };
            await update(ref(db, 'trips'), updates);
        };

	
	window.reorderNote = async (noteId, direction) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            const notes = trip.notes ? [...trip.notes] : [];
            const index = notes.findIndex(n => n.id === noteId);

            if (index === -1) return; 

            const newIndex = direction === 'up' ? index - 1 : index + 1;

            if (newIndex < 0 || newIndex >= notes.length) return;

            // Troca os elementos de posição no array
            [notes[index], notes[newIndex]] = [notes[newIndex], notes[index]];

            const updates = { [`/${currentTripId}/notes`]: notes };
            await update(ref(db, 'trips'), updates);
        };

        window.toggleFeatured = async (event, tripId) => {
            event.stopPropagation();
            const trip = tripsData.find(t => t.id === tripId);
            if (!trip) return;
            const newFeaturedStatus = !trip.featured;
            const updates = { [`/${tripId}/featured`]: newFeaturedStatus };
            await update(ref(db, 'trips'), updates);
        }

        function fullLogout() {
            console.log("Iniciando logout completo...");

            // 1. Desconecta todos os listeners ativos do Firebase
            Object.keys(activeTripListeners).forEach(tripId => {
                const { unsubscribe } = activeTripListeners[tripId];
                unsubscribe(); // Executa a função para parar de "ouvir" cada viagem
            });
            console.log("Todos os listeners de viagens foram desconectados.");

            // 2. Limpa todas as variáveis de estado para seus valores iniciais
            tripsData = [];
            activeTripListeners = {};
            currentTripId = null;
            // A variável 'currentUserId' já é limpa pelo onAuthStateChanged, mas podemos garantir aqui também
            currentUserId = null; 

            // 3. Esvazia a interface gráfica para evitar mostrar dados antigos rapidamente
            document.getElementById('upcoming-trips-list').innerHTML = '';
            document.getElementById('past-trips-list').innerHTML = '';
            document.getElementById('featured-trips-panel').innerHTML = '';

            // 4. Finalmente, desloga o usuário do Firebase
            signOut(auth).catch(error => console.error("Erro ao sair:", error));
            console.log("Logout do Firebase concluído.");
        }

        // --- SEÇÃO ATUALIZADA: LÓGICA DE REORGANIZAÇÃO DO ROTEIRO COM DUPLO MODO ---
        
        async function updateActivityOrderAndDate() {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            const allActivityElements = document.querySelectorAll('.activity-item[data-activity-id]');
            let allCurrentActivities = trip.activities ? JSON.parse(JSON.stringify(Object.values(trip.activities))) : [];
            let updatedActivities = [];

            allActivityElements.forEach(el => {
                const activityId = el.dataset.activityId;
                const newDate = el.closest('.activity-list').dataset.date;
                const activityData = allCurrentActivities.find(a => a.id === activityId);
                if (activityData) {
                    activityData.date = newDate;
                    updatedActivities.push(activityData);
                }
            });

            allCurrentActivities.forEach(act => {
                if (!updatedActivities.find(a => a.id === act.id)) { updatedActivities.push(act); }
            });

            const updates = { [`/${currentTripId}/activities`]: updatedActivities };
            await update(ref(db, 'trips'), updates);
        }

        function initializeActivitySorting() {
            sortableInstances.forEach(instance => instance.destroy());
            sortableInstances = [];

            // NOVO: Adiciona um delay mínimo para o navegador processar as mudanças de CSS
            setTimeout(() => {
                const activityLists = document.querySelectorAll('.activity-list');
                
                activityLists.forEach(list => {
                    const instance = new Sortable(list, {
                        group: 'shared-activities',
                        animation: 150,
                        handle: '.activity-drag-handle',
                        draggable: '.activity-item[data-iseditable="true"]',
                        onEnd: (evt) => updateActivityOrderAndDate(),
                    });
                    sortableInstances.push(instance);
                });
            }, 50); // Um delay de 50 milissegundos é suficiente e imperceptível
        }

        async function remapAndSaveDays(tripId, daysArray) {
            const trip = tripsData.find(t => t.id === tripId);
            let currentDate = new Date(trip.startDate + 'T00:00:00Z');
            const newActivities = [];
            
            daysArray.forEach(dayObj => {
                const isoDate = currentDate.toISOString().split('T')[0];
                dayObj.activities.forEach(act => {
                    act.date = isoDate;
                    newActivities.push(act);
                });
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            });
            
            const newEndDate = new Date(currentDate);
            newEndDate.setUTCDate(newEndDate.getUTCDate() - 1);
            
            const updates = {
                [`/${tripId}/activities`]: newActivities,
                [`/${tripId}/endDate`]: newEndDate.toISOString().split('T')[0]
            };
            
            await update(ref(db, 'trips'), updates);
        }
        
        function getDaysArray(trip) {
            const allActivities = trip.activities ? Object.values(trip.activities) : [];
            const groupedByDay = allActivities.reduce((acc, act) => {
                const date = act.date;
                if (!acc[date]) acc[date] = [];
                acc[date].push(act);
                return acc;
            }, {});

            let daysArray = [];
            if (trip.startDate && trip.endDate) {
                let currentDate = new Date(trip.startDate + 'T00:00:00Z');
                const endDate = new Date(trip.endDate + 'T00:00:00Z');
                while(currentDate <= endDate) {
                    const dayKey = currentDate.toISOString().split('T')[0];
                    daysArray.push({
                        date: dayKey,
                        activities: groupedByDay[dayKey] || []
                    });
                    currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                }
            }
            return daysArray;
        }
        
        window.reorganizeItinerary = async (oldIndex, newIndex) => {
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;
            let daysArray = getDaysArray(trip);
            const [movedItem] = daysArray.splice(oldIndex, 1);
            daysArray.splice(newIndex, 0, movedItem);
            await remapAndSaveDays(currentTripId, daysArray);
        };

        function initializeDaySorting() {
            if (sortableInstance) sortableInstance.destroy();
            const list = document.getElementById('daily-itinerary-list');
            
            sortableInstance = new Sortable(list, {
                animation: 150, handle: '.drag-handle', draggable: '.day-panel',
                onEnd: (evt) => {
                    if (evt.oldDraggableIndex !== evt.newDraggableIndex) {
                        reorganizeItinerary(evt.oldDraggableIndex, evt.newDraggableIndex);
                    }
                },
            });
        }
        
        window.switchReorganizationType = (type) => {
            reorganizationMode = type;
            const list = document.getElementById('daily-itinerary-list');
            const daysBtn = document.getElementById('reorg-mode-days-btn');
            const activitiesBtn = document.getElementById('reorg-mode-activities-btn');

            if (sortableInstance) sortableInstance.destroy();
            sortableInstances.forEach(i => i.destroy());
            sortableInstance = null;
            sortableInstances = [];

            if (type === 'days') {
                list.classList.remove('mode-activities');
                list.classList.add('mode-days');
                daysBtn.classList.add('active');
                activitiesBtn.classList.remove('active');
                initializeDaySorting();
            } else {
                list.classList.remove('mode-days');
                list.classList.add('mode-activities');
                activitiesBtn.classList.add('active');
                daysBtn.classList.remove('active');
                initializeActivitySorting();
            }
        }

        window.toggleReorganizationMode = (isCancelling) => {
            const list = document.getElementById('daily-itinerary-list');
            const startBtn = document.getElementById('reorg-start-btn');
            const actionsContainer = document.getElementById('reorg-actions-container');
            const scrollTopBtn = document.getElementById('back-to-top-btn');

            isReorganizing = !list.classList.contains('is-reorganizing');
            list.classList.toggle('is-reorganizing', isReorganizing);

            if (isReorganizing) {
                // Entrando no modo de reordenação
                const trip = tripsData.find(t => t.id === currentTripId);
                initialTripState = {
                    activities: trip.activities ? JSON.parse(JSON.stringify(trip.activities)) : {},
                    endDate: trip.endDate
                };
                
                // --- CORREÇÃO AQUI ---
                startBtn.classList.add('hidden');
                actionsContainer.classList.remove('hidden'); // Remove a classe 'hidden' para mostrar
                
                if (scrollTopBtn) {
                    scrollTopBtn.style.display = 'none';
                }

                document.getElementById('reorg-mode-activities-btn').click();

            } else { 
                // Saindo do modo de reordenação
                if (isCancelling && initialTripState) {
                    const updates = {
                        [`/${currentTripId}/activities`]: initialTripState.activities,
                        [`/${currentTripId}/endDate`]: initialTripState.endDate
                    };
                    // Corrigindo para a referência correta do banco de dados
                    update(ref(db, 'trips'), updates);
                }
                initialTripState = null;
                
                // --- CORREÇÃO AQUI ---
                startBtn.classList.remove('hidden');
                actionsContainer.classList.add('hidden'); // Adiciona a classe 'hidden' para esconder
                
                if (scrollTopBtn) {
                    scrollTopBtn.style.display = '';
                }

                list.classList.remove('mode-days', 'mode-activities');
                if (sortableInstance) sortableInstance.destroy();
                sortableInstances.forEach(i => i.destroy());
                sortableInstance = null;
                sortableInstances = [];
            }
        };

        window.insertNewDay = async (index) => {
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            let daysArray = getDaysArray(trip);
            daysArray.splice(index, 0, { date: 'new', activities: [] });

            await remapAndSaveDays(currentTripId, daysArray);
        };
        
        window.deleteDay = async (dayKey) => {
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            let daysArray = getDaysArray(trip);
            if (daysArray.length <= 1) {
                alert("Não é possível excluir o único dia da viagem.");
                return;
            }

            showConfirmDelete(`Tem certeza que deseja excluir o dia ${formatDate(dayKey, {weekday: 'long', day: 'numeric', month: 'long'})} e todas as suas atividades?`, async () => {
                let daysArray = getDaysArray(trip);
                const dayIndex = daysArray.findIndex(day => day.date === dayKey);
                
                if (dayIndex > -1) {
                    daysArray.splice(dayIndex, 1);
                    await remapAndSaveDays(currentTripId, daysArray);
                }
                closeModal('confirm-delete-modal');
            });
        };

window.saveDivider = async function(tripId, categoryKey, value) {
            // Define o caminho no banco de dados onde o divisor será salvo
            // Ex: public_trips/-Mabc123/dividers/Hospedagens
            const dbPath = `trips/${tripId}/dividers/${categoryKey}`;
            const dividerRef = ref(db, dbPath);

            const divider = parseInt(value);

            if (divider && divider > 0) {
                // Se o valor for um número válido, salva no Firebase
                await set(dividerRef, divider);
            } else {
                // Se o campo for limpo ou inválido, remove o dado do Firebase
                await remove(dividerRef);
            }
        };

        // --- LÓGICA DO MENU DO USUÁRIO ---
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');

        userMenuBtn.addEventListener('click', () => {
            userMenuDropdown.classList.toggle('hidden');
        });

        // Fecha o menu se clicar fora dele
        window.addEventListener('click', (e) => {
            if (!document.getElementById('user-menu-container').contains(e.target)) {
                userMenuDropdown.classList.add('hidden');
            }
        });

        // Ação para abrir o modal de edição de perfil
        document.getElementById('edit-profile-btn').addEventListener('click', (e) => {
            e.preventDefault();
            openEditProfileModal();
            userMenuDropdown.classList.add('hidden');
        });

        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            userMenuDropdown.classList.add('hidden');
            fullLogout();
        });

        // Abre o modal e preenche com os dados atuais do usuário (VERSÃO CORRIGIDA)
        function openEditProfileModal() {
            const user = auth.currentUser;
            if (!user) return;

            const userProfileRef = ref(db, `users/${user.uid}/profile`);
            onValue(userProfileRef, (snapshot) => {
                const profile = snapshot.val() || {}; // Se não houver perfil, cria um objeto vazio

                // Preenche o formulário com os dados existentes ou com strings vazias
                document.getElementById('profile-fullname').value = profile.fullName || '';
                document.getElementById('profile-birthdate').value = profile.birthDate || '';
                document.getElementById('profile-cpf').value = profile.cpf || '';
                document.getElementById('profile-passport').value = profile.passport || '';
                document.getElementById('profile-country').value = profile.country || '';
                document.getElementById('profile-city').value = profile.city || '';
                document.getElementById('profile-phone').value = profile.phone || '';

                // Abre o modal DEPOIS de preencher
                openModal('edit-profile-modal');

            }, { onlyOnce: true }); // Aqui mantemos onlyOnce: true, pois só queremos carregar os dados ao abrir.
        }

        // Salva as alterações do perfil no banco de dados
        document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const updatedProfileData = {
                fullName: document.getElementById('profile-fullname').value,
                birthDate: document.getElementById('profile-birthdate').value,
                cpf: document.getElementById('profile-cpf').value,
                passport: document.getElementById('profile-passport').value,
                country: document.getElementById('profile-country').value,
                city: document.getElementById('profile-city').value,
                phone: document.getElementById('profile-phone').value,
            };

            const userProfileRef = ref(db, `users/${user.uid}/profile`);
            try {
                await set(userProfileRef, updatedProfileData);
                alert('Dados atualizados com sucesso!');
                closeModal('edit-profile-modal');
                // Atualiza o nome no botão do menu
                document.getElementById('user-menu-name').textContent = updatedProfileData.fullName.split(' ')[0];
            } catch (error) {
                console.error("Erro ao atualizar perfil:", error);
                alert('Falha ao atualizar os dados.');
            }
        });
        
        // --- LISTENERS DOS FORMULÁRIOS ---
        document.getElementById('add-trip-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const userProfileRef = ref(db, `users/${user.uid}/profile`);
            const profileSnapshot = await get(userProfileRef);
            const userProfile = profileSnapshot.val();

            if (!userProfile || !userProfile.fullName) {
                alert("Erro: Não foi possível encontrar seu nome no perfil. Tente novamente.");
                return;
            }

            const tripName = document.getElementById('trip-name').value;
            const newTripRef = push(ref(db, 'trips'));
            const newTripId = newTripRef.key;

            const newTripData = {
                name: tripName,
                destination: document.getElementById('trip-destination').value,
                startDate: document.getElementById('trip-start-date').value,
                endDate: document.getElementById('trip-end-date').value,
                imageUrl: `https://placehold.co/600x400/a3e635/1e293b?text=${encodeURIComponent(tripName)}`,
                featured: false,
                members: { [user.uid]: "owner" },
                travelers: [{ uid: user.uid, name: userProfile.fullName, email: user.email }]
            };

            try {
                // Operação 1: Salva os dados da viagem em /trips/{idDaViagem}
                await set(newTripRef, newTripData);
                // Operação 2: Salva a referência no perfil do usuário
                await set(ref(db, `users/${user.uid}/memberOf/${newTripId}`), true);
                
                closeModal('add-trip-modal');
            } catch (error) {
                console.error("Erro ao criar viagem:", error);
                alert("Ocorreu um erro ao criar a viagem. Verifique as permissões do banco de dados.");
            }
        });

        document.getElementById('add-document-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentTripId) return;

            const input = document.getElementById('document-name');
            const docName = input.value.trim();
            if (!docName) return;

            const trip = tripsData.find(t => t.id === currentTripId);
            const currentDocuments = trip.documents || [];
            
            const newDocument = {
                id: Date.now().toString(),
                name: docName,
            };

            const updatedDocuments = [...currentDocuments, newDocument];
            const updates = { [`/${currentTripId}/documents`]: updatedDocuments };
            await update(ref(db, 'trips'), updates);

            input.value = '';
        });

        document.getElementById('add-flight-form').addEventListener('submit', (e) => { e.preventDefault(); addDetail('flights'); });
        document.getElementById('add-transport-form').addEventListener('submit', (e) => { e.preventDefault(); addDetail('transport'); });
        document.getElementById('add-lodging-form').addEventListener('submit', (e) => { e.preventDefault(); addDetail('lodging'); });

        // VERSÃO NOVA - USE ESTA
        document.getElementById('edit-trip-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentTripId) return;
            const updates = {
                name: document.getElementById('edit-trip-name').value,
                destination: document.getElementById('edit-trip-destination').value,
                startDate: document.getElementById('edit-trip-start-date').value,
                endDate: document.getElementById('edit-trip-end-date').value,
                imageUrl: document.getElementById('edit-trip-image-url').value,
                customLinkText: document.getElementById('edit-trip-link-text').value.trim(),
                customLinkUrl: document.getElementById('edit-trip-link-url').value.trim(),
            };
            const tripToUpdateRef = ref(db, `trips/${currentTripId}`);
            await update(tripToUpdateRef, updates);

            // --- INÍCIO DAS NOVAS LINHAS ---

            // 1. Atualiza os dados na variável local para refletir a mudança instantaneamente.
            const tripIndex = tripsData.findIndex(t => t.id === currentTripId);
            if (tripIndex > -1) tripsData[tripIndex] = { ...tripsData[tripIndex], ...updates };

            // 2. Força o redesenho da tela de detalhes (que está visível).
            renderTripDetails(currentTripId);

            // 3. Força o redesenho da lista de viagens (que está escondida) para que o card esteja atualizado quando você voltar.
            renderTripLists();

            // --- FIM DAS NOVAS LINHAS ---

            closeModal('edit-trip-modal');
        });

        document.getElementById('edit-flight-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentTripId || !currentEditingItemId) return;
            const updatedFlight = {
                legType: document.getElementById('edit-flight-leg-type').value, date: document.getElementById('edit-flight-date').value, departureTime: document.getElementById('edit-flight-departure-time').value, arrivalTime: document.getElementById('edit-flight-arrival-time').value, origin: document.getElementById('edit-flight-origin').value, destination: document.getElementById('edit-flight-destination').value, company: document.getElementById('edit-flight-company').value, code: document.getElementById('edit-flight-code').value, flightType: document.getElementById('edit-flight-type').value,
                cost: document.getElementById('edit-flight-cost').value,
            };
            const itemRef = ref(db, `trips/${currentTripId}/flights/${currentEditingItemId}`);
            await update(itemRef, updatedFlight);
            closeModal('edit-flight-modal');
            currentEditingItemId = null;
        });

        document.getElementById('edit-transport-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentTripId || !currentEditingItemId) return;
            const updatedTransport = {
                type: document.getElementById('edit-transport-type').value, from: document.getElementById('edit-transport-origin').value, to: document.getElementById('edit-transport-destination').value, description: document.getElementById('edit-transport-description').value, departureDate: document.getElementById('edit-transport-departure-date').value, departureTime: document.getElementById('edit-transport-departure-time').value, arrivalDate: document.getElementById('edit-transport-arrival-date').value, arrivalTime: document.getElementById('edit-transport-arrival-time').value,
                cost: document.getElementById('edit-transport-cost').value,
            };
            const itemRef = ref(db, `trips/${currentTripId}/transport/${currentEditingItemId}`);
            await update(itemRef, updatedTransport);
            closeModal('edit-transport-modal');
            currentEditingItemId = null;
        });
        
        document.getElementById('edit-lodging-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentTripId || !currentEditingItemId) return;
            const updatedLodging = {
                name: document.getElementById('edit-lodging-name').value, address: document.getElementById('edit-lodging-address').value, checkinDate: document.getElementById('edit-lodging-checkin-date').value, checkinTime: document.getElementById('edit-lodging-checkin-time').value, checkoutDate: document.getElementById('edit-lodging-checkout-date').value, checkoutTime: document.getElementById('edit-lodging-checkout-time').value,
                cost: document.getElementById('edit-lodging-cost').value,
                link: document.getElementById('edit-lodging-link').value.trim()
            };
            const itemRef = ref(db, `trips/${currentTripId}/lodging/${currentEditingItemId}`);
            await update(itemRef, updatedLodging);
            closeModal('edit-lodging-modal');
            currentEditingItemId = null;
        });

        document.getElementById('add-activity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const trip = tripsData.find(t => t.id === currentTripId);
            const newActivity = {
                id: Date.now().toString(),
                date: document.getElementById('activity-date').value,
                time: document.getElementById('activity-time').value,
                name: document.getElementById('activity-name').value,
                type: document.getElementById('activity-type').value,
                description: document.getElementById('activity-description').value,
                icon: document.getElementById('activity-icon').value,
                link: document.getElementById('activity-link').value.trim(),
                cost: document.getElementById('activity-cost').value,
            };
            const currentActivities = trip.activities ? [...Object.values(trip.activities)] : [];
            currentActivities.push(newActivity);
            const updates = { [`/${currentTripId}/activities`]: currentActivities };
            await update(ref(db, 'trips'), updates);
            closeModal('add-activity-modal');
        });

        document.getElementById('edit-activity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const trip = tripsData.find(t => t.id === currentTripId);
            const activityId = document.getElementById('edit-activity-id').value;
            const currentActivities = trip.activities ? Object.values(trip.activities) : [];
            const activityIndex = currentActivities.findIndex(a => a.id === activityId);
            
            if (activityIndex > -1) {
                currentActivities[activityIndex] = {
                    ...currentActivities[activityIndex],
                    time: document.getElementById('edit-activity-time').value,
                    name: document.getElementById('edit-activity-name').value,
                    type: document.getElementById('edit-activity-type').value,
                    description: document.getElementById('edit-activity-description').value,
                    icon: document.getElementById('edit-activity-icon').value,
                    link: document.getElementById('edit-activity-link').value.trim(),
cost: document.getElementById('edit-activity-cost').value,
                };
                const updates = { [`/${currentTripId}/activities`]: currentActivities };
                await update(ref(db, 'trips'), updates);
            }
            closeModal('edit-activity-modal');
        });

        document.getElementById('add-note-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            const newNote = {
                id: Date.now().toString(),
                title: document.getElementById('note-title').value,
                author: currentUserProfile.fullName || 'Usuário',
                description: document.getElementById('note-description').value,
                link: document.getElementById('note-link').value.trim(),
                icon: document.getElementById('note-icon').value,
            };

            const currentNotes = trip.notes || [];
            currentNotes.push(newNote);

            // --- CORREÇÃO AQUI ---
            // Removemos a barra "/" do início do caminho.
            // O caminho agora é relativo ao ref('trips'), que é o correto.
            const updates = { [`${currentTripId}/notes`]: currentNotes };
            
            await update(ref(db, 'trips'), updates);
            
            closeModal('add-note-modal');
        });

        document.getElementById('edit-note-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const trip = tripsData.find(t => t.id === currentTripId);
            const noteId = document.getElementById('edit-note-id').value;
            if (!trip || !trip.notes) return;

            const noteIndex = trip.notes.findIndex(n => n.id === noteId);
            if (noteIndex > -1) {
                trip.notes[noteIndex] = {
                    ...trip.notes[noteIndex],
                    title: document.getElementById('edit-note-title').value,
                    
                    // A LINHA ABAIXO FOI REMOVIDA
                    // author: document.getElementById('edit-note-author').value,
                    
                    description: document.getElementById('edit-note-description').value,
                    link: document.getElementById('edit-note-link').value.trim(),
                    icon: document.getElementById('edit-note-icon').value,
                };
                const updates = { [`/${currentTripId}/notes`]: trip.notes };
                await update(ref(db, 'trips'), updates);
            }
            closeModal('edit-note-modal');
        });

        // ... (depois do listener do 'edit-note-form')

        document.getElementById('add-expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const payerName = document.getElementById('expense-payer').value;

            const participants = [];
            document.querySelectorAll('#expense-participants-checkboxes input[type="checkbox"]:checked').forEach(checkbox => {
                participants.push(checkbox.value);
            });

            if (!description || !amount || !payerName || participants.length === 0) {
                alert('Por favor, preencha todos os campos e selecione ao menos um responsável.');
                return;
            }

            const currencySelect = document.getElementById('expense-currency');
                let currency = currencySelect.value;
                if (currency === 'custom') {
                    currency = document.getElementById('expense-currency-custom').value.toUpperCase().trim() || 'CUSTOM';
                }

                const newExpense = {
                    id: Date.now().toString(),
                    description,
                    amount,
                    currency, // <-- CAMPO NOVO
                    payerName,
                    participants
                };

            const currentExpenses = trip.sharedExpenses || [];
            currentExpenses.push(newExpense);
            const updates = { [`/${currentTripId}/sharedExpenses`]: currentExpenses };
            await update(ref(db, 'trips'), updates);

            e.target.reset(); // Limpa o formulário

            const selectAllCheckbox = document.getElementById('select-all-participants');
            selectAllCheckbox.checked = true;
            selectAllCheckbox.dispatchEvent(new Event('change'));
        });


        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (typeof onConfirmAction === 'function') {
                onConfirmAction();
            }
        });

// Lógica para os botões flutuantes (Voltar ao Topo e Índice)
        const backToTopBtn = document.getElementById('back-to-top-btn');
        const openIndexBtn = document.getElementById('open-index-btn');
        const detailsView = document.getElementById('details-view');

        window.addEventListener('scroll', () => {
            const isDetailsViewVisible = !detailsView.classList.contains('hidden');
            
            // Mostra os botões após rolar 300 pixels E se a tela de detalhes estiver visível
            if (window.scrollY > 300 && isDetailsViewVisible) { 
                backToTopBtn.classList.remove('hidden');
                openIndexBtn.classList.remove('hidden');
            } else { // Esconde os botões em outras situações
                backToTopBtn.classList.add('hidden');
                openIndexBtn.classList.add('hidden');
            }
        });

        window.showExpenseExplanation = () => {
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            const travelers = trip.travelers || [];
            const expenses = trip.sharedExpenses || [];
            const contentContainer = document.getElementById('expense-explanation-content');
            contentContainer.innerHTML = '';

            if (travelers.length === 0 || expenses.length === 0) {
                contentContainer.innerHTML = '<p class="text-center text-slate-600">Não há viajantes ou despesas suficientes para gerar a explicação.</p>';
                openModal('expense-explanation-modal');
                return;
            }

            // 1. Agrupa as despesas por moeda
            const expensesByCurrency = expenses.reduce((acc, expense) => {
                const currency = expense.currency || 'BRL';
                if (!acc[currency]) {
                    acc[currency] = [];
                }
                acc[currency].push(expense);
                return acc;
            }, {});

            const sortedCurrencies = Object.keys(expensesByCurrency).sort((a, b) => a === 'BRL' ? -1 : b === 'BRL' ? 1 : a.localeCompare(b));
            let finalHtml = '';

            // 2. Itera sobre cada moeda
            sortedCurrencies.forEach(currency => {
                finalHtml += `<div class="mb-6"><h4 class="text-xl font-bold text-slate-800 bg-slate-100 px-3 py-2 rounded-md mb-3 sticky top-0">${currency}</h4>`;
                const currencyExpenses = expensesByCurrency[currency];
                
                // 3. Calcula totais para cada viajante DENTRO da moeda atual
                const travelerDetails = {};
                travelers.forEach(t => {
                    travelerDetails[t.name] = {
                        totalPaid: 0,
                        totalOwed: 0,
                        expensesPaidList: []
                    };
                });

                currencyExpenses.forEach(expense => {
                    // Adiciona ao total PAGO pelo credor
                    if (travelerDetails[expense.payerName]) {
                        travelerDetails[expense.payerName].totalPaid += expense.amount;
                        travelerDetails[expense.payerName].expensesPaidList.push({
                            description: expense.description,
                            amount: expense.amount
                        });
                    }

                    // Adiciona à cota-parte (total DEVIDO) de cada participante
                    const share = expense.amount / expense.participants.length;
                    expense.participants.forEach(participantName => {
                        if (travelerDetails[participantName]) {
                            travelerDetails[participantName].totalOwed += share;
                        }
                    });
                });

                // 4. Monta o HTML da explicação para cada viajante
                travelers.forEach(traveler => {
                    const details = travelerDetails[traveler.name];
                    const balance = details.totalPaid - details.totalOwed;

                    // Só mostra o viajante se ele pagou ou deveu algo nesta moeda
                    if (Math.abs(details.totalPaid) < 0.01 && Math.abs(details.totalOwed) < 0.01) {
                        return; 
                    }

                    let expensesListHtml = '';
                    if (details.expensesPaidList.length > 0) {
                        expensesListHtml = '<ul class="list-disc pl-5 text-sm text-slate-600 mt-1">';
                        details.expensesPaidList.forEach(exp => {
                            expensesListHtml += `<li>${exp.description}: ${formatCurrency(exp.amount, currency)}</li>`;
                        });
                        expensesListHtml += '</ul>';
                    } else {
                        expensesListHtml = '<p class="text-sm text-slate-500 mt-1">Nenhuma despesa paga nesta moeda.</p>';
                    }

                    let balanceHtml = '';
                    if (Math.abs(balance) < 0.01) {
                        balanceHtml = `<span class="font-semibold text-slate-700">está quite</span>.`;
                    } else if (balance > 0) {
                        balanceHtml = `<span class="font-semibold text-green-600">precisa receber um reembolso de ${formatCurrency(balance, currency)}</span>.`;
                    } else {
                        balanceHtml = `<span class="font-semibold text-red-600">precisa pagar ${formatCurrency(Math.abs(balance), currency)}</span>.`;
                    }

                    finalHtml += `
                        <div class="p-3 border-b border-slate-200 last:border-b-0">
                            <p class="text-base text-slate-800">
                                <strong class="font-bold">${traveler.name}</strong> pagou um total de <strong class="font-semibold">${formatCurrency(details.totalPaid, currency)}</strong>.
                            </p>
                            ${expensesListHtml}
                            <p class="text-base text-slate-800 mt-2">
                                Sua cota-parte total nessas despesas era de <strong class="font-semibold">${formatCurrency(details.totalOwed, currency)}</strong>, portanto, ${balanceHtml}
                            </p>
                        </div>
                    `;
                });
                
                finalHtml += `</div>`; // Fecha a div da moeda
            });

            contentContainer.innerHTML = finalHtml;
            openModal('expense-explanation-modal');
        };
        
        window.calculateExpenseSummary = () => {
            const trip = tripsData.find(t => t.id === currentTripId);
            const travelers = trip.travelers || [];
            const resultsContainer = document.getElementById('expense-summary-results');
            resultsContainer.innerHTML = '';

            const expensesByCurrency = (trip.sharedExpenses || []).reduce((acc, expense) => {
                const currency = expense.currency || 'BRL';
                if (!acc[currency]) acc[currency] = [];
                acc[currency].push(expense);
                return acc;
            }, {});
            
            const sortedCurrencies = Object.keys(expensesByCurrency).sort((a, b) => a === 'BRL' ? -1 : b === 'BRL' ? 1 : a.localeCompare(b));

            if (sortedCurrencies.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-slate-600">Nenhuma despesa de grupo foi adicionada para calcular o resumo.</p>';
                openModal('expense-summary-modal');
                return;
            }

            const paidSettlements = trip.paidSettlements || [];

            sortedCurrencies.forEach(currency => {
                const currencyExpenses = expensesByCurrency[currency];

                const balances = {};
                travelers.forEach(t => { balances[t.name] = 0; });

                currencyExpenses.forEach(expense => {
                    if (balances[expense.payerName] !== undefined) {
                        balances[expense.payerName] += expense.amount;
                    }
                    const share = expense.amount / expense.participants.length;
                    expense.participants.forEach(participantName => {
                        if (balances[participantName] !== undefined) {
                            balances[participantName] -= share;
                        }
                    });
                });

                const creditors = [];
                const debtors = [];
                Object.entries(balances).forEach(([name, balance]) => {
                    if (balance > 0.01) creditors.push({ name, amount: balance });
                    else if (balance < -0.01) debtors.push({ name, amount: -balance });
                });

                const transactions = [];
                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    const amountToTransfer = Math.min(debtors[i].amount, creditors[j].amount);
                    if (amountToTransfer > 0.01) {
                        transactions.push({ from: debtors[i].name, to: creditors[j].name, amount: amountToTransfer });
                    }
                    debtors[i].amount -= amountToTransfer;
                    creditors[j].amount -= amountToTransfer;
                    if (debtors[i].amount < 0.01) i++;
                    if (creditors[j].amount < 0.01) j++;
                }
                
                const currencyHeader = document.createElement('div');
                currencyHeader.innerHTML = `<h4 class="text-lg font-bold text-slate-800 bg-slate-100 px-3 py-2 rounded-md mt-4 first:mt-0">${currency}</h4>`;
                resultsContainer.appendChild(currencyHeader);

                if (transactions.length === 0) {
                    const noTransactionsEl = document.createElement('p');
                    noTransactionsEl.className = 'text-sm text-slate-500 p-2';
                    noTransactionsEl.textContent = 'Nenhum acerto de contas necessário para esta moeda.';
                    resultsContainer.appendChild(noTransactionsEl);
                } else {
                    transactions.forEach(t => {
                        const transactionId = `${t.from}_${t.to}_${currency}`;
                        const isPaid = paidSettlements.includes(transactionId);

                        const transactionEl = document.createElement('div');
                        transactionEl.className = `transaction-item flex items-center justify-between p-3 bg-slate-50 rounded-lg ${isPaid ? 'paid-transaction' : ''}`;
                        
                        transactionEl.innerHTML = `
                            <div class="flex items-center gap-3">
                                <input type="checkbox" onchange="toggleSettlementPaid(this, '${t.from}', '${t.to}', '${currency}')" 
                                       ${isPaid ? 'checked' : ''} 
                                       class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                                
                                <div class="flex items-center gap-3">
                                    <span class="font-bold text-slate-800">${t.from}</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                    <span class="font-bold text-slate-800">${t.to}</span>
                                </div>
                            </div>
                            <span class="text-lg font-bold text-indigo-600">${formatCurrency(t.amount, currency)}</span>
                        `;
                        resultsContainer.appendChild(transactionEl);
                    });
                }

                // --- INÍCIO DA NOVA LÓGICA DE RESUMO ---
                const summaryTotals = {};
                travelers.forEach(t => { summaryTotals[t.name] = 0; });

                transactions.forEach(t => {
                    summaryTotals[t.to] += t.amount;
                    summaryTotals[t.from] -= t.amount;
                });

                const summaryContainer = document.createElement('div');
                summaryContainer.className = 'mt-5 pt-4 border-t-2 border-slate-200';
                let hasSummaryContent = false;

                const summaryList = document.createElement('div');
                summaryList.className = 'space-y-1';

                Object.keys(summaryTotals).sort().forEach(name => {
                    const total = summaryTotals[name];
                    if (Math.abs(total) > 0.01) {
                        hasSummaryContent = true;
                        const summaryLine = document.createElement('div');
                        summaryLine.className = 'flex justify-between items-center text-sm p-1.5 bg-slate-100 rounded';

                        const actionText = total > 0 ? 'Receberá ao todo' : 'Pagará ao todo';
                        const textClass = total > 0 ? 'text-green-700' : 'text-red-700';

                        summaryLine.innerHTML = `
                            <span class="font-medium text-slate-700">${name}</span>
                            <span class="font-bold ${textClass}">
                                ${actionText}: ${formatCurrency(Math.abs(total), currency)}
                            </span>
                        `;
                        summaryList.appendChild(summaryLine);
                    }
                });

                if (hasSummaryContent) {
                    summaryContainer.innerHTML = '<h5 class="text-base font-semibold text-slate-800 mb-2">Resumo por Pessoa:</h5>';
                    summaryContainer.appendChild(summaryList);
                    resultsContainer.appendChild(summaryContainer);
                }
                // --- FIM DA NOVA LÓGICA DE RESUMO ---
            });

            openModal('expense-summary-modal');
        };

        // --- LISTENER PARA O CHECKBOX "MARCAR TODOS" ---
        document.getElementById('select-all-participants').addEventListener('change', function(e) {
            const isChecked = e.target.checked;
            document.querySelectorAll('#expense-participants-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        });       
        
        // --- INÍCIO: FUNÇÕES PARA TROCA DE SENHA ---

        window.openReauthModal = () => {
            closeModal('edit-profile-modal');
            openModal('reauth-modal');
        };

        document.getElementById('reauth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const user = auth.currentUser;

            if (!user || !currentPassword) {
                alert("Ocorreu um erro. Tente fazer login novamente.");
                return;
            }

            const credential = EmailAuthProvider.credential(user.email, currentPassword);

            try {
                await reauthenticateWithCredential(user, credential);
                // Sucesso! O usuário provou quem é.
                closeModal('reauth-modal');
                openModal('change-password-modal');
            } catch (error) {
                console.error("Erro de reautenticação:", error);
                alert("Senha incorreta. Por favor, tente novamente.");
            }
        });

        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;

            if (newPassword.length < 6) {
                alert("A nova senha deve ter no mínimo 6 caracteres.");
                return;
            }
            if (newPassword !== confirmPassword) {
                alert("As senhas não coincidem.");
                return;
            }

            const user = auth.currentUser;
            try {
                await updatePassword(user, newPassword);
                alert("Senha alterada com sucesso!");
                closeModal('change-password-modal');
            } catch (error) {
                console.error("Erro ao alterar senha:", error);
                alert("Ocorreu um erro ao tentar alterar a senha. Pode ser necessário fazer login novamente por segurança.");
            }
        });

        // --- FIM: FUNÇÕES PARA TROCA DE SENHA ---

    </script>

<button id="back-to-top-btn" onclick="scrollToTop()" class="hidden fixed bottom-8 left-8 z-40 w-12 h-12 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>
</button>

<button id="open-index-btn" onclick="openModal('index-modal')" class="hidden fixed bottom-8 left-24 z-40 w-12 h-12 bg-green-600 text-white rounded-full shadow-lg hover:bg-green-700 transition-colors flex items-center justify-center">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>
</button>
<button id="back-to-trips-btn" onclick="showTripsView()" class="hidden fixed top-8 left-8 z-40 w-12 h-12 bg-slate-600 text-white rounded-full shadow-lg hover:bg-slate-700 transition-colors flex items-center justify-center">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
</button>
<br>
<br>
</body>
</html>
